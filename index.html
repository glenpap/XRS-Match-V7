<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>X-Ray Star: Match to Stardom</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Barlow+Condensed:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Barlow Condensed',sans-serif;background:#000;color:#fff;overflow-x:hidden;min-height:100vh;-webkit-tap-highlight-color:transparent}
#bg-stage{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;background:linear-gradient(135deg,#1a0a0a 0%,#2a1a3a 50%,#1a0a2a 100%)}
.stage-lights{position:absolute;width:100%;height:100%;overflow:hidden}
.light-beam{position:absolute;width:250px;height:250px;border-radius:50%;filter:blur(80px);opacity:.4;animation:lf 8s ease-in-out infinite}
.light-beam:nth-child(1){background:radial-gradient(circle,#ff4500,transparent);top:-120px;left:10%}
.light-beam:nth-child(2){background:radial-gradient(circle,#ffd700,transparent);top:-120px;right:10%;animation-delay:2s}
.light-beam:nth-child(3){background:radial-gradient(circle,#dc143c,transparent);bottom:-120px;left:30%;animation-delay:4s}
.light-beam:nth-child(4){background:radial-gradient(circle,#ff1493,transparent);bottom:-120px;right:30%;animation-delay:6s}
@keyframes lf{0%,100%{transform:translateY(0) scale(1);opacity:.4}50%{transform:translateY(60px) scale(1.3);opacity:.6}}
.sparkles{position:absolute;width:100%;height:100%;pointer-events:none}
.sparkle{position:absolute;width:3px;height:3px;background:#ffd700;border-radius:50%;box-shadow:0 0 12px #ffd700;animation:sp 3s ease-in-out infinite}
@keyframes sp{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
#gc{position:relative;z-index:1;max-width:800px;margin:0 auto;padding:15px}
.screen{display:none;animation:fi .3s ease}.screen.active{display:block}
@keyframes fi{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.gt{font-family:'Archivo Black',sans-serif;font-size:clamp(2.2rem,8vw,3.8rem);text-align:center;background:linear-gradient(180deg,#fff 0%,#ffd700 50%,#ff8c00 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.5rem;letter-spacing:3px;filter:drop-shadow(0 4px 8px rgba(255,215,0,.5))}
.sub{text-align:center;font-size:1.4rem;margin-bottom:1.5rem;font-weight:700;color:#ffd700;text-shadow:0 0 20px rgba(255,215,0,.8);letter-spacing:2px}
.btn{background:linear-gradient(135deg,#dc143c,#8b0000);border:none;color:#fff;padding:16px 40px;font-size:1.1rem;font-weight:700;border-radius:8px;cursor:pointer;margin:8px;transition:all .2s;box-shadow:0 8px 0 #5a0000,0 10px 25px rgba(0,0,0,.6),inset 0 -2px 10px rgba(0,0,0,.4),inset 0 2px 5px rgba(255,255,255,.3);text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;position:relative;overflow:hidden;letter-spacing:1px}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);transition:left .5s}
.btn:hover::before{left:100%}
.btn:hover{transform:translateY(-2px);box-shadow:0 10px 0 #5a0000,0 12px 30px rgba(220,20,60,.6),inset 0 -2px 10px rgba(0,0,0,.4),inset 0 2px 5px rgba(255,255,255,.3)}
.btn:active{transform:translateY(6px);box-shadow:0 2px 0 #5a0000,0 4px 10px rgba(0,0,0,.4)}
.btn2{background:linear-gradient(135deg,#4a4a4a,#1a1a1a);box-shadow:0 8px 0 #0a0a0a,0 10px 25px rgba(0,0,0,.6),inset 0 -2px 10px rgba(0,0,0,.4),inset 0 2px 5px rgba(255,255,255,.2)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.bg{text-align:center;margin:15px 0}
.bs{padding:10px 20px;font-size:.9rem}
.bl{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:20px 0;padding:18px;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);border-radius:15px;border:2px solid rgba(255,215,0,.3)}
.bla{background:linear-gradient(135deg,rgba(139,0,0,.9),rgba(220,20,60,.9));color:#fff;text-decoration:none;padding:10px 20px;border-radius:8px;font-size:.9rem;font-weight:700;transition:all .2s;border:2px solid rgba(255,215,0,.5);box-shadow:0 4px 15px rgba(0,0,0,.4)}
.bla:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(255,215,0,.5);border-color:#ffd700}
.hud{display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.hi{background:linear-gradient(135deg,rgba(26,10,10,.9),rgba(42,26,58,.9));backdrop-filter:blur(15px);padding:10px 16px;border-radius:12px;border:3px solid rgba(255,69,0,.5);min-width:80px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.6)}
.hl{font-size:.7rem;opacity:.9;text-transform:uppercase;letter-spacing:1.5px;color:#ff8c00}
.hv{font-size:1.5rem;font-weight:900;color:#ffd700;margin-top:3px;text-shadow:0 0 15px rgba(255,215,0,1);font-family:'Archivo Black',sans-serif}
.pc{background:linear-gradient(135deg,rgba(26,10,10,.9),rgba(42,26,58,.9));backdrop-filter:blur(15px);padding:14px;border-radius:15px;margin-bottom:12px;border:3px solid rgba(255,69,0,.5)}
.pl{text-align:center;margin-bottom:8px;font-weight:700;font-size:1rem;color:#ff8c00}
.pbg{background:rgba(0,0,0,.6);height:30px;border-radius:20px;overflow:hidden;border:2px solid rgba(255,69,0,.4)}
.pb{background:linear-gradient(90deg,#dc143c,#ffd700,#dc143c);background-size:200% 100%;height:100%;transition:width .5s ease;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;animation:ps 2s linear infinite;box-shadow:0 0 20px rgba(255,215,0,.8)}
@keyframes ps{0%{background-position:0% 50%}100%{background-position:200% 50%}}
#gb{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;background:linear-gradient(135deg,rgba(26,10,10,.9),rgba(42,26,58,.9));backdrop-filter:blur(15px);padding:14px;border-radius:20px;margin:12px auto;max-width:500px;box-shadow:0 0 0 5px rgba(255,69,0,.4),0 20px 60px rgba(0,0,0,.8);border:3px solid rgba(255,69,0,.5)}
.t{aspect-ratio:1;background:linear-gradient(145deg,#2a2a2a,#1a1a1a);border-radius:12px;cursor:pointer;transition:all .15s cubic-bezier(.34,1.56,.64,1);box-shadow:0 5px 0 rgba(0,0,0,.4),0 7px 20px rgba(0,0,0,.5),inset 0 -3px 10px rgba(0,0,0,.3),inset 0 2px 5px rgba(255,255,255,.1);position:relative;display:flex;align-items:center;justify-content:center;user-select:none;overflow:visible;border:2px solid rgba(255,255,255,.1)}
.ts{width:82%;height:82%;filter:drop-shadow(0 3px 6px rgba(0,0,0,.5))}
.t:hover{transform:scale(1.1) rotate(2deg);z-index:10;box-shadow:0 8px 0 rgba(0,0,0,.5),0 12px 35px rgba(255,140,0,.7);border-color:rgba(255,140,0,.5)}
.t.sel{transform:scale(1.15) rotate(-2deg);box-shadow:0 0 0 4px #ffd700,0 10px 0 rgba(0,0,0,.5),0 14px 40px rgba(255,215,0,1);animation:sp2 .4s ease infinite;z-index:11;border-color:#ffd700}
@keyframes sp2{0%,100%{transform:scale(1.15) rotate(-2deg)}50%{transform:scale(1.2) rotate(-2deg)}}


/* ===== CLEAR HINT SYSTEM: arrow + highlight ===== */
.t.hint-from{box-shadow:0 0 0 4px #ffd700,0 0 25px rgba(255,215,0,.8)!important;z-index:15;animation:hintBounce 1s ease-in-out infinite;border-color:#ffd700!important}
.t.hint-to{box-shadow:0 0 0 4px #ff8c00,0 0 20px rgba(255,140,0,.6)!important;z-index:14;animation:hintBounce 1s ease-in-out infinite .15s;border-color:#ff8c00!important}
@keyframes hintBounce{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.hint-arrow{position:fixed;font-size:2rem;z-index:20;pointer-events:none;color:#ffd700;filter:drop-shadow(0 2px 8px rgba(0,0,0,.8)) drop-shadow(0 0 10px rgba(255,215,0,.6));animation:hintArrowPulse 1s ease-in-out infinite}
@keyframes hintArrowPulse{0%,100%{opacity:1;transform:translate(-50%,-50%) scale(1)}50%{opacity:.7;transform:translate(-50%,-50%) scale(1.2)}}

.t.mtch{animation:mp .3s ease forwards}
@keyframes mp{0%{transform:scale(1);opacity:1}40%{transform:scale(1.3) rotate(120deg);opacity:1}100%{transform:scale(0) rotate(360deg);opacity:0}}
.t.fall{animation:tf .35s cubic-bezier(.34,1.56,.64,1)}
@keyframes tf{from{transform:translateY(-120px) rotate(-45deg);opacity:0}to{transform:translateY(0) rotate(0);opacity:1}}
.t.gem{background:linear-gradient(135deg,#ffd700,#ff4500,#ffd700)!important;background-size:200% 200%!important;animation:gp 1.5s ease-in-out infinite,gs 3s linear infinite;box-shadow:0 0 0 3px #ffd700,0 8px 0 rgba(0,0,0,.5),0 0 40px rgba(255,215,0,1),inset 0 0 30px rgba(255,255,255,.6);border-color:#ffd700!important}
@keyframes gp{0%,100%{filter:brightness(1.4)}50%{filter:brightness(1.8);transform:scale(1.05)}}
@keyframes gs{0%{background-position:0% 50%}100%{background-position:200% 50%}}
.t.gem::after{content:'\26A1';position:absolute;top:-10px;right:-10px;font-size:1.4rem;animation:ss 2s linear infinite;filter:drop-shadow(0 0 10px rgba(255,215,0,1));z-index:10}
@keyframes ss{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.t.xr{background:conic-gradient(from 0deg,#dc143c,#ffd700,#ff4500,#dc143c)!important;animation:xrr 3s linear infinite;box-shadow:0 0 0 4px #ffd700,0 10px 0 rgba(0,0,0,.5),0 0 60px rgba(255,215,0,1),inset 0 0 40px rgba(255,255,255,.6);border-color:#ffd700!important}
@keyframes xrr{from{filter:hue-rotate(0) brightness(1.5)}to{filter:hue-rotate(360deg) brightness(1.5)}}
.t.xr .ts{font-size:1.2rem;font-weight:900;color:#fff;text-shadow:0 0 15px #000,0 0 30px rgba(255,215,0,1)}
.t.or{background:linear-gradient(145deg,#5c3a1e,#3a2210)!important;border:3px solid #8B4513!important;cursor:default}
.t.oc{background:linear-gradient(145deg,#1a2a1a,#0a1a0a)!important;border:3px solid #2d5a2d!important;cursor:default}
.ohp{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:.7rem;font-weight:900;text-shadow:0 1px 3px #000,0 0 8px rgba(0,0,0,.8);font-family:'Archivo Black',sans-serif;background:rgba(0,0,0,.6);padding:1px 6px;border-radius:4px}
.t.or .ohp{color:#ffd700}.t.oc .ohp{color:#55ff55}
.t.ock{animation:oc .4s ease}
@keyframes oc{0%{transform:scale(1)}50%{transform:scale(1.1) rotate(5deg)}100%{transform:scale(1)}}
.dc{display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,rgba(26,10,10,.95),rgba(42,26,58,.95));backdrop-filter:blur(15px);padding:14px 20px;border-radius:15px;margin:12px auto;max-width:500px;border:3px solid rgba(255,69,0,.5);box-shadow:0 10px 30px rgba(0,0,0,.7)}
.cp{width:50px;height:50px;border-radius:50%;border:3px solid #ffd700;background:linear-gradient(135deg,#8b0000,#dc143c);display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;box-shadow:0 4px 15px rgba(255,215,0,.6)}
.dco{flex:1}.dcn{color:#ffd700;font-weight:700;font-size:1rem;margin-bottom:3px;font-family:'Archivo Black',sans-serif}.dct{font-size:.95rem;line-height:1.4}
.ntf{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(139,0,0,.98),rgba(220,20,60,.98));backdrop-filter:blur(20px);padding:30px 50px;border-radius:20px;border:5px solid #ffd700;font-size:1.3rem;text-align:center;z-index:10000;animation:nb .6s cubic-bezier(.68,-.55,.265,1.55);box-shadow:0 0 0 10px rgba(255,215,0,.3),0 25px 70px rgba(0,0,0,.8);max-width:90vw;white-space:pre-line;line-height:1.6}
@keyframes nb{0%{transform:translate(-50%,-50%) scale(0) rotate(-180deg)}70%{transform:translate(-50%,-50%) scale(1.1) rotate(10deg)}100%{transform:translate(-50%,-50%) scale(1) rotate(0)}}
.ntf.st{cursor:pointer}.ntf.st::after{content:'\A\A\1F446 Tap to continue';font-size:.8rem;opacity:.8;font-style:italic}
.scp{position:fixed;font-weight:900;font-size:2.2rem;color:#ffd700;text-shadow:0 0 15px #000,0 0 30px #ffd700,0 3px 0 #cc9900;z-index:9999;pointer-events:none;animation:sf 1.2s ease-out forwards;font-family:'Archivo Black',sans-serif}
@keyframes sf{0%{opacity:1;transform:translateY(0) scale(.5)}50%{transform:translateY(-60px) scale(1.5)}100%{opacity:0;transform:translateY(-130px) scale(1)}}
.ptc{position:fixed;font-size:2rem;z-index:9998;pointer-events:none;animation:pb 1.2s ease-out forwards}
@keyframes pb{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}
.lg{display:grid;grid-template-columns:repeat(auto-fill,minmax(75px,1fr));gap:12px;margin:15px 0}
.lb{aspect-ratio:1;background:linear-gradient(135deg,#4a4a4a,#2a2a2a);border:3px solid rgba(255,140,0,.4);border-radius:12px;color:#fff;font-size:1.5rem;font-weight:900;cursor:pointer;transition:all .2s;box-shadow:0 6px 0 #1a1a1a,0 8px 25px rgba(0,0,0,.5);position:relative;font-family:'Archivo Black',sans-serif}
.lb:hover:not(:disabled){transform:translateY(-4px);box-shadow:0 10px 0 #1a1a1a,0 12px 35px rgba(255,140,0,.6);border-color:rgba(255,140,0,.8)}
.lb:disabled{opacity:.3;cursor:not-allowed}
.lb.done{background:linear-gradient(135deg,#ffd700,#ff8c00);border-color:rgba(255,215,0,.6);box-shadow:0 6px 0 #cc9900,0 8px 25px rgba(255,215,0,.5)}
.lb.cur{animation:lp 1.5s ease-in-out infinite}
@keyframes lp{0%,100%{box-shadow:0 6px 0 #1a1a1a,0 8px 25px rgba(0,0,0,.5)}50%{box-shadow:0 6px 0 #1a1a1a,0 8px 25px rgba(255,215,0,1)}}
.lbs{position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:.8rem}
.sh{background:linear-gradient(135deg,rgba(26,10,10,.9),rgba(42,26,58,.9));backdrop-filter:blur(15px);padding:20px;border-radius:15px;margin:15px 0;text-align:center;border:3px solid rgba(255,69,0,.5)}
.sht{font-size:1.8rem;color:#ffd700;margin-bottom:8px;font-family:'Archivo Black',sans-serif}
.shd{font-size:1rem;font-style:italic;color:#ff8c00}
.at{position:fixed;top:12px;right:12px;z-index:100;background:rgba(0,0,0,.7);border:2px solid rgba(255,215,0,.5);border-radius:50%;width:44px;height:44px;font-size:1.3rem;cursor:pointer;color:#ffd700;display:flex;align-items:center;justify-content:center;transition:all .2s;backdrop-filter:blur(10px)}
.at:hover{border-color:#ffd700;transform:scale(1.1)}.at.mu{opacity:.5}
.ob{background:rgba(0,0,0,.5);border-radius:10px;padding:8px 15px;margin:8px auto;max-width:500px;display:flex;gap:15px;justify-content:center;flex-wrap:wrap;border:1px solid rgba(255,69,0,.3);font-size:.85rem}
@media(max-width:768px){
.hud{justify-content:center;gap:5px;margin-bottom:6px}
.hi{min-width:60px;padding:6px 8px}.hv{font-size:1.1rem}
.hl{font-size:.6rem;letter-spacing:1px}
.lg{grid-template-columns:repeat(auto-fill,minmax(55px,1fr));gap:8px}
.dc{flex-direction:row;text-align:left;padding:8px 12px;margin:6px auto;gap:8px}
.cp{width:36px;height:36px;font-size:1.3rem}
.dcn{font-size:.8rem}.dct{font-size:.8rem}
#gb{gap:4px;padding:8px;border-radius:14px;margin:6px auto;border-width:2px;box-shadow:0 0 0 3px rgba(255,69,0,.4),0 10px 30px rgba(0,0,0,.6)}
.t{border-radius:8px;border-width:1.5px}
.pc{padding:8px;margin-bottom:6px;border-radius:10px}
.pl{font-size:.85rem;margin-bottom:4px}
.pbg{height:22px}
.pb{font-size:.75rem}
.ob{padding:5px 10px;font-size:.75rem;margin:4px auto;gap:8px}
.ingame-links{padding:6px;gap:5px;margin:5px auto}
.ingame-links a{font-size:.75rem;padding:6px 10px;min-height:36px}
.combo-meter{margin:3px auto}
.tile-legend{padding:4px 8px;gap:6px;margin:4px auto;font-size:.6rem}
.tile-legend-dot{width:11px;height:11px;font-size:.5rem}
.bg{margin:8px 0}
.bs{padding:8px 16px;font-size:.8rem}
.ntf{padding:20px 30px;font-size:1.1rem;max-width:85vw}
.gt{font-size:clamp(1.6rem,7vw,3rem)}
#gc{padding:8px;padding-bottom:60px}
.sh{padding:12px;margin:8px 0}
.sht{font-size:1.3rem}
}
@media(max-width:400px){
#gb{gap:3px;padding:6px}
.t{border-radius:6px}
.hud{gap:3px}.hi{min-width:50px;padding:4px 6px}.hv{font-size:1rem}
.ingame-links a{font-size:.65rem;padding:5px 7px;min-height:32px}
.tile-legend{font-size:.55rem}
}

/* ===== NEW: Gallery/Backstage Screen ===== */
.gal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px;margin:15px 0}
.gal-card{background:linear-gradient(135deg,rgba(26,10,10,.9),rgba(42,26,58,.9));border-radius:14px;padding:16px;text-align:center;border:3px solid rgba(255,69,0,.3);box-shadow:0 8px 25px rgba(0,0,0,.6);transition:all .3s;position:relative;overflow:hidden}
.gal-card:hover{transform:translateY(-4px);box-shadow:0 12px 35px rgba(255,215,0,.4);border-color:rgba(255,215,0,.6)}
.gal-card.locked{opacity:.4;filter:grayscale(1)}.gal-card.locked::after{content:'\1F512';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2rem}
.gal-icon{font-size:2.5rem;margin-bottom:8px;display:block}
.gal-title{font-family:'Archivo Black',sans-serif;font-size:.85rem;color:#ffd700;margin-bottom:4px}
.gal-desc{font-size:.75rem;color:#ff8c00;line-height:1.3}
.gal-link{display:inline-block;margin-top:8px;background:linear-gradient(135deg,#dc143c,#8b0000);color:#fff;text-decoration:none;padding:6px 14px;border-radius:6px;font-size:.75rem;font-weight:700;transition:all .2s}
.gal-link:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(220,20,60,.6)}
/* ===== NEW: Achievements ===== */
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin:15px 0}
.ach-card{background:linear-gradient(135deg,rgba(26,10,10,.9),rgba(42,26,58,.9));border-radius:12px;padding:14px;text-align:center;border:3px solid rgba(255,69,0,.3);transition:all .3s}
.ach-card.earned{border-color:#ffd700;box-shadow:0 0 20px rgba(255,215,0,.3)}
.ach-card.locked{opacity:.45;filter:grayscale(.8)}
.ach-icon{font-size:2rem;margin-bottom:6px;display:block}
.ach-name{font-family:'Archivo Black',sans-serif;font-size:.8rem;color:#ffd700;margin-bottom:3px}
.ach-req{font-size:.7rem;color:#aaa;line-height:1.2}
.ach-card.earned .ach-req{color:#55ff55}
/* ===== NEW: Daily Challenge ===== */
.daily-banner{background:linear-gradient(135deg,rgba(139,0,0,.95),rgba(60,10,80,.95));border-radius:15px;padding:20px;text-align:center;border:3px solid #ffd700;margin:15px 0;box-shadow:0 0 30px rgba(255,215,0,.3)}
.daily-title{font-family:'Archivo Black',sans-serif;font-size:1.3rem;color:#ffd700;margin-bottom:6px}
.daily-desc{font-size:1rem;color:#fff;margin-bottom:12px}
.daily-timer{font-size:.85rem;color:#ff8c00;margin-top:8px}
/* ===== NEW: Settings Panel ===== */
.settings-panel{background:linear-gradient(135deg,rgba(26,10,10,.95),rgba(42,26,58,.95));border-radius:15px;padding:20px;border:3px solid rgba(255,69,0,.5);margin:15px 0}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,69,0,.2)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-size:1rem;color:#fff}
.setting-toggle{width:50px;height:28px;background:#333;border-radius:14px;cursor:pointer;position:relative;transition:background .3s;border:2px solid #555}
.setting-toggle.on{background:#dc143c;border-color:#ffd700}
.setting-toggle::after{content:'';position:absolute;width:22px;height:22px;background:#fff;border-radius:50%;top:1px;left:1px;transition:transform .3s}
.setting-toggle.on::after{transform:translateX(22px)}
/* ===== NEW: High Scores ===== */
.hs-list{list-style:none;margin:15px 0}
.hs-item{display:flex;justify-content:space-between;padding:12px 18px;background:linear-gradient(135deg,rgba(26,10,10,.8),rgba(42,26,58,.8));border-radius:10px;margin-bottom:8px;border:2px solid rgba(255,69,0,.3)}
.hs-rank{font-family:'Archivo Black',sans-serif;color:#ffd700;font-size:1.2rem;min-width:35px}
.hs-score{font-family:'Archivo Black',sans-serif;color:#fff;font-size:1.1rem}
.hs-level{font-size:.85rem;color:#ff8c00}
/* ===== NEW: Tabs ===== */
.tab-bar{display:flex;gap:6px;margin:12px 0;flex-wrap:wrap;justify-content:center}
.tab-btn{background:rgba(255,69,0,.15);border:2px solid rgba(255,69,0,.3);color:#ff8c00;padding:8px 18px;border-radius:8px;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:.9rem;font-weight:700;transition:all .2s}
.tab-btn.active{background:linear-gradient(135deg,#dc143c,#8b0000);border-color:#ffd700;color:#fff;box-shadow:0 4px 15px rgba(220,20,60,.5)}
.tab-btn:hover{border-color:#ffd700}
.tab-content{display:none}.tab-content.active{display:block}
/* ===== NEW: Unlock toast ===== */
.unlock-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;padding:14px 30px;border-radius:12px;font-family:'Archivo Black',sans-serif;font-size:1rem;z-index:10001;animation:toastIn .5s cubic-bezier(.68,-.55,.265,1.55),toastOut .5s ease 3.5s forwards;box-shadow:0 8px 30px rgba(255,215,0,.6);text-align:center}
@keyframes toastIn{from{transform:translateX(-50%) translateY(-100px) scale(.5);opacity:0}to{transform:translateX(-50%) translateY(0) scale(1);opacity:1}}
@keyframes toastOut{to{transform:translateX(-50%) translateY(-100px);opacity:0}}
/* ===== NEW: Tutorial overlay ===== */
.tut-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:9990;display:flex;align-items:center;justify-content:center}
.tut-box{background:linear-gradient(135deg,rgba(139,0,0,.98),rgba(60,10,80,.98));border:4px solid #ffd700;border-radius:20px;padding:30px;max-width:400px;text-align:center;animation:nb .5s cubic-bezier(.68,-.55,.265,1.55)}
.tut-step{font-family:'Archivo Black',sans-serif;font-size:.85rem;color:#ff8c00;margin-bottom:6px}
.tut-text{font-size:1.1rem;line-height:1.5;margin-bottom:15px}
.tut-arrow{font-size:3rem;margin:10px 0;animation:bounce 1s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}


/* ===== BGM Visualizer ===== */
.bgm-bar{position:fixed;bottom:0;left:0;width:100%;height:4px;z-index:99;display:flex;gap:1px;pointer-events:none}
.bgm-bar div{flex:1;background:#dc143c;transition:height .1s;height:2px;align-self:flex-end}
.bgm-bar.intense div{background:#ffd700}
/* ===== Band Links Bar (in-game) ===== */
.ingame-links{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px auto;max-width:520px;padding:12px;background:rgba(0,0,0,.6);border-radius:12px;border:2px solid rgba(255,215,0,.3);backdrop-filter:blur(8px)}
.ingame-links a{color:#ffd700;text-decoration:none;font-size:.95rem;font-weight:700;padding:10px 16px;border-radius:8px;background:rgba(255,215,0,.12);border:2px solid rgba(255,215,0,.4);transition:all .2s;min-height:44px;display:flex;align-items:center}
.ingame-links a:hover{background:rgba(255,215,0,.25);border-color:#ffd700;transform:scale(1.05)}
/* ===== Amp Tile (match-4 special) ===== */
.t.amp{background:linear-gradient(135deg,#ff4500,#ff8c00,#ff4500)!important;background-size:200% 200%!important;animation:ampPulse 1s ease-in-out infinite;box-shadow:0 0 0 3px #ff4500,0 8px 0 rgba(0,0,0,.5),0 0 35px rgba(255,69,0,.8);border-color:#ff4500!important}
@keyframes ampPulse{0%,100%{filter:brightness(1.2)}50%{filter:brightness(1.6);transform:scale(1.04)}}
.t.amp::after{content:'\1F50A';position:absolute;top:-8px;right:-8px;font-size:1.2rem;z-index:10;animation:ss 2s linear infinite}
.t.amp .amp-arrow{position:absolute;font-size:1.5rem;color:#fff;text-shadow:0 0 10px #ff4500;opacity:.8;pointer-events:none}
.t.amp .amp-arrow.h{top:50%;left:50%;transform:translate(-50%,-50%)}
/* ===== Rockstar Tile (match-5 special) ===== */
.t.rstar{background:conic-gradient(from 0deg,#ff0080,#ff4500,#ffd700,#00ff88,#4488ff,#ff0080)!important;animation:rstarSpin 2s linear infinite;box-shadow:0 0 0 4px #fff,0 10px 0 rgba(0,0,0,.5),0 0 50px rgba(255,255,255,.5);border-color:#fff!important}
@keyframes rstarSpin{from{filter:hue-rotate(0) brightness(1.3)}to{filter:hue-rotate(360deg) brightness(1.3)}}
.t.rstar::after{content:'\2B50';position:absolute;top:-10px;right:-10px;font-size:1.4rem;z-index:10;animation:ss 1.5s linear infinite}
/* ===== Screen Shake ===== */
@keyframes screenShake{0%,100%{transform:translate(0)}10%{transform:translate(-4px,2px)}20%{transform:translate(4px,-2px)}30%{transform:translate(-2px,4px)}40%{transform:translate(2px,-4px)}50%{transform:translate(-4px,0)}60%{transform:translate(4px,2px)}70%{transform:translate(-2px,-2px)}80%{transform:translate(2px,2px)}90%{transform:translate(-2px,0)}}
.shake{animation:screenShake .4s ease}
.shake-big{animation:screenShake .6s ease}
/* ===== Win Screen Upgrade ===== */
.win-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center}
.win-box{background:linear-gradient(135deg,rgba(139,0,0,.98),rgba(60,10,80,.98));border:5px solid #ffd700;border-radius:24px;padding:35px;max-width:420px;text-align:center;animation:nb .6s cubic-bezier(.68,-.55,.265,1.55);box-shadow:0 0 0 12px rgba(255,215,0,.3),0 30px 80px rgba(0,0,0,.9)}
.win-stars{font-size:3rem;margin:10px 0;filter:drop-shadow(0 4px 15px rgba(255,215,0,.8))}
.win-score{font-family:'Archivo Black',sans-serif;font-size:2rem;color:#ffd700;margin:8px 0}
.win-msg{font-size:1.1rem;color:#fff;margin:8px 0;line-height:1.4}
.win-unlock{background:rgba(255,215,0,.15);border:2px solid rgba(255,215,0,.4);border-radius:10px;padding:10px;margin:10px 0;color:#ffd700;font-size:.9rem}
.win-btns{display:flex;gap:10px;justify-content:center;margin-top:15px;flex-wrap:wrap}
/* ===== Streak Badge ===== */
.streak-badge{position:absolute;top:-8px;left:-8px;background:#dc143c;color:#fff;font-family:'Archivo Black',sans-serif;font-size:.65rem;padding:3px 7px;border-radius:8px;border:2px solid #ffd700;z-index:12;box-shadow:0 3px 10px rgba(0,0,0,.5)}
/* ===== Combo Meter ===== */
.combo-meter{height:4px;background:rgba(255,69,0,.2);border-radius:2px;margin:4px auto;max-width:500px;overflow:hidden}
.combo-fill{height:100%;background:linear-gradient(90deg,#dc143c,#ffd700);transition:width .3s;border-radius:2px;box-shadow:0 0 10px rgba(255,215,0,.5)}
/* ===== Level Complete Confetti ===== */
.confetti{position:fixed;width:10px;height:10px;z-index:10002;pointer-events:none;animation:confettiFall 3s ease-out forwards}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0) scale(1);opacity:1}100%{transform:translateY(100vh) rotate(720deg) scale(0);opacity:0}}


/* ===== Level intro animation ===== */
.level-intro{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:9995;display:flex;align-items:center;justify-content:center;flex-direction:column;animation:fi .3s ease}
.level-intro-num{font-family:'Archivo Black',sans-serif;font-size:5rem;color:#ffd700;text-shadow:0 0 40px rgba(255,215,0,.8),0 0 80px rgba(255,215,0,.4);animation:introZoom 1.5s ease-out forwards}
.level-intro-name{font-size:1.4rem;color:#ff8c00;margin-top:10px;animation:fi .5s ease .3s both}
@keyframes introZoom{0%{transform:scale(3) rotate(-10deg);opacity:0}40%{transform:scale(1) rotate(0);opacity:1}100%{transform:scale(1);opacity:1}}
/* ===== Tile match streak counter ===== */
.streak-pop{position:fixed;font-family:'Archivo Black',sans-serif;font-size:3rem;color:#fff;z-index:9998;pointer-events:none;text-shadow:0 0 20px #dc143c,0 0 40px #ffd700,0 4px 0 #8b0000;animation:streakPop 1.5s ease-out forwards;left:50%;transform:translateX(-50%)}
@keyframes streakPop{0%{top:40%;opacity:0;transform:translateX(-50%) scale(0) rotate(-20deg)}20%{opacity:1;transform:translateX(-50%) scale(1.3) rotate(5deg)}40%{transform:translateX(-50%) scale(1) rotate(0)}100%{top:20%;opacity:0;transform:translateX(-50%) scale(.8)}}
/* ===== Smoother tile hover on mobile ===== */
@media(hover:none){.t:hover{transform:none;box-shadow:0 5px 0 rgba(0,0,0,.4),0 7px 20px rgba(0,0,0,.5)}}
/* ===== Pulsing play button ===== */
.btn-play{animation:btnPulse 2s ease-in-out infinite}
@keyframes btnPulse{0%,100%{box-shadow:0 8px 0 #5a0000,0 10px 25px rgba(0,0,0,.6),inset 0 -2px 10px rgba(0,0,0,.4),inset 0 2px 5px rgba(255,255,255,.3)}50%{box-shadow:0 8px 0 #5a0000,0 10px 35px rgba(255,215,0,.6),0 0 30px rgba(220,20,60,.4),inset 0 -2px 10px rgba(0,0,0,.4),inset 0 2px 5px rgba(255,255,255,.3)}}


/* ===== Tile Legend (what do specials do?) ===== */
.tile-legend{background:rgba(0,0,0,.6);border-radius:10px;padding:8px 12px;margin:6px auto;max-width:520px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;border:1px solid rgba(255,69,0,.2);font-size:.72rem;color:#aaa;backdrop-filter:blur(5px)}
.tile-legend-item{display:flex;align-items:center;gap:4px;white-space:nowrap}
.tile-legend-dot{width:14px;height:14px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.6rem;flex-shrink:0}
.tl-gem{background:linear-gradient(135deg,#ffd700,#ff4500);border:1px solid #ffd700}
.tl-amp{background:linear-gradient(135deg,#ff4500,#ff8c00);border:1px solid #ff4500}
.tl-xr{background:conic-gradient(#dc143c,#ffd700,#ff4500,#dc143c);border:1px solid #ffd700}
.tl-rs{background:conic-gradient(#ff0080,#ffd700,#00ff88,#4488ff,#ff0080);border:1px solid #fff}
.tl-road{background:#5c3a1e;border:1px solid #8B4513}
.tl-cable{background:#1a2a1a;border:1px solid #2d5a2d}
/* ===== Unlock popup with links ===== */
.unlock-detail{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(20,5,30,.98),rgba(60,10,10,.98));border:4px solid #ffd700;border-radius:20px;padding:30px;max-width:380px;width:90%;text-align:center;z-index:10003;animation:nb .5s cubic-bezier(.68,-.55,.265,1.55);box-shadow:0 0 0 10px rgba(255,215,0,.2),0 30px 80px rgba(0,0,0,.9)}
.unlock-detail-icon{font-size:3rem;margin-bottom:8px}
.unlock-detail-title{font-family:'Archivo Black',sans-serif;font-size:1.2rem;color:#ffd700;margin-bottom:6px}
.unlock-detail-desc{font-size:.95rem;color:#fff;margin-bottom:14px;line-height:1.4}
.unlock-detail-link{display:inline-block;background:linear-gradient(135deg,#dc143c,#8b0000);color:#fff;text-decoration:none;padding:12px 28px;border-radius:10px;font-size:1rem;font-weight:700;transition:all .2s;border:2px solid #ffd700;margin:4px}
.unlock-detail-link:hover{transform:scale(1.05);box-shadow:0 6px 25px rgba(255,215,0,.5)}
.unlock-detail-close{display:inline-block;background:rgba(255,255,255,.1);color:#aaa;padding:8px 20px;border-radius:8px;font-size:.85rem;cursor:pointer;margin:4px;border:1px solid rgba(255,255,255,.2);transition:all .2s}
.unlock-detail-close:hover{background:rgba(255,255,255,.2);color:#fff}
/* ===== Surprise event flash ===== */
.surprise-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,215,0,.15);z-index:9000;pointer-events:none;animation:flashFade .4s ease-out forwards}
@keyframes flashFade{from{opacity:1}to{opacity:0}}


/* ===== Near-win excitement pulse ===== */
.near-win #gb{animation:nearWinPulse 1s ease-in-out infinite}
@keyframes nearWinPulse{0%,100%{box-shadow:0 0 0 5px rgba(255,69,0,.4),0 20px 60px rgba(0,0,0,.8)}50%{box-shadow:0 0 0 5px rgba(255,215,0,.8),0 20px 60px rgba(255,215,0,.3),0 0 40px rgba(255,215,0,.2)}}
/* ===== Last moves warning ===== */
.low-moves #hmv{color:#ff4500!important;animation:movesWarn 1s ease-in-out infinite}
@keyframes movesWarn{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
/* ===== Score counting animation ===== */
.score-tick{animation:scoreTick .3s ease}
@keyframes scoreTick{0%{transform:scale(1)}50%{transform:scale(1.15);color:#fff}100%{transform:scale(1)}}
/* ===== Board entrance animation ===== */
.board-enter .t{opacity:0;animation:boardTileEnter .4s ease forwards}
@keyframes boardTileEnter{from{opacity:0;transform:scale(0) rotate(-90deg)}to{opacity:1;transform:scale(1) rotate(0)}}
/* ===== Objective complete flash ===== */
.obj-done{animation:objDone .5s ease}
@keyframes objDone{0%{background:rgba(255,215,0,.3)}100%{background:transparent}}
/* ===== Smooth progress bar glow when close ===== */
.pb.close{box-shadow:0 0 25px rgba(255,215,0,1),0 0 50px rgba(255,215,0,.5)}
/* ===== Better mobile scrolling ===== */
#gc{padding-bottom:80px}
/* ===== Tile pop on place ===== */
.tile-pop{animation:tilePop .2s ease}
@keyframes tilePop{0%{transform:scale(.8)}50%{transform:scale(1.1)}100%{transform:scale(1)}}


/* ===== Touch swipe feedback ===== */
.t.drag-over{box-shadow:0 0 0 3px #ffd700,0 8px 20px rgba(255,215,0,.5)!important;transform:scale(1.05)}
/* ===== Objective banner (clearer what to do) ===== */
.obj-banner{background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,69,0,.1));border:2px solid rgba(255,215,0,.3);border-radius:10px;padding:10px 14px;margin:6px auto;max-width:520px;text-align:center;font-size:.85rem;color:#ffd700;line-height:1.3}
.obj-banner b{color:#fff}
.obj-banner .obj-icon{font-size:1.2rem;margin-right:4px}
/* ===== First-time helper arrows ===== */
.first-play-hint{position:absolute;top:-30px;left:50%;transform:translateX(-50%);font-size:.7rem;color:#ffd700;white-space:nowrap;animation:bounce 1.5s infinite;pointer-events:none;text-shadow:0 1px 5px rgba(0,0,0,.8);z-index:20}
@media(max-width:768px){.obj-banner{font-size:.75rem;padding:6px 10px;margin:4px auto}}


/* ===== Rock Star Life Shop ===== */
.shop-status{background:linear-gradient(135deg,rgba(26,10,10,.95),rgba(42,26,58,.95));border-radius:16px;padding:18px;border:3px solid rgba(255,215,0,.4);margin:12px 0;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.shop-coins{font-family:'Archivo Black',sans-serif;font-size:1.8rem;color:#ffd700;text-shadow:0 0 15px rgba(255,215,0,.6)}
.shop-fame{font-size:.9rem;color:#ff8c00;margin-top:4px}
.fame-bar{background:rgba(0,0,0,.5);height:10px;border-radius:5px;margin:6px auto;max-width:300px;overflow:hidden;border:1px solid rgba(255,215,0,.3)}
.fame-fill{height:100%;background:linear-gradient(90deg,#dc143c,#ffd700);border-radius:5px;transition:width .5s}
.fame-label{font-size:.75rem;color:#aaa;margin-top:2px}
.shop-cat-bar{display:flex;gap:6px;justify-content:center;margin:12px 0;flex-wrap:wrap}
.shop-cat{background:rgba(255,69,0,.15);border:2px solid rgba(255,69,0,.3);color:#ff8c00;padding:8px 14px;border-radius:8px;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:.85rem;font-weight:700;transition:all .2s}
.shop-cat.active{background:linear-gradient(135deg,#dc143c,#8b0000);border-color:#ffd700;color:#fff;box-shadow:0 4px 15px rgba(220,20,60,.5)}
.shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin:12px 0}
.shop-item{background:linear-gradient(135deg,rgba(26,10,10,.9),rgba(42,26,58,.9));border-radius:14px;padding:16px;text-align:center;border:3px solid rgba(255,69,0,.3);transition:all .3s;position:relative;cursor:pointer}
.shop-item:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(255,215,0,.3);border-color:rgba(255,215,0,.5)}
.shop-item.owned{border-color:#ffd700;background:linear-gradient(135deg,rgba(50,30,10,.9),rgba(60,30,70,.9))}
.shop-item.owned::after{content:'\2705';position:absolute;top:8px;right:8px;font-size:1rem}
.shop-item.equipped{border-color:#00ff88;box-shadow:0 0 20px rgba(0,255,136,.3)}
.shop-item.equipped::after{content:'\1F451';position:absolute;top:8px;right:8px;font-size:1rem}
.shop-item.locked{opacity:.5}
.shop-icon{font-size:2.8rem;margin-bottom:8px;display:block}
.shop-name{font-family:'Archivo Black',sans-serif;font-size:.8rem;color:#ffd700;margin-bottom:3px}
.shop-desc{font-size:.7rem;color:#aaa;margin-bottom:6px;line-height:1.2}
.shop-price{font-family:'Archivo Black',sans-serif;font-size:.85rem;color:#ffd700;display:flex;align-items:center;justify-content:center;gap:4px}
.shop-price.owned-price{color:#55ff55}
/* ===== Band Preview ===== */
.band-preview{background:linear-gradient(135deg,rgba(0,0,0,.8),rgba(30,10,40,.8));border-radius:16px;padding:18px;margin:12px 0;border:2px solid rgba(255,69,0,.3);text-align:center}
.band-preview-title{font-family:'Archivo Black',sans-serif;font-size:1rem;color:#ffd700;margin-bottom:10px}
.band-scene{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;font-size:2rem;margin:8px 0}
.band-scene-item{display:flex;flex-direction:column;align-items:center;gap:2px}
.band-scene-label{font-size:.6rem;color:#ff8c00}
.fame-level{display:inline-block;background:linear-gradient(135deg,#dc143c,#8b0000);color:#fff;padding:3px 10px;border-radius:6px;font-size:.7rem;font-weight:700;border:1px solid rgba(255,215,0,.5);margin-top:6px}
@media(max-width:768px){.shop-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}.shop-item{padding:12px}.shop-icon{font-size:2.2rem}.shop-name{font-size:.7rem}.shop-desc{font-size:.6rem}}


/* ===== Goal Tracker (in-game HUD) ===== */
.goal-tracker{background:linear-gradient(135deg,rgba(0,0,0,.7),rgba(30,10,40,.7));border:2px solid rgba(255,215,0,.3);border-radius:10px;padding:8px 12px;margin:6px auto;max-width:520px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s;backdrop-filter:blur(5px)}
.goal-tracker:hover{border-color:#ffd700;box-shadow:0 4px 15px rgba(255,215,0,.3)}
.goal-icon{font-size:1.6rem;flex-shrink:0}
.goal-info{flex:1;min-width:0}
.goal-name{font-family:'Archivo Black',sans-serif;font-size:.75rem;color:#ffd700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.goal-progress{display:flex;align-items:center;gap:6px;margin-top:3px}
.goal-bar{flex:1;background:rgba(255,255,255,.1);height:8px;border-radius:4px;overflow:hidden}
.goal-fill{height:100%;background:linear-gradient(90deg,#dc143c,#ffd700);border-radius:4px;transition:width .5s}
.goal-pct{font-size:.65rem;color:#ff8c00;white-space:nowrap}
.goal-ready{animation:goalReady 1s ease-in-out infinite}
@keyframes goalReady{0%,100%{border-color:#ffd700;box-shadow:0 0 10px rgba(255,215,0,.3)}50%{border-color:#00ff88;box-shadow:0 0 25px rgba(0,255,136,.5)}}
/* ===== Afford Alert Toast ===== */
.afford-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;padding:14px 24px;border-radius:14px;font-family:'Archivo Black',sans-serif;font-size:.9rem;z-index:10001;animation:affordIn .5s cubic-bezier(.68,-.55,.265,1.55);box-shadow:0 8px 30px rgba(255,215,0,.6);text-align:center;cursor:pointer;max-width:90vw}
@keyframes affordIn{from{transform:translateX(-50%) translateY(50px) scale(.8);opacity:0}to{transform:translateX(-50%) translateY(0) scale(1);opacity:1}}
/* ===== Shop item progress bar ===== */
.shop-item-progress{background:rgba(255,255,255,.1);height:6px;border-radius:3px;margin-top:6px;overflow:hidden}
.shop-item-fill{height:100%;background:linear-gradient(90deg,#dc143c,#ffd700);border-radius:3px;transition:width .3s}
.shop-item.affordable{border-color:#00ff88!important;box-shadow:0 0 20px rgba(0,255,136,.3)!important;animation:canBuy 1.5s ease-in-out infinite}
@keyframes canBuy{0%,100%{box-shadow:0 0 15px rgba(0,255,136,.3)}50%{box-shadow:0 0 30px rgba(0,255,136,.6)}}
.shop-item.affordable .shop-price{color:#00ff88!important}
/* ===== Post-level reward breakdown ===== */
.reward-breakdown{background:rgba(0,0,0,.4);border-radius:10px;padding:10px;margin:8px 0;border:1px solid rgba(255,215,0,.2)}
.reward-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:.8rem}
.reward-row .label{color:#aaa}.reward-row .value{color:#ffd700;font-weight:700}
.reward-row.total{border-top:1px solid rgba(255,215,0,.3);margin-top:4px;padding-top:6px;font-size:.9rem}
.reward-row.total .label{color:#fff}.reward-row.total .value{color:#00ff88}
/* ===== Next purchase teaser ===== */
.next-buy{background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,69,0,.05));border:1px dashed rgba(255,215,0,.3);border-radius:8px;padding:8px;margin-top:8px;font-size:.8rem;color:#ff8c00;text-align:center;cursor:pointer}
.next-buy:hover{border-color:#ffd700;background:rgba(255,215,0,.15)}
.next-buy b{color:#ffd700}
@media(max-width:768px){.goal-tracker{padding:6px 10px;gap:8px}.goal-icon{font-size:1.3rem}.goal-name{font-size:.65rem}.goal-pct{font-size:.6rem}.afford-toast{font-size:.8rem;padding:10px 18px;bottom:60px}}


/* ===== Upgrade Bonus HUD ===== */
.bonus-bar{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:4px auto;max-width:520px}
.bonus-pill{background:rgba(0,0,0,.5);border:1px solid rgba(255,215,0,.25);border-radius:20px;padding:3px 10px;font-size:.65rem;color:#ffd700;display:flex;align-items:center;gap:3px;backdrop-filter:blur(5px)}
.bonus-pill .bp-icon{font-size:.8rem}
.bonus-pill.active{border-color:rgba(0,255,136,.4);color:#00ff88;background:rgba(0,255,136,.08)}
/* ===== Power Chord Tile ===== */
.t.pchord{background:linear-gradient(135deg,#8b00ff,#4400aa,#8b00ff)!important;background-size:200% 200%!important;box-shadow:0 0 0 3px #8b00ff,0 8px 0 rgba(0,0,0,.5),0 0 30px rgba(139,0,255,.6);border-color:#8b00ff!important}
.t.pchord::after{content:'\1F3B5';position:absolute;top:-8px;right:-8px;font-size:1.1rem;z-index:10}
/* ===== Crowd Surf Tile ===== */
.t.csurf{background:linear-gradient(135deg,#ff1493,#ff69b4,#ff1493)!important;box-shadow:0 0 0 3px #ff1493,0 8px 0 rgba(0,0,0,.5),0 0 30px rgba(255,20,147,.6);border-color:#ff1493!important}
.t.csurf::after{content:'\1F3C4';position:absolute;top:-8px;right:-8px;font-size:1.1rem;z-index:10}
/* ===== Encore Tile ===== */
.t.encore{background:linear-gradient(135deg,#00cc88,#00ff88,#00cc88)!important;box-shadow:0 0 0 3px #00ff88,0 8px 0 rgba(0,0,0,.5),0 0 30px rgba(0,255,136,.6);border-color:#00ff88!important}
.t.encore::after{content:'\1F504';position:absolute;top:-8px;right:-8px;font-size:1.1rem;z-index:10}
/* ===== Smooth pulse for special tiles (no strobe!) ===== */
.t.pchord,.t.csurf,.t.encore{animation:specialGlow 3s ease-in-out infinite}
@keyframes specialGlow{0%,100%{filter:brightness(1.1)}50%{filter:brightness(1.35)}}
/* ===== Bonus popup on level start ===== */
.bonus-splash{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:9994;display:flex;align-items:center;justify-content:center}
.bonus-splash-box{background:linear-gradient(135deg,rgba(20,5,30,.98),rgba(40,15,10,.98));border:4px solid #ffd700;border-radius:20px;padding:28px;max-width:380px;width:90%;text-align:center;animation:nb .5s cubic-bezier(.68,-.55,.265,1.55);box-shadow:0 0 0 10px rgba(255,215,0,.15),0 30px 60px rgba(0,0,0,.9)}
.bonus-splash-title{font-family:'Archivo Black',sans-serif;font-size:1.2rem;color:#ffd700;margin-bottom:12px}
.bonus-item{display:flex;align-items:center;gap:10px;padding:8px;margin:6px 0;background:rgba(255,215,0,.06);border-radius:10px;border:1px solid rgba(255,215,0,.15);text-align:left}
.bonus-item-icon{font-size:1.6rem;flex-shrink:0}
.bonus-item-text{flex:1}
.bonus-item-name{font-family:'Archivo Black',sans-serif;font-size:.75rem;color:#ffd700}
.bonus-item-effect{font-size:.7rem;color:#00ff88;margin-top:2px}
.bonus-splash .btn{margin-top:14px}
/* ===== Shop: bonus descriptions ===== */
.shop-bonus{font-size:.65rem;color:#00ff88;margin-top:3px;font-weight:700}
/* ===== Tile legend additions ===== */
.tl-pchord{background:linear-gradient(135deg,#8b00ff,#4400aa);border:1px solid #8b00ff}
.tl-csurf{background:linear-gradient(135deg,#ff1493,#ff69b4);border:1px solid #ff1493}
.tl-encore{background:linear-gradient(135deg,#00cc88,#00ff88);border:1px solid #00ff88}
@media(max-width:768px){.bonus-bar{gap:4px}.bonus-pill{font-size:.58rem;padding:2px 7px}.bonus-splash-box{padding:20px}.bonus-item{padding:6px;gap:8px}.bonus-item-icon{font-size:1.3rem}}


/* ===== Menu visual upgrades ===== */
.sub::after{content:'\2605 A Match-3 Rock Adventure \2605';display:block;font-size:.8rem;color:#ff8c00;margin-top:4px;letter-spacing:1px;opacity:.8}
/* ===== Better dialogue box ===== */
.dc{background:linear-gradient(135deg,rgba(26,10,10,.92),rgba(42,26,58,.92));backdrop-filter:blur(12px);border:2px solid rgba(255,69,0,.4);border-radius:14px;padding:10px 14px;margin:8px auto;max-width:520px;display:flex;gap:12px;align-items:center;box-shadow:0 6px 20px rgba(0,0,0,.5)}
.cp{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#dc143c,#8b0000);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;border:2px solid rgba(255,215,0,.5);box-shadow:0 3px 10px rgba(0,0,0,.4)}
.dcn{font-family:'Archivo Black',sans-serif;font-size:.8rem;color:#ffd700}
.dct{font-size:.85rem;color:#e0e0e0;font-style:italic;line-height:1.3;margin-top:2px}
/* ===== Score popup upgrade ===== */
.scp{position:fixed;font-family:'Archivo Black',sans-serif;font-size:1.4rem;z-index:9998;pointer-events:none;text-shadow:0 2px 8px rgba(0,0,0,.8),0 0 15px rgba(255,215,0,.6);animation:scpAnim 1.2s ease-out forwards}
@keyframes scpAnim{0%{opacity:1;transform:translateY(0) scale(.8)}20%{opacity:1;transform:translateY(-15px) scale(1.1)}100%{opacity:0;transform:translateY(-80px) scale(.7)}}
/* ===== Level select visual upgrade ===== */
.lb{position:relative;overflow:hidden}
.lb::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,215,0,.15),transparent);transition:left .6s}
.lb:hover::before{left:100%}
.lb.cur{box-shadow:0 0 0 3px #ffd700,0 0 20px rgba(255,215,0,.4)}
/* ===== Win overlay upgrade ===== */
.win-box{position:relative;overflow:hidden}
.win-box::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(255,215,0,.05),transparent,rgba(255,215,0,.05));animation:winShimmer 8s linear infinite;pointer-events:none}
@keyframes winShimmer{from{transform:rotate(0)}to{transform:rotate(360deg)}}
/* ===== Particle trails on matches ===== */
.ptc{position:fixed;font-size:1.2rem;z-index:9997;pointer-events:none;animation:ptcAnim .8s ease-out forwards}
@keyframes ptcAnim{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
/* ===== Smooth tile transitions ===== */
.t{transition:all .15s cubic-bezier(.34,1.56,.64,1),box-shadow .2s ease}


.tut-full{position:fixed;top:0;left:0;width:100%;height:100%;z-index:20000;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;animation:fi .3s ease}
.tut-card{background:linear-gradient(135deg,#1a0a2a,#2a1a3a);border:4px solid #ffd700;border-radius:20px;padding:30px 25px;max-width:380px;width:90%;text-align:center;box-shadow:0 0 60px rgba(255,215,0,.3),0 20px 60px rgba(0,0,0,.8);position:relative}
.tut-step{font-size:.8rem;color:#ff8c00;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px}
.tut-title{font-family:'Archivo Black',sans-serif;font-size:1.5rem;color:#ffd700;margin-bottom:15px}
.tut-img{font-size:3.5rem;margin:10px 0}
.tut-text{font-size:1rem;line-height:1.6;margin-bottom:20px;color:#eee}
.tut-text b{color:#ffd700}
.tut-text em{color:#ff8c00;font-style:normal}
.tut-btn{background:linear-gradient(135deg,#dc143c,#8b0000);border:none;color:#fff;padding:14px 40px;font-size:1.1rem;font-weight:700;border-radius:8px;cursor:pointer;box-shadow:0 6px 0 #5a0000,0 8px 20px rgba(0,0,0,.5);text-transform:uppercase;font-family:'Barlow Condensed',sans-serif;transition:all .2s;letter-spacing:1px}
.tut-btn:active{transform:translateY(4px);box-shadow:0 2px 0 #5a0000}
.tut-skip{position:absolute;top:12px;right:16px;background:none;border:none;color:#888;font-size:.85rem;cursor:pointer;font-family:'Barlow Condensed',sans-serif}
.tut-skip:hover{color:#ffd700}
.tut-dots{display:flex;gap:8px;justify-content:center;margin-top:15px}
.tut-dot{width:10px;height:10px;border-radius:50%;background:#444;transition:all .2s}
.tut-dot.active{background:#ffd700;box-shadow:0 0 8px rgba(255,215,0,.6)}
</style>
</head>
<body>
<button class="at" id="at" onclick="tgA()">&#128266;</button>
<div class="bgm-bar" id="bgm-bar"></div>
<div id="bg-stage"><div class="stage-lights"><div class="light-beam"></div><div class="light-beam"></div><div class="light-beam"></div><div class="light-beam"></div></div><div class="sparkles" id="spk"></div></div>
<div id="gc">
<!-- MENU -->
<div id="ms" class="screen active">
<h1 class="gt">&#127928; X-RAY STAR &#127928;</h1>
<p class="sub">Match to Stardom</p>
<div class="bl">
<a href="https://x-raystarband.net/" target="_blank" class="bla">&#127760; Website</a>
<a href="https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi" target="_blank" class="bla">&#127925; Spotify</a>
<a href="https://youtube.com/playlist?list=PLd1uZNELj91lcc_vY2wqcmCd9OqVxs0-d" target="_blank" class="bla">&#9654;&#65039; YouTube</a>
<a href="https://www.facebook.com/XRayStarband" target="_blank" class="bla">&#128218; Facebook</a>
<a href="https://www.redbubble.com/shop/ap/172252421" target="_blank" class="bla">&#128085; Merch</a>
</div>
<div class="dc"><div class="cp">&#127928;</div><div class="dco"><div class="dcn">Jake</div><div class="dct">"Ready to go from basement to stadiums? Let's match some instruments and ROCK!"</div></div></div>
<div class="bg"><button class="btn btn-play" onclick="startGame()">&#127925; LET'S ROCK!</button><br><button class="btn btn2 bs" onclick="showDaily()">&#128293; Daily Challenge</button> <button class="btn" onclick="showRSL()" style="background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;box-shadow:0 8px 0 #b8860b,0 10px 25px rgba(0,0,0,.6)">&#127775; ROCK STAR LIFE</button> <button class="btn btn2 bs" onclick="showBK()">&#127911; Backstage</button><br><button class="btn btn2 bs" onclick="showSets()">&#9881;&#65039; Settings</button> <button class="btn btn2 bs" onclick="showTutorial(true)">&#128214; How to Play</button></div>
</div>
<!-- LEVEL SELECT -->
<div id="ls" class="screen">
<h2 class="gt" style="font-size:2.2rem">Select Level</h2>
<div class="sh"><div class="sht" id="stt">&#127968; Stage 1: Basement Dreamers</div><div class="shd" id="std">"We're gonna be HUGE... someday."</div></div>
<div class="lg" id="lgr"></div>
<div class="bg" style="margin-top:20px">
<button class="btn" onclick="returnFromShop()" style="font-size:1.1rem;padding:14px 36px" id="rsl-back-bottom">&#127926; BACK TO GAME</button>
<button class="btn btn2" onclick="showM()" style="padding:12px 28px">&#127968; Back to Menu</button>
</div>
</div>

<!-- BACKSTAGE / GALLERY SCREEN -->
<div id="bks" class="screen">
<h2 class="gt" style="font-size:2rem">&#127911; Backstage Pass</h2>
<div class="tab-bar">
<button class="tab-btn active" onclick="showTab('songs')">&#127925; Songs</button>
<button class="tab-btn" onclick="showTab('videos')">&#127909; Videos</button>
<button class="tab-btn" onclick="showTab('merch')">&#128085; Merch</button>
<button class="tab-btn" onclick="showTab('achs')">&#127942; Achievements</button>
<button class="tab-btn" onclick="showTab('scores')">&#127942; High Scores</button>
</div>
<div id="tab-songs" class="tab-content active"><div class="gal-grid" id="song-grid"></div></div>
<div id="tab-videos" class="tab-content"><div class="gal-grid" id="vid-grid"></div></div>
<div id="tab-merch" class="tab-content"><div class="gal-grid" id="merch-grid"></div></div>
<div id="tab-achs" class="tab-content"><div class="ach-grid" id="ach-grid"></div></div>
<div id="tab-scores" class="tab-content"><ul class="hs-list" id="hs-list"></ul></div>
<div class="bg" style="margin-top:20px">
<button class="btn" onclick="returnFromShop()" style="font-size:1.1rem;padding:14px 36px" id="rsl-back-bottom">&#127926; BACK TO GAME</button>
<button class="btn btn2" onclick="showM()" style="padding:12px 28px">&#127968; Back to Menu</button>
</div>
</div>
<!-- SETTINGS SCREEN -->
<div id="sets" class="screen">
<h2 class="gt" style="font-size:2rem">&#9881;&#65039; Settings</h2>
<div class="settings-panel">
<div class="setting-row"><span class="setting-label">&#128266; Sound Effects</span><div class="setting-toggle on" id="stg-sfx" onclick="tgSfx()"></div></div>
<div class="setting-row"><span class="setting-label">&#128161; Hints</span><div class="setting-toggle on" id="stg-hints" onclick="tgHints()"></div></div>
<div class="setting-row"><span class="setting-label">&#128163; Reset All Progress</span><button class="btn bs" style="padding:8px 16px;font-size:.8rem;margin:0" onclick="resetAll()">RESET</button></div>
</div>
<div class="bg" style="margin-top:20px">
<button class="btn" onclick="returnFromShop()" style="font-size:1.1rem;padding:14px 36px" id="rsl-back-bottom">&#127926; BACK TO GAME</button>
<button class="btn btn2" onclick="showM()" style="padding:12px 28px">&#127968; Back to Menu</button>
</div>
</div>
<!-- DAILY CHALLENGE SCREEN -->
<div id="dcs" class="screen">
<h2 class="gt" style="font-size:2rem">&#128293; Daily Challenge</h2>
<div class="daily-banner">
<div class="daily-title" id="dc-title">Today's Challenge</div>
<div class="daily-desc" id="dc-desc">Loading...</div>
<button class="btn" id="dc-btn" onclick="startDaily()">&#127925; PLAY CHALLENGE</button>
<div class="daily-timer" id="dc-timer"></div>
</div>
<div class="bg" style="margin-top:20px">
<button class="btn" onclick="returnFromShop()" style="font-size:1.1rem;padding:14px 36px" id="rsl-back-bottom">&#127926; BACK TO GAME</button>
<button class="btn btn2" onclick="showM()" style="padding:12px 28px">&#127968; Back to Menu</button>
</div>
</div>


<!-- ROCK STAR LIFE SHOP -->
<div id="rsl" class="screen">
<h2 class="gt" style="font-size:1.8rem">&#127775; Rock Star Life</h2>
<div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;flex-wrap:wrap">
<button class="btn bs" onclick="returnFromShop()" style="flex:1;max-width:220px" id="rsl-back-top">&#127926; BACK TO GAME</button>
<button class="btn btn2 bs" onclick="showM()" style="flex:1;max-width:200px">&#127968; MENU</button>
</div>
<div class="shop-status">
<div class="shop-coins" id="rsl-coins">&#11088; 0 Stars</div>
<div class="shop-fame">Fame Level: <span id="rsl-fame-name">Basement Nobody</span></div>
<div class="fame-bar"><div class="fame-fill" id="rsl-fame-bar" style="width:0%"></div></div>
<div class="fame-label" id="rsl-fame-next">Next: Garage Rocker (5 items)</div>
</div>
<div class="band-preview" id="band-preview"></div>
<div class="shop-cat-bar" id="shop-cats"></div>
<div class="shop-grid" id="shop-grid"></div>
<div class="bg" style="margin-top:20px">
<button class="btn" onclick="returnFromShop()" style="font-size:1.1rem;padding:14px 36px" id="rsl-back-bottom">&#127926; BACK TO GAME</button>
<button class="btn btn2" onclick="showM()" style="padding:12px 28px">&#127968; Back to Menu</button>
</div>
</div>

<!-- GAME -->
<div id="gs" class="screen">
<div class="hud">
<div class="hi"><div class="hl">Score</div><div class="hv" id="hsc">0</div></div>
<div class="hi"><div class="hl">Moves</div><div class="hv" id="hmv">25</div></div>
<div class="hi"><div class="hl">Target</div><div class="hv" id="htg">1000</div></div>
<div class="hi"><div class="hl">Combo</div><div class="hv" id="hco">0</div></div>
</div>
<div class="pc"><div class="pl" id="obj">Reach target score!</div><div class="pbg"><div class="pb" id="prb" style="width:0%">0%</div></div></div>
<div class="dc"><div class="cp" id="dcp">&#127928;</div><div class="dco"><div class="dcn" id="dcn">Jake</div><div class="dct" id="dctx">"Let's see what you got!"</div></div></div>
<div id="obar" class="ob" style="display:none">&#128230; Crates: <b id="rc">0</b> &nbsp; &#128268; Cables: <b id="cc">0</b></div>
<div class="ingame-links">
<a href="https://x-raystarband.net/" target="_blank">&#127760; Web</a>
<a href="https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi" target="_blank">&#127925; Spotify</a>
<a href="https://youtube.com/playlist?list=PLd1uZNELj91lcc_vY2wqcmCd9OqVxs0-d" target="_blank">&#9654; YouTube</a>
<a href="https://www.facebook.com/XRayStarband" target="_blank">&#128218; FB</a>
<a href="https://www.redbubble.com/shop/ap/172252421" target="_blank">&#128085; Merch</a>
</div>
<div class="goal-tracker" id="goal-tracker" onclick="showRSL()" style="display:none"></div>
<div class="bonus-bar" id="bonus-bar"></div>
<div class="combo-meter"><div class="combo-fill" id="combo-fill" style="width:0%"></div></div>
<div class="obj-banner" id="obj-banner"></div>
<div class="tile-legend">
<div class="tile-legend-item"><div class="tile-legend-dot tl-gem">&#9889;</div>Gem=bonus pts</div>
<div class="tile-legend-item"><div class="tile-legend-dot tl-amp">&#128266;</div>Amp: SWAP it to clear row+col!</div>
<div class="tile-legend-item"><div class="tile-legend-dot tl-xr">&#9733;</div>XRay: SWAP to blast row+col!</div>
<div class="tile-legend-item"><div class="tile-legend-dot tl-rs">&#11088;</div>Star: SWAP to clear all of a type!</div>
<div class="tile-legend-item"><div class="tile-legend-dot tl-road">&#128230;</div>Crate: match next to it!</div>
<div class="tile-legend-item"><div class="tile-legend-dot tl-cable">&#128268;</div>Cable: match next to it!</div>
</div>
<div id="gb"></div>
<div class="bg"><button class="btn btn2 bs" onclick="showLS()">&#127968; Quit Level</button></div>
</div>
</div>
<script>
// ===================== SPARKLES =====================
!function(){var s=document.getElementById('spk');for(var i=0;i<40;i++){var d=document.createElement('div');d.className='sparkle';d.style.left=Math.random()*100+'%';d.style.top=Math.random()*100+'%';d.style.animationDelay=Math.random()*3+'s';s.appendChild(d)}}();

// ===================== AUDIO ENGINE =====================
var AC=null,AO=true;
function iA(){if(!AC)try{AC=new(window.AudioContext||window.webkitAudioContext)}catch(e){AO=false}if(AC&&AC.state==='suspended')AC.resume()}
function tgA(){AO=!AO;var b=document.getElementById('at');b.textContent=AO?'\u{1F50A}':'\u{1F507}';b.classList.toggle('mu',!AO)}
function P(type){if(!AO||!AC)return;try{var t=AC.currentTime,o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(AC.destination);switch(type){
case'm':o.type='triangle';o.frequency.setValueAtTime(523,t);o.frequency.exponentialRampToValueAtTime(784,t+.1);g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);break;
case'c':o.type='sawtooth';o.frequency.setValueAtTime(330,t);o.frequency.exponentialRampToValueAtTime(1320,t+.3);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);o.start(t);o.stop(t+.35);break;
case'g':o.type='sine';o.frequency.setValueAtTime(880,t);o.frequency.exponentialRampToValueAtTime(1760,t+.15);g.gain.setValueAtTime(.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.3);o.start(t);o.stop(t+.3);break;
case'x':o.type='sawtooth';o.frequency.setValueAtTime(220,t);o.frequency.exponentialRampToValueAtTime(1760,t+.4);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.5);o.start(t);o.stop(t+.5);break;
case's':o.type='sine';o.frequency.setValueAtTime(600,t);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.08);break;
case'w':o.type='triangle';o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(600,t+.1);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12);break;
case'b':o.type='square';o.frequency.setValueAtTime(200,t);g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15);break;
case'W':[523,659,784,1047].forEach(function(f,i){var x=AC.createOscillator(),y=AC.createGain();x.connect(y);y.connect(AC.destination);x.type='triangle';x.frequency.setValueAtTime(f,t+i*.12);y.gain.setValueAtTime(.12,t+i*.12);y.gain.exponentialRampToValueAtTime(.001,t+i*.12+.4);x.start(t+i*.12);x.stop(t+i*.12+.4)});g.gain.setValueAtTime(0,t);o.start(t);o.stop(t+.01);break;
case'L':o.type='sawtooth';o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(100,t+.5);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.6);o.start(t);o.stop(t+.6);break;
case'o':o.type='square';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(80,t+.15);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);break;
default:g.gain.setValueAtTime(0,t);o.start(t);o.stop(t+.01)}}catch(e){}}

// ===================== BGM ENGINE =====================
var bgmPlaying=false,bgmIntensity=0,bgmTimer,bgmVisTimer;
// (old rock BGM removed - replaced by Neon Horizon below)
function stopBGM(){bgmPlaying=false;clearTimeout(bgmTimer);clearInterval(bgmVisTimer);document.getElementById('bgm-bar').innerHTML=''}

// ===================== "NEON HORIZON"  SYNTHWAVE BGM ENGINE =====================
// Key: Am | Tempo: 108 BPM | Style: Gary Numan  Depeche Mode  Cosmic Darkwave
// Chord progression: Am  F  C  G (i  VI  III  VII)

// --- Frequency table (A minor scale) ---
var NT={
    A2:110, B2:123.5, C3:130.8, D3:146.8, E3:164.8, F3:174.6, G3:196,
    A3:220, B3:246.9, C4:261.6, D4:293.7, E4:329.6, F4:349.2, G4:392,
    A4:440, B4:493.9, C5:523.3, D5:587.3, E5:659.3, F5:698.5, G5:784,
    A5:880
};

// Chord voicings (root, third, fifth, seventh)
var CHORDS=[
    [NT.A2, NT.A3, NT.C4, NT.E4],  // Am
    [NT.F3, NT.A3, NT.C4, NT.F4],  // F
    [NT.C3, NT.G3, NT.C4, NT.E4],  // C
    [NT.G3, NT.B3, NT.D4, NT.G4]   // G
];

// The signature hook: descending motif E5D5C5B4A4
var HOOK=[NT.E5, NT.D5, NT.C5, NT.B4, NT.A4];

// Arp patterns per chord (16th note sequences)
var ARP_PATTERNS=[
    [NT.A4, NT.C5, NT.E5, NT.C5, NT.A4, NT.E4, NT.C5, NT.E5],  // Am
    [NT.F4, NT.A4, NT.C5, NT.A4, NT.F4, NT.C4, NT.A4, NT.C5],  // F
    [NT.C4, NT.E4, NT.G4, NT.E4, NT.C5, NT.G4, NT.E4, NT.G4],  // C
    [NT.G4, NT.B4, NT.D5, NT.B4, NT.G4, NT.D4, NT.B4, NT.D5]   // G
];

// Bass patterns (root movement with octave jumps)
var BASS_PATTERNS=[
    [NT.A2, 0, NT.A3, 0, NT.A2, NT.A2, NT.A3, 0],       // Am - pulsing
    [NT.F3, 0, NT.F3*2, 0, NT.F3, NT.F3, NT.F3*2, 0],   // F
    [NT.C3, 0, NT.C3*2, 0, NT.C3, NT.C3, NT.C3*2, 0],   // C
    [NT.G3, 0, NT.G3*2, 0, NT.G3, NT.G3, NT.G3*2, 0]    // G
];

// --- Synth voice functions ---

function neonPad(t, freq, vol, dur) {
    // Dual detuned sawtooth through lowpass  warm analog pad
    if(!AC||!AO)return;try{
    var o1=AC.createOscillator(),o2=AC.createOscillator(),o3=AC.createOscillator();
    var g=AC.createGain(),f=AC.createBiquadFilter();
    o1.type='sawtooth'; o2.type='sawtooth'; o3.type='triangle';
    o1.frequency.setValueAtTime(freq,t);
    o2.frequency.setValueAtTime(freq*1.003,t);     // Detune for width
    o3.frequency.setValueAtTime(freq*0.998,t);     // Sub layer
    f.type='lowpass';
    // Filter opens with intensity
    f.frequency.setValueAtTime(600+bgmIntensity*150,t);
    f.Q.setValueAtTime(1.5,t);
    o1.connect(f);o2.connect(f);o3.connect(f);f.connect(g);g.connect(AC.destination);
    g.gain.setValueAtTime(0,t);
    g.gain.linearRampToValueAtTime(vol,t+0.08);
    g.gain.setValueAtTime(vol*0.85,t+dur*0.3);
    g.gain.linearRampToValueAtTime(0.001,t+dur);
    o1.start(t);o1.stop(t+dur);o2.start(t);o2.stop(t+dur);o3.start(t);o3.stop(t+dur);
    }catch(e){}
}

function dmBass(t, freq, vol, dur) {
    // Depeche Mode bass: square+saw through resonant LP with envelope
    if(!AC||!AO||!freq)return;try{
    var o1=AC.createOscillator(),o2=AC.createOscillator();
    var g=AC.createGain(),f=AC.createBiquadFilter();
    o1.type='square'; o2.type='sawtooth';
    o1.frequency.setValueAtTime(freq,t);
    o2.frequency.setValueAtTime(freq*1.001,t);
    f.type='lowpass';
    f.frequency.setValueAtTime(600,t);
    f.frequency.exponentialRampToValueAtTime(120,t+dur*0.8);
    f.Q.setValueAtTime(6,t); // Resonant sweep
    o1.connect(f);o2.connect(f);f.connect(g);g.connect(AC.destination);
    g.gain.setValueAtTime(vol,t);
    g.gain.setValueAtTime(vol*0.9,t+dur*0.3);
    g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o1.start(t);o1.stop(t+dur);o2.start(t);o2.stop(t+dur);
    }catch(e){}
}

function crystalArp(t, freq, vol, dur) {
    // Bright crystalline arp  triangle through bandpass with fast decay
    if(!AC||!AO)return;try{
    var o=AC.createOscillator(),g=AC.createGain(),f=AC.createBiquadFilter();
    o.type='triangle';
    o.frequency.setValueAtTime(freq,t);
    f.type='bandpass';f.frequency.setValueAtTime(freq*2,t);f.Q.setValueAtTime(2,t);
    o.connect(f);f.connect(g);g.connect(AC.destination);
    g.gain.setValueAtTime(0,t);
    g.gain.linearRampToValueAtTime(vol,t+0.005);
    g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o.start(t);o.stop(t+dur);
    }catch(e){}
}

function numanLead(t, freq, vol, dur) {
    // Gary Numan lead: sawtooth with portamento, vibrato, resonant filter
    if(!AC||!AO)return;try{
    var o=AC.createOscillator(),g=AC.createGain(),f=AC.createBiquadFilter();
    var lfo=AC.createOscillator(),lfoG=AC.createGain();
    o.type='sawtooth';
    o.frequency.setValueAtTime(freq*0.98,t); // Start slightly flat
    o.frequency.linearRampToValueAtTime(freq,t+0.06); // Portamento glide up
    lfo.frequency.setValueAtTime(5.5,t);
    lfoG.gain.setValueAtTime(freq*0.008,t); // Subtle vibrato
    lfo.connect(lfoG);lfoG.connect(o.frequency);
    f.type='lowpass';
    f.frequency.setValueAtTime(1800+bgmIntensity*400,t);
    f.Q.setValueAtTime(4,t);
    o.connect(f);f.connect(g);g.connect(AC.destination);
    g.gain.setValueAtTime(0,t);
    g.gain.linearRampToValueAtTime(vol,t+0.015);
    g.gain.setValueAtTime(vol*0.7,t+dur*0.6);
    g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o.start(t);o.stop(t+dur);lfo.start(t);lfo.stop(t+dur);
    }catch(e){}
}

function gateSnare(t, vol) {
    // 80s gated reverb snare  the signature sound
    if(!AC||!AO)return;try{
    var len=0.18;
    var buf=AC.createBuffer(1,AC.sampleRate*len,AC.sampleRate);
    var d=buf.getChannelData(0);
    for(var i=0;i<d.length;i++){
        var env=Math.exp(-i/(AC.sampleRate*0.06));
        var gate=i<AC.sampleRate*len*0.75?1:Math.max(0,1-(i-AC.sampleRate*len*0.75)/(AC.sampleRate*0.01));
        d[i]=(Math.random()*2-1)*env*gate;
    }
    var s=AC.createBufferSource(),g=AC.createGain(),f=AC.createBiquadFilter();
    s.buffer=buf;
    f.type='bandpass';f.frequency.setValueAtTime(1500,t);f.Q.setValueAtTime(0.8,t);
    s.connect(f);f.connect(g);g.connect(AC.destination);
    g.gain.setValueAtTime(vol,t);s.start(t);
    // Add tonal body
    var o=AC.createOscillator(),g2=AC.createGain();
    o.type='triangle';o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(80,t+0.05);
    o.connect(g2);g2.connect(AC.destination);g2.gain.setValueAtTime(vol*0.4,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.06);
    o.start(t);o.stop(t+0.1);
    }catch(e){}
}

function kick808(t, vol) {
    if(!AC||!AO)return;try{
    var o=AC.createOscillator(),g=AC.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(160,t);
    o.frequency.exponentialRampToValueAtTime(35,t+0.15);
    o.connect(g);g.connect(AC.destination);
    g.gain.setValueAtTime(vol,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.35);
    o.start(t);o.stop(t+0.35);
    // Click transient
    var o2=AC.createOscillator(),g2=AC.createGain();
    o2.type='square';o2.frequency.setValueAtTime(1200,t);
    o2.connect(g2);g2.connect(AC.destination);
    g2.gain.setValueAtTime(vol*0.3,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.01);
    o2.start(t);o2.stop(t+0.02);
    }catch(e){}
}

function hat(t, vol, open) {
    if(!AC||!AO)return;try{
    var len=open?0.12:0.03;
    var buf=AC.createBuffer(1,AC.sampleRate*len,AC.sampleRate);
    var d=buf.getChannelData(0);
    for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/(AC.sampleRate*(open?0.04:0.008)));
    var s=AC.createBufferSource(),g=AC.createGain(),f=AC.createBiquadFilter();
    s.buffer=buf;f.type='highpass';f.frequency.setValueAtTime(9000,t);
    s.connect(f);f.connect(g);g.connect(AC.destination);g.gain.setValueAtTime(vol,t);s.start(t);
    }catch(e){}
}

// Old function aliases for compatibility
function playDrm(t,f,v,d){kick808(t,v)}
function playSnr(t,v,d){gateSnare(t,v)}
function playHH(t,v,d){hat(t,v,false)}
function playBs(t,f,v,d){dmBass(t,f,v,d)}
function playGt(t,f,v,d){crystalArp(t,f,v,d)}

// ===================== BGM MAIN LOOP: "NEON HORIZON" =====================
var bgmChordIdx=0; // Tracks which chord we're on in the progression

function startBGM(){
    if(bgmPlaying||!AO)return;iA();if(!AC)return;bgmPlaying=true;
    bgmChordIdx=0;
    function loop(){
        if(!bgmPlaying||!AO)return;
        try{
        var stage=G.cl<=5?1:G.cl<=10?2:G.cl<=15?3:G.cl<=20?4:G.cl<=25?5:6;
        var mood=Math.min(7,bgmIntensity);
        var I=Math.max(stage,mood); // Intensity 0-7
        var bpm=108; // Fixed tempo for groove consistency
        var bl=60/bpm; var t=AC.currentTime;
        var ci=bgmChordIdx%4; // Current chord index
        var chord=CHORDS[ci];
        var bass=BASS_PATTERNS[ci];
        var arp=ARP_PATTERNS[ci];
        var V=0.55+I*0.06; // Master volume

        // ========== LAYER 1: DRUMS (always present) ==========

        // Kick: four-on-the-floor
        kick808(t, .10*V);
        kick808(t+bl*1, .05*V); // Ghost kick
        kick808(t+bl*2, .10*V);
        kick808(t+bl*3, .04*V);
        // Extra syncopation at high intensity
        if(I>=5) kick808(t+bl*1.5, .06*V);
        if(I>=7) kick808(t+bl*3.5, .05*V);

        // Gated snare on 2 and 4
        gateSnare(t+bl*1, .06*V);
        gateSnare(t+bl*3, .06*V);
        if(I>=4) gateSnare(t+bl*2.75, .025*V); // Ghost

        // Hi-hats: 8ths at base, 16ths when intense
        for(var i=0;i<4;i++){
            hat(t+bl*i, .018*V, false);
            hat(t+bl*i+bl/2, .012*V, false);
            if(I>=3) hat(t+bl*i+bl/4, .006*V, false);
            if(I>=6) hat(t+bl*i+bl*3/4, .004*V, false);
        }
        // Open hat on the "and" of 4
        if(I>=2) hat(t+bl*3+bl/2, .02*V, true);

        // ========== LAYER 2: BASS (always present) ==========
        for(var i=0;i<8;i++){
            if(bass[i]) dmBass(t+bl*i/2, bass[i], .035*V, bl/2*0.85);
        }

        // ========== LAYER 3: PAD (intensity 1+) ==========
        if(I>=1){
            var pv=.006+I*.0015;
            neonPad(t, chord[0], pv*V, bl*4); // Root
            neonPad(t, chord[2], pv*V*.7, bl*4); // Fifth
            if(I>=3) neonPad(t, chord[3], pv*V*.5, bl*4); // Seventh
        }

        // ========== LAYER 4: ARPEGGIATOR (intensity 2+) ==========
        if(I>=2){
            var av=.010+I*.003;
            for(var i=0;i<8;i++){
                var noteTime=t+bl*i/2;
                crystalArp(noteTime, arp[i], av*V, bl/2*0.6);
                // Double at higher octave when intense
                if(I>=5) crystalArp(noteTime, arp[i]*2, av*V*.3, bl/2*0.4);
            }
        }

        // ========== LAYER 5: SIGNATURE HOOK (intensity 4+) ==========
        // The descending motif: E5D5C5B4A4
        if(I>=4 && ci===0){ // Play on the Am chord (every 4 bars)
            var hv=.007+(I-4)*.003;
            for(var i=0;i<HOOK.length;i++){
                numanLead(t+bl*i*0.7, HOOK[i], hv*V, bl*0.65);
            }
        }
        // Counter melody on other chords
        if(I>=5 && ci===2){ // On the C chord
            numanLead(t, NT.G5, .006*V, bl*1.5);
            numanLead(t+bl*2, NT.E5, .006*V, bl*1.5);
        }

        // ========== LAYER 6: SUB BASS (intensity 5+) ==========
        if(I>=5){
            dmBass(t, chord[0]/2, .02*V, bl*2);
            dmBass(t+bl*2, chord[0]/2, .02*V, bl*2);
        }

        // ========== LAYER 7: ANTHEM MODE (intensity 7) ==========
        if(I>=7){
            // Full chord stabs
            neonPad(t, chord[1]*2, .008*V, bl*2);
            neonPad(t+bl*2, chord[3]*2, .008*V, bl*2);
            // High arp doubled
            for(var i=0;i<4;i++){
                crystalArp(t+bl*i, arp[i%arp.length]*4, .004*V, bl*.3);
            }
            // Lead answer phrase (ascending)
            numanLead(t+bl*.5, NT.A4, .005*V, bl*.6);
            numanLead(t+bl*1.5, NT.C5, .005*V, bl*.6);
            numanLead(t+bl*2.5, NT.E5, .005*V, bl*.6);
            numanLead(t+bl*3.5, NT.A5, .006*V, bl*1);
        }

        bgmChordIdx++; // Advance chord progression
        }catch(e){}
        bgmTimer=setTimeout(loop,bl*4*1000-50);
    }
    loop();
    // Visualizer
    var bar=document.getElementById('bgm-bar');bar.innerHTML='';
    for(var i=0;i<30;i++){bar.appendChild(document.createElement('div'))}
    bgmVisTimer=setInterval(function(){try{var mood=Math.min(7,bgmIntensity);document.querySelectorAll('.bgm-bar div').forEach(function(b){b.style.height=Math.random()*(2+mood*1.5)+'px'});document.getElementById('bgm-bar').classList.toggle('intense',mood>=4)}catch(e){}},100);
}
function stopBGM(){bgmPlaying=false;clearTimeout(bgmTimer);clearInterval(bgmVisTimer);document.getElementById('bgm-bar').innerHTML=''}

var SV={
lespaul:'<svg class="ts" viewBox="0 0 100 100"><ellipse cx="50" cy="55" rx="22" ry="28" fill="url(#sb)" stroke="#654321" stroke-width="1.5"/><defs><radialGradient id="sb"><stop offset="0%" stop-color="#8B4513"/><stop offset="50%" stop-color="#D2691E"/><stop offset="100%" stop-color="#654321"/></radialGradient></defs><rect x="46" y="15" width="8" height="35" fill="#654321" rx="2"/><path d="M46,12L46,15L54,15L54,12Q50,10,46,12Z" fill="#654321"/><circle cx="48" cy="13" r="1.5" fill="#C0C0C0"/><circle cx="52" cy="13" r="1.5" fill="#C0C0C0"/><rect x="42" y="65" width="16" height="3" fill="#C0C0C0" rx="1"/><rect x="44" y="55" width="12" height="4" fill="#2C1810" stroke="#000" stroke-width=".5"/><line x1="48" y1="15" x2="48" y2="68" stroke="#C8C8C8" stroke-width=".3"/><line x1="50" y1="15" x2="50" y2="68" stroke="#C8C8C8" stroke-width=".3"/><line x1="52" y1="15" x2="52" y2="68" stroke="#C8C8C8" stroke-width=".3"/></svg>',
flyingv:'<svg class="ts" viewBox="0 0 100 100"><path d="M50,25L35,70L45,85L50,87L55,85L65,70Z" fill="#111" stroke="#222" stroke-width="1.5"/><rect x="48" y="10" width="4" height="20" fill="#654321" rx="1"/><path d="M47,8L47,11L53,11L53,8Q50,6,47,8Z" fill="#654321"/><circle cx="48.5" cy="9" r="1" fill="#C0C0C0"/><circle cx="51.5" cy="9" r="1" fill="#C0C0C0"/><rect x="46" y="50" width="8" height="3" fill="#FFD700" stroke="#000" stroke-width=".5"/><line x1="49" y1="11" x2="49" y2="82" stroke="#C8C8C8" stroke-width=".3"/><line x1="51" y1="11" x2="51" y2="82" stroke="#C8C8C8" stroke-width=".3"/></svg>',
strat:'<svg class="ts" viewBox="0 0 100 100"><path d="M35,45Q30,50,30,58Q30,70,40,75L60,75Q70,70,70,58Q70,50,65,45Z" fill="#4169E1" stroke="#1E40AF" stroke-width="1.5"/><rect x="47" y="12" width="6" height="32" fill="#C19A6B" rx="2"/><path d="M46,10L46,13L54,13L54,10Q50,8,46,10Z" fill="#C19A6B"/><circle cx="47" cy="11" r="1" fill="#C0C0C0"/><circle cx="53" cy="11" r="1" fill="#C0C0C0"/><path d="M45,45L43,48L42,60L45,72L52,72L52,45Z" fill="#fff" opacity=".7"/><rect x="46" y="52" width="8" height="2" fill="#000" rx="1"/><rect x="46" y="58" width="8" height="2" fill="#000" rx="1"/><rect x="46" y="64" width="8" height="2" fill="#000" rx="1"/><line x1="49" y1="13" x2="49" y2="73" stroke="#C8C8C8" stroke-width=".3"/><line x1="51" y1="13" x2="51" y2="73" stroke="#C8C8C8" stroke-width=".3"/></svg>',
pbass:'<svg class="ts" viewBox="0 0 100 100"><path d="M32,50Q28,55,28,62Q28,72,38,78L62,78Q72,72,72,62Q72,55,68,50Z" fill="#0F4C81" stroke="#084170" stroke-width="1.5"/><rect x="47" y="10" width="6" height="38" fill="#4A2511" rx="2"/><path d="M46,8L46,11L54,11L54,8Q50,6,46,8Z" fill="#4A2511"/><circle cx="47" cy="9.5" r="1" fill="#C0C0C0"/><circle cx="53" cy="9.5" r="1" fill="#C0C0C0"/><rect x="44" y="58" width="5" height="3" fill="#2C1810"/><rect x="51" y="61" width="5" height="3" fill="#2C1810"/><rect x="44" y="72" width="12" height="3" fill="#C0C0C0" rx="1"/><line x1="48" y1="11" x2="48" y2="74" stroke="#C8C8C8" stroke-width=".5"/><line x1="50" y1="11" x2="50" y2="74" stroke="#C8C8C8" stroke-width=".5"/><line x1="52" y1="11" x2="52" y2="74" stroke="#C8C8C8" stroke-width=".5"/></svg>',
ludwig:'<svg class="ts" viewBox="0 0 100 100"><ellipse cx="50" cy="70" rx="28" ry="10" fill="#8B0000" stroke="#5a0000" stroke-width="2"/><rect x="22" y="60" width="56" height="15" fill="#A52A2A" stroke="#5a0000" stroke-width="2"/><ellipse cx="50" cy="60" rx="28" ry="10" fill="#DC143C" stroke="#5a0000" stroke-width="2"/><circle cx="50" cy="65" r="6" fill="#FFD700" stroke="#000" stroke-width=".5"/><text x="50" y="67" font-size="4" fill="#000" text-anchor="middle" font-weight="bold">L</text><ellipse cx="68" cy="50" rx="12" ry="4" fill="#DC143C"/><ellipse cx="35" cy="38" rx="10" ry="3" fill="#DC143C"/><ellipse cx="50" cy="41" rx="11" ry="3.5" fill="#E8E8E8"/><ellipse cx="22" cy="26" rx="12" ry="3" fill="#FFA500" opacity=".8"/><line x1="22" y1="28" x2="22" y2="48" stroke="#404040" stroke-width="1.5"/><ellipse cx="75" cy="23" rx="15" ry="4" fill="#FFA500" opacity=".85"/><ellipse cx="32" cy="16" rx="13" ry="3.5" fill="#FFA500" opacity=".85"/></svg>',
sm58:'<svg class="ts" viewBox="0 0 100 100"><ellipse cx="50" cy="32" rx="18" ry="22" fill="url(#gr)" stroke="#606060" stroke-width="1.5"/><defs><radialGradient id="gr"><stop offset="0%" stop-color="#B0B0B0"/><stop offset="50%" stop-color="#808080"/><stop offset="100%" stop-color="#606060"/></radialGradient></defs><circle cx="50" cy="32" r="16" fill="none" stroke="#505050" stroke-width=".3" opacity=".5"/><circle cx="50" cy="32" r="10" fill="none" stroke="#505050" stroke-width=".3" opacity=".5"/><ellipse cx="50" cy="50" rx="12" ry="3" fill="#505050"/><rect x="42" y="50" width="16" height="30" fill="url(#bd)" rx="2"/><defs><linearGradient id="bd" x1="0%" x2="100%"><stop offset="0%" stop-color="#2a2a2a"/><stop offset="50%" stop-color="#404040"/><stop offset="100%" stop-color="#2a2a2a"/></linearGradient></defs><rect x="42" y="58" width="16" height="6" fill="#808080" rx="1"/><text x="50" y="62" font-size="3.5" fill="#fff" text-anchor="middle" font-weight="bold">SHURE</text><rect x="44" y="80" width="12" height="6" fill="#1a1a1a" rx="1"/><circle cx="50" cy="83" r="2" fill="#C0C0C0"/></svg>',
hammond:'<svg class="ts" viewBox="0 0 100 100"><rect x="20" y="35" width="60" height="35" fill="url(#wd)" rx="2"/><defs><linearGradient id="wd"><stop offset="0%" stop-color="#8B4513"/><stop offset="100%" stop-color="#654321"/></linearGradient></defs><rect x="20" y="32" width="60" height="3" fill="#4a2511"/><rect x="24" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="29" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="34" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="39" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="44" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="49" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="54" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="59" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="64" y="45" width="4" height="20" fill="#FAFAFA" stroke="#ddd" stroke-width=".5"/><rect x="26.5" y="45" width="3" height="12" fill="#1a1a1a"/><rect x="31.5" y="45" width="3" height="12" fill="#1a1a1a"/><rect x="41.5" y="45" width="3" height="12" fill="#1a1a1a"/><rect x="46.5" y="45" width="3" height="12" fill="#1a1a1a"/><rect x="51.5" y="45" width="3" height="12" fill="#1a1a1a"/><rect x="25" y="37" width="2" height="6" fill="#C0C0C0" rx="1"/><rect x="29" y="37" width="2" height="6" fill="#C0C0C0" rx="1"/><rect x="33" y="37" width="2" height="6" fill="#C0C0C0" rx="1"/><circle cx="60" cy="40" r="2" fill="#1a1a1a" stroke="#808080" stroke-width=".5"/><circle cx="66" cy="40" r="2" fill="#1a1a1a" stroke="#808080" stroke-width=".5"/></svg>',
vinyl:'<svg class="ts" viewBox="0 0 100 100"><circle cx="50" cy="50" r="35" fill="#1a0a1a" stroke="#0a0a0a" stroke-width="2"/><circle cx="50" cy="50" r="33" fill="none" stroke="#2a1a2a" stroke-width=".5" opacity=".6"/><circle cx="50" cy="50" r="27" fill="none" stroke="#2a1a2a" stroke-width=".5" opacity=".6"/><circle cx="50" cy="50" r="21" fill="none" stroke="#2a1a2a" stroke-width=".5" opacity=".6"/><circle cx="50" cy="50" r="15" fill="#8B008B"/><circle cx="50" cy="50" r="13" fill="#9932CC"/><circle cx="50" cy="50" r="11" fill="#BA55D3"/><circle cx="50" cy="50" r="4" fill="#1a1a1a" stroke="#000"/><text x="50" y="48" font-size="4" fill="#FFD700" text-anchor="middle" font-weight="bold">X-RAY</text><text x="50" y="53" font-size="4" fill="#FFD700" text-anchor="middle" font-weight="bold">STAR</text></svg>'
};
var OS={
roadie:'<svg class="ts" viewBox="0 0 100 100"><rect x="18" y="20" width="64" height="55" fill="#5c3a1e" stroke="#8B4513" stroke-width="2" rx="4"/><rect x="18" y="20" width="64" height="12" fill="#8B4513" rx="4"/><line x1="35" y1="20" x2="35" y2="75" stroke="#3a2210" stroke-width="1.5" opacity=".4"/><line x1="65" y1="20" x2="65" y2="75" stroke="#3a2210" stroke-width="1.5" opacity=".4"/><rect x="42" y="40" width="16" height="10" fill="#8B4513" stroke="#654321" rx="2"/><text x="50" y="88" font-size="9" fill="#ffd700" text-anchor="middle" font-weight="bold">ROADIE</text></svg>',
cable:'<svg class="ts" viewBox="0 0 100 100"><path d="M20,30Q30,20,40,35Q50,50,35,55Q20,60,30,75Q40,90,55,80Q70,70,60,55Q50,40,65,30Q80,20,80,40" fill="none" stroke="#2d5a2d" stroke-width="5" stroke-linecap="round"/><path d="M20,30Q30,20,40,35Q50,50,35,55Q20,60,30,75Q40,90,55,80Q70,70,60,55Q50,40,65,30Q80,20,80,40" fill="none" stroke="#55aa55" stroke-width="3" stroke-linecap="round"/><circle cx="20" cy="30" r="5" fill="#333" stroke="#555"/><circle cx="80" cy="40" r="5" fill="#333" stroke="#555"/><text x="50" y="93" font-size="8" fill="#55ff55" text-anchor="middle" font-weight="bold">CABLE</text></svg>'
};

var TY=['lespaul','flyingv','strat','pbass','ludwig','sm58','hammond','vinyl'];

// ===================== DIALOGUES (Spinal Tap x Steven Wright x Groucho x Monty Python) =====================
var DL={
start:[
{c:'Jake',p:'\u{1F3B8}',t:"I'd say we're ready. The guitar is in tune. Well, one string is."},
{c:'Maya',p:'\u{1F3B5}',t:"I used to be indecisive about bass lines. Now I'm not sure."},
{c:'Dave',p:'\u{1F941}',t:"My drum teacher said I had perfect timing. Then he checked his watch and left."},
{c:'Kat',p:'\u{1F3B9}',t:"I play keyboards. Plural. One for each hand. Revolutionary concept."},
{c:'Jake',p:'\u{1F3B8}',t:"Remember, these amps go to eleven. The landlord says that's the problem."},
{c:'Maya',p:'\u{1F3B5}',t:"This is our moment. Well, one of our moments. We have several."},
{c:'Dave',p:'\u{1F941}',t:"Rock and roll! Or at minimum, rock."},
{c:'Jake',p:'\u{1F3B8}',t:"Outside of a dog, a guitar is man's best friend. Inside of a dog, it's too dark to play."},
{c:'Dave',p:'\u{1F941}',t:"Nobody expects the rhythm section. Our chief weapon is surprise. And drums."},
{c:'Maya',p:'\u{1F3B5}',t:"I refuse to join any band that would have me as a member. And yet, here I am."},
{c:'Kat',p:'\u{1F3B9}',t:"This is a level. There are tiles. We match them. It's not exactly brain surgery, is it?"},
{c:'Jake',p:'\u{1F3B8}',t:"Time flies like an arrow. Fruit flies like a banana. Bass flies like Maya threw it."},
{c:'Dave',p:'\u{1F941}',t:"We are the knights who say... DRUM FILL."}
],
ml:[
{c:'Jake',p:'\u{1F3B8}',t:"We're running out of moves. Much like my dating life."},
{c:'Maya',p:'\u{1F3B5}',t:"I once lost a gig because I showed up on time. They didn't recognize me."},
{c:'Dave',p:'\u{1F941}',t:"The situation is deteriorating. Like our van's transmission."},
{c:'Kat',p:'\u{1F3B9}',t:"Statistically, this is still possible. I hate statistics."},
{c:'Jake',p:'\u{1F3B8}',t:"We need a miracle. Last time I said that, Dave set his cymbal on fire."},
{c:'Maya',p:'\u{1F3B5}',t:"I'm not saying it's hopeless. I'm just tuning my bass to a sad key."},
{c:'Jake',p:'\u{1F3B8}',t:"I've had a perfectly wonderful time playing this level. But this wasn't it."},
{c:'Maya',p:'\u{1F3B5}',t:"It's just a flesh wound. Metaphorically. The level is the wound. We are the flesh."},
{c:'Dave',p:'\u{1F941}',t:"Bring out your dead tiles! BRING OUT YOUR DEAD TILES!"},
{c:'Kat',p:'\u{1F3B9}',t:"We're not dead yet. I feel happy. I think I'll go for a walk."}
],
mg:[
{c:'Dave',p:'\u{1F941}',t:"We're halfway there. Which is further than we got on our last road trip."},
{c:'Jake',p:'\u{1F3B8}',t:"Looking good. Those are words no one has said about our tour van."},
{c:'Maya',p:'\u{1F3B5}',t:"Momentum is building. Like that noise the amp makes before it explodes."},
{c:'Kat',p:'\u{1F3B9}',t:"Solid progress. Reminds me of cheese. Cheese also ages well."},
{c:'Jake',p:'\u{1F3B8}',t:"Sound guy accidentally made us sound good. We should investigate."},
{c:'Jake',p:'\u{1F3B8}',t:"We're doing it. Whatever 'it' is. Nobody told me. I'm improvising."},
{c:'Maya',p:'\u{1F3B5}',t:"Progress! The last time I felt this good, I found a parking spot immediately."},
{c:'Dave',p:'\u{1F941}',t:"We're cooking with gas now. Figuratively. The actual gas got shut off."}
],
c3:[
{c:'Maya',p:'\u{1F3B5}',t:"Triple combo. That's three more than our audience last Tuesday."},
{c:'Dave',p:'\u{1F941}',t:"NICE. I felt that in my fillings."},
{c:'Jake',p:'\u{1F3B8}',t:"Three in a row! We once played three gigs in a row. Then we slept for a week."},
{c:'Kat',p:'\u{1F3B9}',t:"Mathematically beautiful. Like a well-tempered keyboard. Or pizza."},
{c:'Dave',p:'\u{1F941}',t:"That combo was tighter than my snare drum. And my jeans."},
{c:'Jake',p:'\u{1F3B8}',t:"Three! That's the same number of people who came to our first show. Beautiful."},
{c:'Kat',p:'\u{1F3B9}',t:"A triple! In music, three notes make a chord. In life, three chords make a career."},
{c:'Dave',p:'\u{1F941}',t:"Nobody expects a triple combo! Amongst our weaponry are fear, surprise, and drums."}
],
c5:[
{c:'Jake',p:'\u{1F3B8}',t:"FIVE COMBO. The cops are definitely coming."},
{c:'Dave',p:'\u{1F941}',t:"UNSTOPPABLE! Like my appetite at a free buffet!"},
{c:'Maya',p:'\u{1F3B5}',t:"That was so good I forgot we're playing in a basement."},
{c:'Jake',p:'\u{1F3B8}',t:"Okay now you're just showing off. I respect that. Deeply."},
{c:'Kat',p:'\u{1F3B9}',t:"If combos were currency, we could almost afford new strings."},
{c:'Dave',p:'\u{1F941}',t:"I just had an out-of-body experience. My body was drumming without me."},
{c:'Jake',p:'\u{1F3B8}',t:"FIVE! I wouldn't want to belong to any combo that would have fewer than five."},
{c:'Maya',p:'\u{1F3B5}',t:"We are no longer a band. We are a FORCE. A mildly employed force. But a force."},
{c:'Dave',p:'\u{1F941}',t:"FIVE COMBO! It's only a model. A very loud model."},
{c:'Kat',p:'\u{1F3B9}',t:"I have to say, this is getting rather silly. In the best possible way."}
],
win:[
{c:'Jake',p:'\u{1F3B8}',t:"Neighbors called the cops. The cops stayed for the encore."},
{c:'Maya',p:'\u{1F3B5}',t:"We won. I'd celebrate but the bass is heavier than my emotions."},
{c:'Dave',p:'\u{1F941}',t:"VICTORY! Now let's do that again but louder and with more feeling."},
{c:'Kat',p:'\u{1F3B9}',t:"Success. I'll add it to the list. The list is short but distinguished."},
{c:'Jake',p:'\u{1F3B8}',t:"Mom's fridge just got a new addition. Right next to my brother's PhD."},
{c:'Maya',p:'\u{1F3B5}',t:"Stream us on Spotify. We need groceries. And strings. Mostly strings."},
{c:'Dave',p:'\u{1F941}',t:"That was so good, my drum kit apologized for all the noise complaints."},
{c:'Jake',p:'\u{1F3B8}',t:"One step closer to Madison Square Garden. Currently we're near a garden center."},
{c:'Kat',p:'\u{1F3B9}',t:"Is this what winning feels like? It's warmer than I expected."},
{c:'Jake',p:'\u{1F3B8}',t:"I've been in the music biz so long I remember when the Dead Sea was just sick."},
{c:'Maya',p:'\u{1F3B5}',t:"We came, we saw, we matched tiles. Not exactly conquering, but it's a living."},
{c:'Dave',p:'\u{1F941}',t:"And there was much rejoicing. Yay."},
{c:'Kat',p:'\u{1F3B9}',t:"Some people say we got lucky. I say luck is preparation meeting a really good combo."},
{c:'Jake',p:'\u{1F3B8}',t:"That was beautiful. I'd quote something profound but I left my quote book in the van."},
{c:'Rick',p:'\u{1F527}',t:"Always look on the bright side of... wait, wrong band. But the sentiment stands."}
],
lose:[
{c:'Jake',p:'\u{1F3B8}',t:"We lost. My guitar weeps. Literally, the case has a leak."},
{c:'Maya',p:'\u{1F3B5}',t:"I'm not upset. I'm just going to sit here and hold my bass for a while."},
{c:'Dave',p:'\u{1F941}',t:"Defeat is temporary. My student loans, however, are not."},
{c:'Kat',p:'\u{1F3B9}',t:"We learn from failure. At this rate, we're getting an education."},
{c:'Jake',p:'\u{1F3B8}',t:"Even Hendrix had off days. Probably. I wasn't there. I'm speculating."},
{c:'Maya',p:'\u{1F3B5}',t:"Back to rehearsal. Which is just what we call sitting in Dave's garage."},
{c:'Dave',p:'\u{1F941}',t:"I once dropped a stick mid-solo. Nobody noticed. Nobody was watching."},
{c:'Jake',p:'\u{1F3B8}',t:"Rome wasn't built in a day. Neither was our set list. It took two days."},
{c:'Jake',p:'\u{1F3B8}',t:"It's not pining for the fjords. It's definitely deceased. The level, I mean."},
{c:'Maya',p:'\u{1F3B5}',t:"I once played a gig where the only audience member was a cat. The cat left early."},
{c:'Dave',p:'\u{1F941}',t:"This is an ex-level. It has ceased to be. It's joined the choir invisible."},
{c:'Kat',p:'\u{1F3B9}',t:"Tis but a scratch. We'll get them next time. Or the time after. Time is abundant."}
],
obs:[
{c:'Rick',p:'\u{1F527}',t:"Obstacle cleared. I charge extra for that but you seem nice."},
{c:'Jake',p:'\u{1F3B8}',t:"Cable crisis averted. That's my middle name. Jake Cable-Crisis Averted."},
{c:'Maya',p:'\u{1F3B5}',t:"Smashed it. The obstacle. Not my bass. I've done that too, but separately."},
{c:'Rick',p:'\u{1F527}',t:"Roadie work is 90% lifting things and 10% wondering why I lift things."},
{c:'Dave',p:'\u{1F941}',t:"Destroyed! Like my hearing. Worth it though."},
{c:'Rick',p:'\u{1F527}',t:"Obstacle eliminated. Like my social life when I became a roadie."},
{c:'Jake',p:'\u{1F3B8}',t:"Smashed it! We're experts at breaking things. Ask our landlord."},
{c:'Dave',p:'\u{1F941}',t:"DESTROYED! Sorry. I get excited. It's the caffeine. And the drums."}
],
xr:[
{c:'Jake',p:'\u{1F3B8}',t:"X-RAY VISION! I can see through walls. And also the futility of renting."},
{c:'Dave',p:'\u{1F941}',t:"MAXIMUM POWER! The electric bill is going to be fascinating."},
{c:'Maya',p:'\u{1F3B5}',t:"That was transcendent. Like my bass solo. Which nobody heard. Because bass."},
{c:'Kat',p:'\u{1F3B9}',t:"X-Ray activated. I see sound now. This is either amazing or concerning."},
{c:'Jake',p:'\u{1F3B8}',t:"PHENOMENAL COSMIC POWER! Itty bitty practice space."},
{c:'Maya',p:'\u{1F3B5}',t:"If music is the food of love, that X-Ray tile was a five-course meal."},
{c:'Dave',p:'\u{1F941}',t:"That was louder than our amp at eleven. And our amp goes to eleven."}
],
s1:[
{c:'Jake',p:'\u{1F3B8}',t:"Welcome to the basement. The ceiling is low but our dreams are slightly less low."},
{c:'Maya',p:'\u{1F3B5}',t:"Mom said keep it down. We're keeping it down. Down and heavy."},
{c:'Dave',p:'\u{1F941}',t:"Pizza rolls sustain life. That's not a band quote, that's a scientific fact."},
{c:'Jake',p:'\u{1F3B8}',t:"The basement has character. Mold is a character, right?"},
{c:'Dave',p:'\u{1F941}',t:"Fun fact: the basement floods every spring. We call it our indoor pool."}
],
s2:[
{c:'Maya',p:'\u{1F3B5}',t:"Twelve people showed up. TWELVE. If you count the barista, thirteen."},
{c:'Jake',p:'\u{1F3B8}',t:"The coffee shop said we could play if we each bought a latte. Fair deal."},
{c:'Dave',p:'\u{1F941}',t:"Someone in the audience is nodding. Either they like us or they're asleep."},
{c:'Kat',p:'\u{1F3B9}',t:"The coffee shop has a tip jar. Last gig we made four dollars. One was Canadian."},
{c:'Jake',p:'\u{1F3B8}',t:"Our name is on the chalkboard! Right under Oat Milk Latte. Equal billing!"}
]
};

// ===================== LEVELS =====================
var LV=[
{s:1,n:1,m:25,t:1000,r:0,cb:0},{s:1,n:2,m:25,t:1500,r:0,cb:0},{s:1,n:3,m:22,t:2000,r:0,cb:0},{s:1,n:4,m:22,t:2500,r:0,cb:0},
{s:1,n:5,m:20,t:3000,r:2,cb:0},{s:1,n:6,m:25,t:3500,r:2,cb:0},{s:1,n:7,m:22,t:4000,r:2,cb:1},{s:1,n:8,m:22,t:4500,r:3,cb:1},
{s:1,n:9,m:20,t:5000,r:3,cb:1},{s:1,n:10,m:25,t:5500,r:3,cb:2},{s:1,n:11,m:22,t:6000,r:4,cb:2},{s:1,n:12,m:22,t:6500,r:3,cb:2},
{s:1,n:13,m:20,t:7000,r:4,cb:2},{s:1,n:14,m:20,t:7500,r:4,cb:3},{s:1,n:15,m:25,t:8000,r:5,cb:3},
{s:2,n:16,m:25,t:9000,r:3,cb:2},{s:2,n:17,m:22,t:10000,r:4,cb:2},{s:2,n:18,m:22,t:11000,r:4,cb:3},{s:2,n:19,m:20,t:12000,r:4,cb:3},
{s:2,n:20,m:22,t:13000,r:5,cb:3},{s:2,n:21,m:25,t:14000,r:5,cb:3},{s:2,n:22,m:22,t:15000,r:5,cb:4},{s:2,n:23,m:22,t:16000,r:5,cb:4},
{s:2,n:24,m:20,t:17000,r:6,cb:4},{s:2,n:25,m:22,t:18000,r:6,cb:4},{s:2,n:26,m:25,t:19000,r:6,cb:4},{s:2,n:27,m:22,t:20000,r:6,cb:5},
{s:2,n:28,m:22,t:21000,r:7,cb:5},{s:2,n:29,m:20,t:22000,r:7,cb:5},{s:2,n:30,m:25,t:25000,r:8,cb:5}];
var SI={1:{t:'\u{1F3E0} Stage 1: Basement Dreamers',d:'"We\'re gonna be HUGE... someday."'},2:{t:'\u2615 Stage 2: Coffee Shop Circuit',d:'"That guy in the back clapped!"'}};

// ===================== CONTENT UNLOCKS =====================
var SONGS=[
{id:1,title:'Basement Anthem',artist:'X-Ray Star',unlock:1,url:'https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi',icon:'\u{1F3B8}'},
{id:2,title:'Pizza Roll Rock',artist:'X-Ray Star',unlock:5,url:'https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi',icon:'\u{1F355}'},
{id:3,title:'Neighbors Hate Us',artist:'X-Ray Star',unlock:10,url:'https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi',icon:'\u{1F3B5}'},
{id:4,title:'Garage Days',artist:'X-Ray Star',unlock:15,url:'https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi',icon:'\u{1F3B6}'},
{id:5,title:'Coffee Shop Blues',artist:'X-Ray Star',unlock:20,url:'https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi',icon:'\u2615'},
{id:6,title:'Twelve People Showed Up',artist:'X-Ray Star',unlock:25,url:'https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi',icon:'\u{1F389}'},
{id:7,title:'Road to Stardom',artist:'X-Ray Star',unlock:30,url:'https://open.spotify.com/artist/7kuG094aXgRmkgIOH9Tpdi',icon:'\u2B50'}];
var VIDS=[
{id:1,title:'First Rehearsal',unlock:3,url:'https://youtube.com/playlist?list=PLd1uZNELj91lcc_vY2wqcmCd9OqVxs0-d',icon:'\u{1F3AC}'},
{id:2,title:'Mom Heard Us on Radio',unlock:8,url:'https://youtube.com/playlist?list=PLd1uZNELj91lcc_vY2wqcmCd9OqVxs0-d',icon:'\u{1F4FB}'},
{id:3,title:'The Coffee Shop Gig',unlock:16,url:'https://youtube.com/playlist?list=PLd1uZNELj91lcc_vY2wqcmCd9OqVxs0-d',icon:'\u2615'},
{id:4,title:'Behind the Scenes',unlock:22,url:'https://youtube.com/playlist?list=PLd1uZNELj91lcc_vY2wqcmCd9OqVxs0-d',icon:'\u{1F3A5}'},
{id:5,title:'Live at the Basement',unlock:28,url:'https://youtube.com/playlist?list=PLd1uZNELj91lcc_vY2wqcmCd9OqVxs0-d',icon:'\u{1F399}'}];
var MERCH=[
{id:1,title:'X-Ray Star Logo Tee',unlock:7,url:'https://www.redbubble.com/shop/ap/172252421',icon:'\u{1F455}'},
{id:2,title:'Basement Dreamers Sticker',unlock:12,url:'https://www.redbubble.com/shop/ap/172252421',icon:'\u{1F4CB}'},
{id:3,title:'Tour Poster',unlock:18,url:'https://www.redbubble.com/shop/ap/172252421',icon:'\u{1F5BC}'},
{id:4,title:'Coffee Shop Circuit Hoodie',unlock:24,url:'https://www.redbubble.com/shop/ap/172252421',icon:'\u{1F9E5}'},
{id:5,title:'VIP All-Access Pass',unlock:30,url:'https://www.redbubble.com/shop/ap/172252421',icon:'\u{1F3AB}'}];
var ACHS=[
{id:'first',name:'First Jam',req:'Complete Level 1',icon:'\u{1F3B8}',check:function(){return G.dn[1]}},
{id:'combo3',name:'Triple Threat',req:'Get a 3x combo',icon:'\u{1F525}',check:function(){return(G.stats&&G.stats.maxCombo>=3)}},
{id:'combo5',name:'Rock God',req:'Get a 5x combo',icon:'\u26A1',check:function(){return(G.stats&&G.stats.maxCombo>=5)}},
{id:'combo10',name:'Legendary',req:'Get a 10x combo',icon:'\u{1F451}',check:function(){return(G.stats&&G.stats.maxCombo>=10)}},
{id:'s1done',name:'Basement Graduate',req:'Complete all Stage 1',icon:'\u{1F393}',check:function(){for(var i=1;i<=15;i++)if(!G.dn[i])return false;return true}},
{id:'s2done',name:'Coffee Shop Legend',req:'Complete all Stage 2',icon:'\u2615',check:function(){for(var i=16;i<=30;i++)if(!G.dn[i])return false;return true}},
{id:'stars50',name:'Star Collector',req:'Earn 50 total stars',icon:'\u2B50',check:function(){var s=0;for(var k in G.st)s+=G.st[k];return s>=50}},
{id:'stars90',name:'Perfect Run',req:'Earn 90 total stars',icon:'\u{1F31F}',check:function(){var s=0;for(var k in G.st)s+=G.st[k];return s>=90}},
{id:'match500',name:'Instrument Hoarder',req:'Match 500 tiles',icon:'\u{1F3B5}',check:function(){return(G.stats&&G.stats.totalMatches>=500)}},
{id:'match2k',name:'Match Master',req:'Match 2000 tiles',icon:'\u{1F3B6}',check:function(){return(G.stats&&G.stats.totalMatches>=2000)}},
{id:'obs50',name:'Roadie Wrecker',req:'Destroy 50 obstacles',icon:'\u{1F4A5}',check:function(){return(G.stats&&G.stats.obsDestroyed>=50)}},
{id:'xray20',name:'X-Ray Vision',req:'Use 20 X-Ray tiles',icon:'\u{1F4AB}',check:function(){return(G.stats&&G.stats.xrayUsed>=20)}},
{id:'daily5',name:'Dedicated Fan',req:'5 daily challenges',icon:'\u{1F4C5}',check:function(){return(G.stats&&G.stats.dailyDone>=5)}},
{id:'score100k',name:'High Roller',req:'100,000 total points',icon:'\u{1F4B0}',check:function(){return(G.stats&&G.stats.totalScore>=100000)}}];

// ===================== STATE =====================
var G={cl:1,sc:0,mv:25,tg:1000,co:0,bd:[],sl:null,pr:false,ht:null,dn:{},st:{},stats:null,achEarned:{},isDaily:false};
var hintsOn=true,idleTimer,surpriseChance=0;

function initStats(){if(!G.stats)G.stats={maxCombo:0,totalMatches:0,obsDestroyed:0,xrayUsed:0,totalScore:0,dailyDone:0,highScores:[],lastDaily:''}}

function ld(){try{var d=JSON.parse(localStorage.getItem('xrs5'));if(d){G.cl=d.a||1;G.dn=d.b||{};G.st=d.c||{};G.stats=d.d||null;G.achEarned=d.e||{}}}catch(e){}initStats()}
function sv(){try{localStorage.setItem('xrs5',JSON.stringify({a:G.cl,b:G.dn,c:G.st,d:G.stats,e:G.achEarned}))}catch(e){}}

// ===================== SCREENS =====================
function showS(id){document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});document.getElementById(id).classList.add('active')}
function showM(){stopBGM();showS('ms')}
function showLS(){
    stopBGM();
    var st=G.cl<=15?1:2,i=SI[st];
    document.getElementById('stt').textContent=i.t;document.getElementById('std').textContent=i.d;
    var g=document.getElementById('lgr');g.innerHTML='';
    LV.forEach(function(l){
        var b=document.createElement('button');b.className='lb';b.textContent=l.n;
        if(G.dn[l.n]){b.classList.add('done');var sd=document.createElement('div');sd.className='lbs';sd.textContent='\u2B50'.repeat(G.st[l.n]||1);b.appendChild(sd)}
        if(l.n===G.cl)b.classList.add('cur');
        if(l.n!==1&&!G.dn[l.n-1])b.disabled=true;
        else b.onclick=function(){strt(l.n)};
        g.appendChild(b);
    });
    showS('ls');
}

// ===================== TUTORIAL =====================
var tutStep=0;
function tut(){
    var steps=[
        {icon:'\u{1F3B8}',title:'Step 1: Match Instruments',text:'Tap two adjacent tiles to swap them. Match 3 or more of the same instrument to score points!'},
        {icon:'\u{1F48E}',title:'Step 2: Gems & Specials',text:'<b>Gem tiles</b> (gold glow) = 3x points!<br><b>Match 4</b> creates an AMP tile (clears cross).<br><b>Match 5+</b> creates a ROCKSTAR tile (clears all of one type)!'},
        {icon:'\u2B50',title:'Step 3: X-Ray Star Power',text:'The rainbow X-Ray Star tile clears its entire row AND column! Massive points!'},
        {icon:'\u{1F4E6}',title:'Step 4: Obstacles',text:'Roadie Boxes need 2 hits and Tangled Cables need 3 hits. Match instruments NEXT TO them to break them!'},
        {icon:'\u{1F525}',title:'Step 5: Combos & Surprises',text:'Chain matches for combo multipliers! Watch for surprise events like Gem Showers and Encores!'},
        {icon:'\u{1F3C6}',title:'Step 6: Unlock Content',text:'Beat levels to unlock X-Ray Star songs, videos, and merch in the Backstage area! Tap the links to listen/watch/shop!'},
        {icon:'\u{1F918}',title:'Ready to Rock!',text:'Earn 1-3 stars per level. Try the Daily Challenge. Check your Achievements. Now go make some noise!'}
    ];
    tutStep=0;
    function showStep(){
        document.querySelectorAll('.tut-overlay').forEach(function(o){o.remove()});
        if(tutStep>=steps.length)return;
        var s=steps[tutStep];
        var ov=document.createElement('div');ov.className='tut-overlay';
        ov.innerHTML='<div class="tut-box"><div class="tut-step">'+s.icon+' '+s.title+' ('+(tutStep+1)+'/'+steps.length+')</div><div class="tut-arrow">'+s.icon+'</div><div class="tut-text">'+s.text+'</div><button class="btn bs" style="margin:0">'+(tutStep<steps.length-1?'Next \u{27A1}':'LET\'S ROCK! \u{1F918}')+'</button></div>';
        ov.querySelector('.btn').onclick=function(){tutStep++;showStep()};
        ov.onclick=function(e){if(e.target===ov){tutStep++;showStep()}};
        document.body.appendChild(ov);
    }
    showStep();
}

// ===================== TILE CREATION =====================
function mT(){var r=Math.random();if(r<.04)return{ty:'xray',sp:'xray'};if(r<.14)return{ty:TY[Math.floor(Math.random()*TY.length)],sp:'gem'};
// Bias toward existing types for more natural combos
if(r<.34){var counts={};G.bd.forEach(function(t){if(t&&t.ty&&t.ty!=='obstacle'&&t.ty!=='xray')counts[t.ty]=(counts[t.ty]||0)+1});var types=Object.keys(counts);if(types.length>0){types.sort(function(a,b){return counts[b]-counts[a]});return{ty:types[Math.floor(Math.random()*Math.min(3,types.length))],sp:null}}}
return{ty:TY[Math.floor(Math.random()*TY.length)],sp:null}}

function rT(el,d){
    if(!d){el.innerHTML='';el.className='t';el.dataset.type='';return}
    el.className='t';el.dataset.type=d.ty;
    if(d.ty==='obstacle'){el.innerHTML=OS[d.ob];el.classList.add(d.ob==='roadie'?'or':'oc');var hp=document.createElement('div');hp.className='ohp';hp.innerHTML='\u2764\uFE0F'+d.hp;el.appendChild(hp);return}
    el.innerHTML=SV[d.ty]||'';
    if(d.sp==='gem')el.classList.add('gem');
    if(d.sp==='amp'){el.classList.add('amp');var ar=document.createElement('div');ar.className='amp-arrow h';ar.textContent='\u2194';el.appendChild(ar)}
    if(d.sp==='rstar')el.classList.add('rstar');
    if(d.sp==='xray'){el.classList.add('xr');el.innerHTML='<div class="ts" style="font-family:Archivo Black,sans-serif;font-size:1.1rem">XR\u2605</div>'}
}
function uT(i){rT(document.querySelectorAll('.t')[i],G.bd[i])}

// ===================== BOARD SETUP =====================
function mkB(lv){
    var b=document.getElementById('gb');b.innerHTML='';G.bd=[];
    for(var i=0;i<36;i++)G.bd.push(mT());
    var tot=(lv.r||0)+(lv.cb||0);
    if(tot>0){var c=[];for(var i=0;i<36;i++)c.push(i);for(var i=c.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=c[i];c[i]=c[j];c[j]=tmp}
    var ri=0,ci=0;for(var i=0;i<c.length&&(ri+ci)<tot;i++){if(ri<(lv.r||0)){G.bd[c[i]]={ty:'obstacle',ob:'roadie',hp:2};ri++}else if(ci<(lv.cb||0)){G.bd[c[i]]={ty:'obstacle',ob:'cable',hp:3};ci++}}}
    for(var i=0;i<36;i++){var el=document.createElement('div');el.className='t';el.dataset.index=i;rT(el,G.bd[i]);(function(idx){el.onclick=function(){if(_lastTouchTime&&Date.now()-_lastTouchTime<500)return;ck(idx)}})(i);b.appendChild(el)}
    cI();uOC();
}
function cI(){var m=fM(),it=0;while(m.length>0&&it<100){var fl=[];m.forEach(function(a){a.forEach(function(x){fl.push(x)})});fl.forEach(function(i){if(G.bd[i]&&G.bd[i].ty!=='obstacle'){G.bd[i]=mT();uT(i)}});m=fM();it++}}
function gN(i){var r=Math.floor(i/6),c=i%6,res=[];if(r>0)res.push((r-1)*6+c);if(r<5)res.push((r+1)*6+c);if(c>0)res.push(r*6+(c-1));if(c<5)res.push(r*6+(c+1));return res}

// ===================== OBSTACLE DAMAGE (consolidated) =====================
function dO(matched){
    var adj={},obsBefore=0;G.bd.forEach(function(t){if(t&&t.ty==='obstacle')obsBefore++});
    matched.forEach(function(i){gN(i).forEach(function(n){if(G.bd[n]&&G.bd[n].ty==='obstacle')adj[n]=true})});
    Object.keys(adj).forEach(function(oi){
        oi=parseInt(oi);var o=G.bd[oi];o.hp--;var el=document.querySelectorAll('.t')[oi];
        el.classList.add('ock');setTimeout(function(){el.classList.remove('ock')},400);P('o');
        if(o.hp<=0){G.bd[oi]=mT();uT(oi);var rc=el.getBoundingClientRect();ptc(rc.left+rc.width/2,rc.top+rc.height/2,'\u{1F4A5}',8);scp(rc.left+rc.width/2,rc.top+rc.height/2,500);G.sc+=500;dlg('obs')}
        else{var hp=el.querySelector('.ohp');if(hp)hp.textContent=o.hp}
    });
    uOC();
    var obsAfter=0;G.bd.forEach(function(t){if(t&&t.ty==='obstacle')obsAfter++});
    G.stats.obsDestroyed=(G.stats.obsDestroyed||0)+(obsBefore-obsAfter);
}
function uOC(){var r=0,c=0;G.bd.forEach(function(t){if(t&&t.ty==='obstacle'){if(t.ob==='roadie')r++;else c++}});document.getElementById('rc').textContent=r;document.getElementById('cc').textContent=c}
function aOC(){return!G.bd.some(function(t){return t&&t.ty==='obstacle'})}

// ===================== CLICK & SWAP (consolidated) =====================
function ck(i){
    if(G.pr)return;if(G.bd[i]&&G.bd[i].ty==='obstacle')return;
    iA();cH();if(hintsOn)sH();clearTimeout(idleTimer);startIdleQuips();
    var tiles=document.querySelectorAll('.t');
    if(G.sl===null){G.sl=i;tiles[i].classList.add('sel');P('s')}
    else if(G.sl===i){tiles[i].classList.remove('sel');G.sl=null}
    else if(isA(G.sl,i)){var i1=G.sl;tiles[i1].classList.remove('sel');sw(i1,i);G.sl=null}
    else{tiles[G.sl].classList.remove('sel');G.sl=i;tiles[i].classList.add('sel');P('s')}
}
function isA(a,b){var r1=Math.floor(a/6),c1=a%6,r2=Math.floor(b/6),c2=b%6;return(Math.abs(r1-r2)===1&&c1===c2)||(Math.abs(c1-c2)===1&&r1===r2)}

function sw(a,b){
    var tA=G.bd[a],tB=G.bd[b];
    // Check for special tile activations
    var aA=(tA&&tA.sp==='amp'),bA=(tB&&tB.sp==='amp');
    var aR=(tA&&tA.sp==='rstar'),bR=(tB&&tB.sp==='rstar');
    if(aA||bA||aR||bR){
        var tmp=G.bd[a];G.bd[a]=G.bd[b];G.bd[b]=tmp;uT(a);uT(b);
        G.mv--;G.pr=true;P('w');uH();
        if(aR||bR){var ri=aR?a:b,oi=aR?b:a;var tt=G.bd[oi]?G.bd[oi].ty:null;setTimeout(function(){actRstar(ri,tt)},150)}
        else{var ai=aA?a:b;setTimeout(function(){actAmp(ai)},150)}
        return;
    }
    // Normal swap
    var tmp=G.bd[a];G.bd[a]=G.bd[b];G.bd[b]=tmp;uT(a);uT(b);
    var m=fM(),hx=(G.bd[a]&&G.bd[a].ty==='xray')||(G.bd[b]&&G.bd[b].ty==='xray');
    if(m.length>0||hx){G.mv--;G.pr=true;P('w');uH();if(hx)setTimeout(function(){doX(G.bd[a]&&G.bd[a].ty==='xray'?a:b)},150);else setTimeout(function(){proc(m)},150)}
    else{tmp=G.bd[a];G.bd[a]=G.bd[b];G.bd[b]=tmp;uT(a);uT(b);P('b')}
}

// ===================== MATCH DETECTION =====================
function fM(){
    var m=[],p={};
    for(var row=0;row<6;row++)for(var col=0;col<4;col++){
        var i=row*6+col,t=G.bd[i];if(!t||t.ty==='xray'||t.ty==='obstacle')continue;
        var len=1;for(var c=col+1;c<6;c++){var n=G.bd[row*6+c];if(n&&n.ty===t.ty&&n.ty!=='xray'&&n.ty!=='obstacle')len++;else break}
        if(len>=3){var mt=[];for(var c=col;c<col+len;c++){var mi=row*6+c;if(!p[mi]){mt.push(mi);p[mi]=true}}if(mt.length>=3)m.push(mt)}}
    for(var col=0;col<6;col++)for(var row=0;row<4;row++){
        var i=row*6+col,t=G.bd[i];if(!t||t.ty==='xray'||t.ty==='obstacle')continue;
        var len=1;for(var r=row+1;r<6;r++){var n=G.bd[r*6+col];if(n&&n.ty===t.ty&&n.ty!=='xray'&&n.ty!=='obstacle')len++;else break}
        if(len>=3){var mt=[];for(var r=row;r<row+len;r++){var mi=r*6+col;if(!p[mi]){mt.push(mi);p[mi]=true}}if(mt.length>=3)m.push(mt)}}
    return m;
}

// ===================== PROCESS MATCHES (consolidated: stats, specials, streaks, screen shake, BGM, gem flash) =====================
var streakMsgs=['','','','TRIPLE!','QUAD!','PENTA!','INSANE!','GODLIKE!','LEGENDARY!','IMPOSSIBLE!','TRANSCENDENT!'];

function proc(matches){
    G.co++;initStats();
    // Count matches for stats
    var count=0;matches.forEach(function(mt){count+=mt.length});
    G.stats.totalMatches=(G.stats.totalMatches||0)+count;
    if(G.co>G.stats.maxCombo)G.stats.maxCombo=G.co;

    // Check for 4+ and 5+ matches to create specials
    var specials=[];
    matches.forEach(function(mt){
        if(mt.length===4)specials.push({idx:mt[1],type:'amp'});
        else if(mt.length>=5)specials.push({idx:mt[2],type:'rstar'});
    });

    var total=0,tiles=document.querySelectorAll('.t'),allM=[],hasGem=false;
    matches.forEach(function(mt){mt.forEach(function(i){var t=G.bd[i];if(!t)return;total+=(t.sp==='gem'?300:100)*G.co;tiles[i].classList.add('mtch');allM.push(i);if(t.sp==='gem'){P('g');hasGem=true}})});
    G.sc+=total;P(G.co>=3?'c':'m');
    if(hasGem)flashScreen();
    var fi=matches[0][0],rc=tiles[fi].getBoundingClientRect();
    scp(rc.left+rc.width/2,rc.top+rc.height/2,total);ptc(rc.left+rc.width/2,rc.top+rc.height/2,'\u{1F525}',8);
    if(G.co>=5)dlg('c5');else if(G.co>=3)dlg('c3');
    dO(allM);uH();
    // Screen shake
    if(G.co>=5){document.getElementById('gb').classList.add('shake-big');setTimeout(function(){document.getElementById('gb').classList.remove('shake-big')},600)}
    else if(G.co>=3){document.getElementById('gb').classList.add('shake');setTimeout(function(){document.getElementById('gb').classList.remove('shake')},400)}
    // Streak popup
    if(G.co>=3&&G.co<=10){var msg=streakMsgs[G.co]||'EPIC!';var sp=document.createElement('div');sp.className='streak-pop';sp.textContent=msg;document.body.appendChild(sp);setTimeout(function(){sp.remove()},1500)}
    // BGM intensity
    // Let mood system handle bgmIntensity - just set combo floor
var _comboFloor=Math.min(5,G.co);if(_comboFloor>bgmIntensity)bgmIntensity=_comboFloor;

    allM.forEach(function(i){G.bd[i]=null});
    setTimeout(function(){grav();setTimeout(function(){refill();
        // Place specials after refill
        if(specials.length>0){specials.forEach(function(sp){if(G.bd[sp.idx]){G.bd[sp.idx]={ty:G.bd[sp.idx].ty,sp:sp.type};uT(sp.idx);showToast(sp.type==='amp'?'\u{1F50A} AMP Tile Created!':'\u2B50 ROCKSTAR Tile Created!')}})}
        setTimeout(chk,180)},180)},220);
}

// ===================== SPECIAL ACTIVATIONS =====================
function doX(i){
    P('x');dlg('xr');initStats();G.stats.xrayUsed=(G.stats.xrayUsed||0)+1;
    var row=Math.floor(i/6),col=i%6,td=[];
    for(var x=0;x<6;x++){td.push(row*6+x);td.push(x*6+col)}
    var u=[],seen={};td.forEach(function(v){if(!seen[v]){seen[v]=true;u.push(v)}});
    var sc=u.length*150;G.sc+=sc;
    var tiles=document.querySelectorAll('.t'),rc=tiles[i].getBoundingClientRect();
    scp(rc.left+rc.width/2,rc.top+rc.height/2,sc);ptc(rc.left+rc.width/2,rc.top+rc.height/2,'\u2B50',12);
    document.getElementById('gb').classList.add('shake-big');setTimeout(function(){document.getElementById('gb').classList.remove('shake-big')},600);
    u.forEach(function(j){if(G.bd[j]&&G.bd[j].ty==='obstacle'){G.bd[j].hp--;if(G.bd[j].hp<=0){G.bd[j]=null;G.sc+=500}else{uT(j)}}
    else if(G.bd[j]){tiles[j].classList.add('mtch');G.bd[j]=null}});
    uH();uOC();setTimeout(function(){grav();setTimeout(function(){refill();setTimeout(chk,180)},180)},220);
}

function actAmp(idx){
    P('x');dlg('c5');var row=Math.floor(idx/6),col=idx%6,td=[];
    for(var i=0;i<6;i++){td.push(row*6+i);td.push(i*6+col)}
    var u=[],seen={};td.forEach(function(v){if(!seen[v]){seen[v]=true;u.push(v)}});
    var sc=u.length*200;G.sc+=sc;
    var tiles=document.querySelectorAll('.t'),rc=tiles[idx].getBoundingClientRect();
    scp(rc.left+rc.width/2,rc.top+rc.height/2,sc);ptc(rc.left+rc.width/2,rc.top+rc.height/2,'\u{1F50A}',10);
    document.getElementById('gb').classList.add('shake');setTimeout(function(){document.getElementById('gb').classList.remove('shake')},400);
    u.forEach(function(j){if(G.bd[j]&&G.bd[j].ty==='obstacle'){G.bd[j].hp--;if(G.bd[j].hp<=0){G.bd[j]=null;G.sc+=500}else uT(j)}else if(G.bd[j]){tiles[j].classList.add('mtch');G.bd[j]=null}});
    uH();uOC();setTimeout(function(){grav();setTimeout(function(){refill();setTimeout(chk,180)},180)},220);
}

function actRstar(idx,targetType){
    P('x');P('c');dlg('c5');var sc=0,tiles=document.querySelectorAll('.t'),dest=[];
    for(var i=0;i<36;i++){if(G.bd[i]&&G.bd[i].ty===targetType){sc+=250;tiles[i].classList.add('mtch');dest.push(i);var rc=tiles[i].getBoundingClientRect();ptc(rc.left+rc.width/2,rc.top+rc.height/2,'\u2B50',3)}}
    if(G.bd[idx]){tiles[idx].classList.add('mtch');dest.push(idx)}
    G.sc+=sc;var rc2=tiles[idx].getBoundingClientRect();scp(rc2.left+rc2.width/2,rc2.top+rc2.height/2,sc);
    document.getElementById('gb').classList.add('shake-big');setTimeout(function(){document.getElementById('gb').classList.remove('shake-big')},600);
    dest.forEach(function(i){G.bd[i]=null});uH();uOC();
    setTimeout(function(){grav();setTimeout(function(){refill();setTimeout(chk,180)},180)},220);
}

// ===================== GRAVITY & REFILL =====================
function grav(){for(var c=0;c<6;c++){var col=[];for(var r=0;r<6;r++){var t=G.bd[r*6+c];if(t)col.push(t)}for(var r=5;r>=0;r--){G.bd[r*6+c]=col.pop()||null;uT(r*6+c)}}}
function refill(){var tiles=document.querySelectorAll('.t');for(var i=0;i<36;i++){if(!G.bd[i]){G.bd[i]=mT();uT(i);tiles[i].classList.add('fall');(function(idx){setTimeout(function(){tiles[idx].classList.remove('fall')},350)})(i)}}}

// ===================== CHECK CONTINUE (consolidated: win/lose, surprises) =====================
function chk(){
    var m=fM();if(m.length>0){proc(m);return}
    G.co=0;G.pr=false;uH();document.getElementById('combo-fill').style.width='0%';
    var lv=LV[G.cl-1]||{r:0,cb:0},ho=G.isDaily||((lv.r||0)+(lv.cb||0)>0),oc=aOC();
    if(ho){if(G.sc>=G.tg&&oc)wn();else if(G.mv<=0)ls();else{if(G.mv<=5&&(G.sc<G.tg*.7||!oc))dlg('ml');else if(G.sc>=G.tg*.5)dlg('mg');if(hintsOn)sH()}}
    else{if(G.sc>=G.tg)wn();else if(G.mv<=0)ls();else{if(G.mv<=5&&G.sc<G.tg*.7)dlg('ml');else if(G.sc>=G.tg*.5)dlg('mg');if(hintsOn)sH()}}
    if(!G.pr&&G.mv>0&&!fPM())shuf();
    // Surprise events
    surpriseChance+=0.02;
    if(!G.pr&&Math.random()<surpriseChance&&G.mv>3){
        surpriseChance=0;
        var events=[
        function(){var no=[];for(var i=0;i<36;i++)if(G.bd[i]&&!G.bd[i].sp&&G.bd[i].ty!=='obstacle'&&G.bd[i].ty!=='xray')no.push(i);for(var j=0;j<Math.min(3,no.length);j++){var ri=Math.floor(Math.random()*no.length);var idx=no.splice(ri,1)[0];G.bd[idx].sp='gem';uT(idx)}showToast('\u{1F48E} GEM SHOWER!');flashScreen();dlgC('Jake','\u{1F3B8}','Free gems! Like finding money in your stage pants.')},
        function(){G.mv+=3;uH();showToast('\u{1F3B5} ENCORE! +3 moves!');flashScreen();dlgC('Dave','\u{1F941}','The crowd demands an encore!')},
        function(){var b=500+Math.floor(Math.random()*1000);G.sc+=b;uH();showToast('\u{1F4B0} TIP JAR! +'+b+' pts!');flashScreen();dlgC('Maya','\u{1F3B5}','Someone tipped us '+b+' points. Rent is saved. Briefly.')},
        function(){var no=[];for(var i=0;i<36;i++)if(G.bd[i]&&!G.bd[i].sp&&G.bd[i].ty!=='obstacle'&&G.bd[i].ty!=='xray')no.push(i);if(no.length>0){var idx=no[Math.floor(Math.random()*no.length)];G.bd[idx]={ty:'xray',sp:'xray'};uT(idx);showToast('\u2B50 X-RAY STAR appeared!');flashScreen();dlgC('Kat','\u{1F3B9}','A wild X-Ray tile appears. Statistically improbable. I love it.')}}
        ];events[Math.floor(Math.random()*events.length)]();
    }
}

function shuf(){var no=[],op=[];for(var i=0;i<36;i++){if(G.bd[i]&&G.bd[i].ty==='obstacle')op.push(i);else if(G.bd[i])no.push(G.bd[i])}for(var i=no.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=no[i];no[i]=no[j];no[j]=tmp}var ni=0;for(var i=0;i<36;i++){if(op.indexOf(i)===-1){G.bd[i]=no[ni++]||mT();uT(i)}}cI();ntf('\u{1F504} No moves! Shuffling...',2000,false)}

// ===================== HINTS =====================
function sH(){cH();G.ht=setTimeout(function(){if(!G.pr)shH()},3000)}
function cH(){document.querySelectorAll('.t.hint,.t.hint-from,.t.hint-to').forEach(function(t){t.classList.remove('hint','hint-from','hint-to')});document.querySelectorAll('.hint-arrow').forEach(function(a){a.remove()});if(G.ht){clearTimeout(G.ht);G.ht=null}}
function shH(){var h=fPM();if(h){var tiles=document.querySelectorAll('.t');h.forEach(function(idx){tiles[idx].classList.add('hint')})}}
function fPM(){for(var i=0;i<36;i++){if(!G.bd[i]||G.bd[i].ty==='obstacle')continue;for(var j=i+1;j<36;j++){if(!G.bd[j]||G.bd[j].ty==='obstacle')continue;if(isA(i,j)){// Check if either tile is a special (amp/rockstar/xray) - always a valid move
var iSp=G.bd[i]&&(G.bd[i].sp==='amp'||G.bd[i].sp==='rstar'||G.bd[i].ty==='xray');
var jSp=G.bd[j]&&(G.bd[j].sp==='amp'||G.bd[j].sp==='rstar'||G.bd[j].ty==='xray');
if(iSp||jSp)return[i,j];
var tmp=G.bd[i];G.bd[i]=G.bd[j];G.bd[j]=tmp;var m=fM();tmp=G.bd[i];G.bd[i]=G.bd[j];G.bd[j]=tmp;if(m.length>0)return[i,j]}}}return null}

// ===================== WIN (consolidated) =====================
function wn(){
    initStats();stopBGM();spawnConfetti();cH();P('W');
    G.stats.totalScore=(G.stats.totalScore||0)+G.sc;
    if(!G.stats.highScores)G.stats.highScores=[];
    G.stats.highScores.push({level:G.isDaily?'Daily':G.cl,score:G.sc,date:new Date().toLocaleDateString()});
    if(G.stats.highScores.length>20)G.stats.highScores=G.stats.highScores.sort(function(a,b){return b.score-a.score}).slice(0,20);
    if(G.isDaily){G.stats.dailyDone=(G.stats.dailyDone||0)+1;G.stats.lastDaily=new Date().toDateString();G.isDaily=false;sv();showWinOv('Daily Challenge Complete!',G.sc,3,'','');checkUnlocks(0);return}
    var stars=G.sc>=G.tg*1.5?3:G.sc>=G.tg*1.2?2:1;
    G.dn[G.cl]=true;G.st[G.cl]=Math.max(stars,G.st[G.cl]||0);
    if(G.cl<LV.length)G.cl++;sv();dlg('win');
    var ex='',lv=G.cl-1;if(lv===15)ex='\u2615 STAGE 2 UNLOCKED!';if(lv===30)ex='\u{1F389} ALL 30 LEVELS COMPLETE!';
    var ul='';SONGS.forEach(function(s){if(s.unlock===lv)ul+='\u{1F3B5} '+s.title+'\n'});VIDS.forEach(function(v){if(v.unlock===lv)ul+='\u{1F3AC} '+v.title+'\n'});MERCH.forEach(function(m){if(m.unlock===lv)ul+='\u{1F6D2} '+m.title+'\n'});
    showWinOv('Level '+lv+' Complete!',G.sc,stars,ex,ul);checkUnlocks(lv);
}

function showWinOv(title,score,stars,extra,unlocks){
    var ov=document.createElement('div');ov.className='win-overlay';
    var sh='\u2B50'.repeat(stars)+'\u2606'.repeat(3-stars);
    var nextLvl=G.cl; // G.cl already incremented by wn()
    var hasNext=nextLvl<=LV.length;
    var isDaily=title.indexOf('Daily')>=0;
    
    var btns='';
    if(isDaily){
        btns='<button class="btn bs" onclick="this.closest(\'.win-overlay\').remove();showM()">\u{1F3E0} Menu</button>';
        btns+='<button class="btn btn2 bs" onclick="this.closest(\'.win-overlay\').remove();showBK()">\u{1F3A4} Backstage</button>';
    } else if(hasNext){
        btns='<button class="btn bs" style="font-size:1.1rem;padding:14px 36px" onclick="this.closest(\'.win-overlay\').remove();strt('+nextLvl+')">\u{27A1}\uFE0F NEXT LEVEL</button>';
        btns+='<br><button class="btn btn2 bs" onclick="this.closest(\'.win-overlay\').remove();strt('+(nextLvl-1)+')">\u{1F504} Play Again</button>';
        btns+=' <button class="btn btn2 bs" onclick="this.closest(\'.win-overlay\').remove();showLS()">\u{1F4CB} Levels</button>';
        btns+=' <button class="btn btn2 bs" onclick="this.closest(\'.win-overlay\').remove();showBK()">\u{1F3A4} Backstage</button>';
    } else {
        btns='<button class="btn bs" onclick="this.closest(\'.win-overlay\').remove();showBK()">\u{1F3A4} Backstage</button>';
        btns+=' <button class="btn btn2 bs" onclick="this.closest(\'.win-overlay\').remove();showLS()">\u{1F4CB} Levels</button>';
    }
    
    ov.innerHTML='<div class="win-box">'
        +'<div style="font-family:Archivo Black,sans-serif;font-size:1.4rem;color:#ffd700">\u{1F389} '+title+'</div>'
        +'<div class="win-stars">'+sh+'</div>'
        +'<div class="win-score">'+score.toLocaleString()+' pts</div>'
        +(extra?'<div class="win-msg" style="color:#ffd700">'+extra+'</div>':'')
        +(unlocks?'<div class="win-unlock">\u{1F513} UNLOCKED:<br>'+unlocks.replace(/\n/g,'<br>')+'</div>':'')
        +'<div class="win-btns" style="flex-direction:column;gap:8px">'+btns+'</div>'
        +'</div>';
    document.body.appendChild(ov);
}

// ===================== LOSE (consolidated) =====================
function ls(){
    stopBGM();cH();P('L');dlg('lose');
    var curLvl=G.isDaily?0:G.cl;
    setTimeout(function(){
        var ov=document.createElement('div');ov.className='win-overlay';
        ov.innerHTML='<div class="win-box">'
            +'<div style="font-family:Archivo Black,sans-serif;font-size:1.4rem;color:#ff4500">\u{1F605} Out of Moves!</div>'
            +'<div class="win-score" style="color:#fff">'+G.sc.toLocaleString()+' / '+G.tg.toLocaleString()+'</div>'
            +'<div class="win-msg">'+getEncouragement()+'</div>'
            +'<div class="win-btns" style="flex-direction:column;gap:8px">'
            +'<button class="btn bs" style="font-size:1.1rem;padding:14px 36px" onclick="this.closest(\'.win-overlay\').remove();strt('+curLvl+')">\u{1F504} TRY AGAIN</button>'
            +'<br><button class="btn btn2 bs" onclick="this.closest(\'.win-overlay\').remove();showLS()">\u{1F4CB} Levels</button>'
            +' <button class="btn btn2 bs" onclick="this.closest(\'.win-overlay\').remove();showM()">\u{1F3E0} Menu</button>'
            +'</div></div>';
        document.body.appendChild(ov);
    },800);
}

function getEncouragement(){
    var pct=G.tg>0?G.sc/G.tg:0;
    if(pct>=0.9)return "SO CLOSE! You were at "+Math.round(pct*100)+"%! One more try!";
    if(pct>=0.7)return "Almost there! Try building bigger combos.";
    if(pct>=0.5)return "Good progress! Focus on matching near the obstacles.";
    return "Look for chain reactions \u2014 match at the bottom for cascading combos!";
}

// ===================== HUD =====================
function uH(){document.getElementById('hsc').textContent=G.sc.toLocaleString();document.getElementById('hmv').textContent=G.mv;document.getElementById('htg').textContent=G.tg.toLocaleString();document.getElementById('hco').textContent=G.co;var p=Math.min(100,(G.sc/G.tg)*100);var pb=document.getElementById('prb');pb.style.width=p+'%';pb.textContent=Math.round(p)+'%'}
function dlg(type){var d=DL[type];if(!d)return;var x=d[Math.floor(Math.random()*d.length)];document.getElementById('dcp').textContent=x.p;document.getElementById('dcn').textContent=x.c;document.getElementById('dctx').textContent='"'+x.t+'"'}
function dlgC(name,portrait,text){document.getElementById('dcp').textContent=portrait;document.getElementById('dcn').textContent=name;document.getElementById('dctx').textContent='"'+text+'"'}

// ===================== EFFECTS =====================
function scp(x,y,score){var p=document.createElement('div');p.className='scp';p.textContent='+'+score.toLocaleString();p.style.left=x+'px';p.style.top=y+'px';document.body.appendChild(p);setTimeout(function(){p.remove()},1200)}
function ptc(x,y,emoji,count){for(var i=0;i<count;i++){var p=document.createElement('div');p.className='ptc';p.textContent=emoji;p.style.left=x+'px';p.style.top=y+'px';var angle=(Math.PI*2*i)/count,dist=60+Math.random()*90;p.style.setProperty('--tx',Math.cos(angle)*dist+'px');p.style.setProperty('--ty',Math.sin(angle)*dist+'px');document.body.appendChild(p);setTimeout(function(el){return function(){el.remove()}}(p),1200)}}
function ntf(text,dur,isSt){document.querySelectorAll('.ntf').forEach(function(n){n.remove()});var n=document.createElement('div');n.className='ntf'+(isSt?' st':'');n.textContent=text;if(isSt)n.onclick=function(){n.remove()};document.body.appendChild(n);setTimeout(function(){if(n.parentNode)n.remove()},dur)}
function showToast(text){var t=document.createElement('div');t.className='unlock-toast';t.textContent=text;document.body.appendChild(t);setTimeout(function(){if(t.parentNode)t.remove()},4000)}
function flashScreen(){var f=document.createElement('div');f.className='surprise-flash';document.body.appendChild(f);setTimeout(function(){f.remove()},400)}
function spawnConfetti(){var colors=['#dc143c','#ffd700','#ff4500','#4169E1','#ff1493','#00ff88','#fff'];for(var i=0;i<40;i++){var c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'vw';c.style.top='-10px';c.style.background=colors[Math.floor(Math.random()*colors.length)];c.style.borderRadius=Math.random()>.5?'50%':'2px';c.style.width=(6+Math.random()*8)+'px';c.style.height=(6+Math.random()*8)+'px';c.style.animationDelay=(Math.random()*2)+'s';c.style.animationDuration=(2+Math.random()*2)+'s';document.body.appendChild(c);setTimeout(function(el){return function(){el.remove()}}(c),5000)}}

// ===================== LEVEL START (consolidated: intro animation, BGM, idle quips) =====================
function strt(n){
    if(n===0){startDaily();return}
    iA();var lv=LV[n-1];if(!lv)return;
    // Level intro animation
    var stageNames={1:'Basement Dreamers',2:'Coffee Shop Circuit'};
    var intro=document.createElement('div');intro.className='level-intro';
    intro.innerHTML='<div class="level-intro-num">'+n+'</div><div class="level-intro-name">'+(stageNames[lv.s]||'')+'</div>';
    document.body.appendChild(intro);
    setTimeout(function(){
        intro.style.opacity='0';intro.style.transition='opacity .5s';
        setTimeout(function(){
            intro.remove();
            G.cl=n;G.sc=0;G.mv=lv.m;G.tg=lv.t;G.co=0;G.sl=null;G.pr=false;G.isDaily=false;surpriseChance=0;
            showS('gs');
            var ho=(lv.r||0)+(lv.cb||0)>0;
            document.getElementById('obar').style.display=ho?'flex':'none';
            document.getElementById('obj').textContent=ho?'Score '+lv.t.toLocaleString()+' + Clear all crates & cables! (Match NEXT TO them to destroy!)':'Reach '+lv.t.toLocaleString()+' points!';
            uH();mkB(lv);var dk='s'+lv.s;if(DL[dk])dlg(dk);else dlg('start');if(hintsOn)sH();
            bgmIntensity=0;iA();if(AO)startBGM();startIdleQuips();
        },500);
    },1200);
}

// ===================== UNLOCK POPUPS WITH DIRECT LINKS =====================
function showUnlockDetail(icon,title,desc,url,urlLabel){
    var d=document.createElement('div');d.className='unlock-detail';
    d.innerHTML='<div class="unlock-detail-icon">'+icon+'</div><div class="unlock-detail-title">\u{1F513} '+title+'</div><div class="unlock-detail-desc">'+desc+'</div><a href="'+url+'" target="_blank" class="unlock-detail-link">'+urlLabel+'</a><br><span class="unlock-detail-close" onclick="this.parentNode.remove()">Maybe Later</span>';
    document.body.appendChild(d);setTimeout(function(){if(d.parentNode)d.remove()},8000);
}

function checkUnlocks(levelNum){
    var delay=800;
    SONGS.forEach(function(s){if(s.unlock===levelNum){setTimeout(function(){showUnlockDetail(s.icon,'Song: '+s.title,'Listen to "'+s.title+'" by X-Ray Star!',s.url,'\u{1F3B5} Listen on Spotify')},delay);delay+=2500}});
    VIDS.forEach(function(v){if(v.unlock===levelNum){setTimeout(function(){showUnlockDetail(v.icon,'Video: '+v.title,'Watch "'+v.title+'" on YouTube!',v.url,'\u25B6 Watch on YouTube')},delay);delay+=2500}});
    MERCH.forEach(function(m){if(m.unlock===levelNum){setTimeout(function(){showUnlockDetail(m.icon,'Merch: '+m.title,'Get the "'+m.title+'" from X-Ray Star!',m.url,'\u{1F6D2} Shop on Redbubble')},delay);delay+=2500}});
    ACHS.forEach(function(a){if(a.check()&&!(G.achEarned&&G.achEarned[a.id])){if(!G.achEarned)G.achEarned={};G.achEarned[a.id]=true;setTimeout(function(){showToast('\u{1F3C6} Achievement: '+a.name)},delay);delay+=1500}});
}

// ===================== GALLERY / BACKSTAGE =====================
function showBK(){renderGallery();showS('bks')}
function showTab(tab){document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active')});document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active')});document.getElementById('tab-'+tab).classList.add('active');var tabs=['songs','videos','merch','achs','scores'];document.querySelectorAll('.tab-btn')[tabs.indexOf(tab)].classList.add('active')}
function renderGallery(){
    var sg=document.getElementById('song-grid');sg.innerHTML='';SONGS.forEach(function(s){var un=G.dn[s.unlock]||G.cl>s.unlock;var c=document.createElement('div');c.className='gal-card'+(un?'':' locked');c.innerHTML='<span class="gal-icon">'+s.icon+'</span><div class="gal-title">'+s.title+'</div><div class="gal-desc">'+s.artist+'</div>'+(un?'<a href="'+s.url+'" target="_blank" class="gal-link">\u{1F3B5} Listen on Spotify</a>':'<div class="gal-desc" style="margin-top:6px">Unlock at Level '+s.unlock+'</div>');sg.appendChild(c)});
    var vg=document.getElementById('vid-grid');vg.innerHTML='';VIDS.forEach(function(v){var un=G.dn[v.unlock]||G.cl>v.unlock;var c=document.createElement('div');c.className='gal-card'+(un?'':' locked');c.innerHTML='<span class="gal-icon">'+v.icon+'</span><div class="gal-title">'+v.title+'</div>'+(un?'<a href="'+v.url+'" target="_blank" class="gal-link">\u25B6 Watch on YouTube</a>':'<div class="gal-desc" style="margin-top:6px">Unlock at Level '+v.unlock+'</div>');vg.appendChild(c)});
    var mg=document.getElementById('merch-grid');mg.innerHTML='';MERCH.forEach(function(m){var un=G.dn[m.unlock]||G.cl>m.unlock;var c=document.createElement('div');c.className='gal-card'+(un?'':' locked');c.innerHTML='<span class="gal-icon">'+m.icon+'</span><div class="gal-title">'+m.title+'</div>'+(un?'<a href="'+m.url+'" target="_blank" class="gal-link">\u{1F6D2} Shop on Redbubble</a>':'<div class="gal-desc" style="margin-top:6px">Unlock at Level '+m.unlock+'</div>');mg.appendChild(c)});
    renderAchs();renderHS();
}
function renderAchs(){var ag=document.getElementById('ach-grid');ag.innerHTML='';ACHS.forEach(function(a){var e=a.check();var c=document.createElement('div');c.className='ach-card'+(e?' earned':' locked');c.innerHTML='<span class="ach-icon">'+a.icon+'</span><div class="ach-name">'+a.name+'</div><div class="ach-req">'+(e?'\u2705 Complete!':a.req)+'</div>';ag.appendChild(c)})}
function renderHS(){var list=document.getElementById('hs-list');list.innerHTML='';var hs=(G.stats&&G.stats.highScores)||[];if(hs.length===0){list.innerHTML='<div style="text-align:center;padding:20px;color:#ff8c00">No high scores yet!</div>';return}hs.sort(function(a,b){return b.score-a.score});hs.slice(0,10).forEach(function(h,i){var li=document.createElement('li');li.className='hs-item';li.innerHTML='<span class="hs-rank">#'+(i+1)+'</span><span class="hs-level">Level '+h.level+'</span><span class="hs-score">'+h.score.toLocaleString()+'</span>';list.appendChild(li)})}

// ===================== SETTINGS =====================
function showSets(){showS('sets')}
function tgSfx(){AO=!AO;document.getElementById('stg-sfx').classList.toggle('on',AO);document.getElementById('at').textContent=AO?'\u{1F50A}':'\u{1F507}';document.getElementById('at').classList.toggle('mu',!AO)}
function tgHints(){hintsOn=!hintsOn;document.getElementById('stg-hints').classList.toggle('on',hintsOn);if(!hintsOn)cH()}
function resetAll(){if(confirm('Reset ALL progress? Cannot be undone!')){localStorage.removeItem('xrs5');G={cl:1,sc:0,mv:25,tg:1000,co:0,bd:[],sl:null,pr:false,ht:null,dn:{},st:{},stats:null,achEarned:{},isDaily:false};initStats();sv();showM();ntf('\u{1F504} Progress Reset!',2000,false)}}

// ===================== DAILY CHALLENGE =====================
function getDC(){var today=new Date();var seed=today.getFullYear()*10000+(today.getMonth()+1)*100+today.getDate();var r=function(){seed=(seed*16807)%2147483647;return(seed-1)/2147483646};var types=['Score Rush','Combo King','Clear the Stage','Tile Collector'];return{type:types[Math.floor(r()*types.length)],target:Math.floor(r()*15000)+8000,moves:Math.floor(r()*10)+15,roadies:Math.floor(r()*5)+2,cables:Math.floor(r()*3)+1}}
function showDaily(){var dc=getDC();var done=G.stats&&G.stats.lastDaily===new Date().toDateString();document.getElementById('dc-title').textContent='\u{1F525} '+dc.type;document.getElementById('dc-desc').textContent='Score '+dc.target.toLocaleString()+' in '+dc.moves+' moves with '+dc.roadies+' crates and '+dc.cables+' cables!';var btn=document.getElementById('dc-btn');if(done){btn.textContent='\u2705 COMPLETED TODAY';btn.disabled=true}else{btn.textContent='\u{1F525} PLAY CHALLENGE';btn.disabled=false}var now=new Date(),tmw=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1),diff=tmw-now;document.getElementById('dc-timer').textContent='New challenge in '+Math.floor(diff/3600000)+'h '+Math.floor((diff%3600000)/60000)+'m';showS('dcs')}
function startDaily(){iA();var dc=getDC();G.cl=0;G.sc=0;G.mv=dc.moves;G.tg=dc.target;G.co=0;G.sl=null;G.pr=false;G.isDaily=true;surpriseChance=0;showS('gs');document.getElementById('obar').style.display='flex';document.getElementById('obj').textContent='\u{1F525} DAILY: Score '+dc.target.toLocaleString()+' + Clear obstacles!';uH();mkB({r:dc.roadies,cb:dc.cables});dlg('start');if(hintsOn)sH();bgmIntensity=0;iA();if(AO)startBGM();startIdleQuips()}

// ===================== IDLE QUIPS =====================
function startIdleQuips(){clearTimeout(idleTimer);idleTimer=setTimeout(function(){if(!G.pr){var q=[
{c:'Jake',p:'\u{1F3B8}',t:"I'm just going to stand here and look cool. It's working, right?"},
{c:'Dave',p:'\u{1F941}',t:"I'm doing paradiddles while we wait. In my mind. My hands are tired."},
{c:'Maya',p:'\u{1F3B5}',t:"I wrote a song while waiting. It's one note. Very avant-garde."},
{c:'Kat',p:'\u{1F3B9}',t:"I've been holding this chord so long my fingers have filed a complaint."},
{c:'Rick',p:'\u{1F527}',t:"Need a hint? I know a guy. It's me. I'm the guy."},
{c:'Jake',p:'\u{1F3B8}',t:"Take your time. The rent isn't due for... oh wait, it was yesterday."},
{c:'Dave',p:'\u{1F941}',t:"I can play drums with my eyes closed. I can also miss drums with my eyes closed."},
{c:'Maya',p:'\u{1F3B5}',t:"Thinking is free. Unlike everything else in this industry."},
{c:'Kat',p:'\u{1F3B9}',t:"I spy with my little eye... tiles. There are tiles everywhere."},
{c:'Jake',p:'\u{1F3B8}',t:"This reminds me of that time I stared at a lava lamp for three hours. Productive."}
];var r=q[Math.floor(Math.random()*q.length)];dlgC(r.c,r.p,r.t)}startIdleQuips()},15000+Math.random()*10000)}

// ===================== INIT =====================
ld();

// ===================== POLISH: Near-win excitement =====================
var _origUH = uH;
uH = function() {
    _origUH();
    // Near-win: board glows when score > 80% of target
    var pct = G.sc / G.tg;
    var gs = document.getElementById('gs');
    if (pct >= 0.8 && pct < 1) gs.classList.add('near-win');
    else gs.classList.remove('near-win');
    
    // Low moves warning
    if (G.mv <= 5 && G.mv > 0) gs.classList.add('low-moves');
    else gs.classList.remove('low-moves');
    
    // Progress bar glow when close
    var pb = document.getElementById('prb');
    if (pct >= 0.7) pb.classList.add('close');
    else pb.classList.remove('close');
    
    // Score tick animation
    var hsc = document.getElementById('hsc');
    hsc.classList.remove('score-tick');
    void hsc.offsetWidth; // Force reflow
    hsc.classList.add('score-tick');
};

// ===================== POLISH: Board entrance animation =====================
var _origMkB = mkB;
mkB = function(lv) {
    _origMkB(lv);
    var board = document.getElementById('gb');
    board.classList.add('board-enter');
    var tiles = board.querySelectorAll('.t');
    tiles.forEach(function(t, i) {
        t.style.animationDelay = (i * 0.02) + 's';
    });
    setTimeout(function() {
        board.classList.remove('board-enter');
        tiles.forEach(function(t) { t.style.animationDelay = '' });
    }, 1500);
};

// ===================== POLISH: Milestone celebrations =====================
var _origProc2 = proc;
proc = function(matches) {
    _origProc2(matches);
    // Check score milestones for mini celebrations
    var milestones = [5000, 10000, 15000, 20000, 25000];
    milestones.forEach(function(m) {
        if (G.sc >= m && (G.sc - 300 * G.co) < m) {
            showToast('\u{1F3B8} ' + m.toLocaleString() + ' POINTS!');
            flashScreen();
        }
    });
};


// ===================== SWIPE/DRAG TOUCH CONTROLS =====================
// ===================== TOUCH/SWIPE SYSTEM (production) =====================
// All touch handling is scoped to the board element to prevent conflicts.
// touchmove uses passive:false so we can preventDefault (stop page scroll).
// A swipe threshold of 15px distinguishes swipe from tap.
// Tap-tap mode and swipe mode are mutually exclusive per gesture.
var _touchIdx=null,_touchX=0,_touchY=0,_swiped=false,_lastTouchTime=0;
(function(){
    var board=document.getElementById('gb');
    if(!board)return;
    
    board.addEventListener('touchstart',function(e){
        var tile=e.target.closest('.t');
        if(!tile||G.pr)return;
        var idx=parseInt(tile.dataset.index);
        if(isNaN(idx))return;
        if(G.bd[idx]&&G.bd[idx].ty==='obstacle')return;
        _touchIdx=idx;
        _touchX=e.touches[0].clientX;
        _touchY=e.touches[0].clientY;
        _swiped=false;
        iA();
    },{passive:true});
    
    board.addEventListener('touchmove',function(e){
        if(_touchIdx===null||_swiped||G.pr)return;
        var dx=e.touches[0].clientX-_touchX;
        var dy=e.touches[0].clientY-_touchY;
        var dist=Math.sqrt(dx*dx+dy*dy);
        if(dist>15){
            e.preventDefault(); // CRITICAL: stop page scroll during swipe
            _swiped=true;
            var row=Math.floor(_touchIdx/6),col=_touchIdx%6;
            var targetIdx;
            if(Math.abs(dx)>Math.abs(dy)){
                targetIdx=dx>0?(col<5?row*6+col+1:-1):(col>0?row*6+col-1:-1);
            }else{
                targetIdx=dy>0?(row<5?(row+1)*6+col:-1):(row>0?(row-1)*6+col:-1);
            }
            if(targetIdx>=0&&targetIdx<36&&!(G.bd[targetIdx]&&G.bd[targetIdx].ty==='obstacle')){
                var tiles=document.querySelectorAll('.t');
                if(G.sl!==null){tiles[G.sl].classList.remove('sel');G.sl=null}
                cH();if(hintsOn)sH();clearTimeout(idleTimer);startIdleQuips();
                sw(_touchIdx,targetIdx);
            }
            _touchIdx=null;
        }
    },{passive:false}); // passive:false required for preventDefault
    
    board.addEventListener('touchend',function(e){
        if(_touchIdx!==null&&!_swiped&&!G.pr){
            // This was a tap, not a swipe - use tap-tap system
            ck(_touchIdx);
        }
        _touchIdx=null;
        _swiped=false;
        _lastTouchTime=Date.now();
    },{passive:true});
})();

// ===================== BETTER OBJECTIVE GUIDANCE =====================
function updateObjBanner() {
    var banner = document.getElementById('obj-banner');
    if (!banner) return;
    var lv = G.isDaily ? null : LV[G.cl - 1];
    var hasObs = G.isDaily || (lv && ((lv.r || 0) + (lv.cb || 0) > 0));
    var pct = G.tg > 0 ? G.sc / G.tg : 0;
    var obsLeft = 0;
    G.bd.forEach(function(t) { if (t && t.ty === 'obstacle') obsLeft++ });

    if (pct >= 1 && (!hasObs || obsLeft === 0)) {
        banner.innerHTML = '<span class="obj-icon">\u2705</span> <b>TARGET REACHED!</b> One more match to win!';
    } else if (pct >= 1 && obsLeft > 0) {
        banner.innerHTML = '<span class="obj-icon">\u{1F4A5}</span> Score done! <b>Clear ' + obsLeft + ' obstacle' + (obsLeft > 1 ? 's' : '') + '</b> to win!';
    } else if (hasObs && obsLeft > 0 && pct < 0.5) {
        banner.innerHTML = '<span class="obj-icon">\u{1F3AF}</span> Match tiles to score <b>' + G.tg.toLocaleString() + ' pts</b> and break all <b>' + obsLeft + ' obstacles</b>';
    } else if (hasObs && obsLeft > 0) {
        banner.innerHTML = '<span class="obj-icon">\u{1F525}</span> <b>' + Math.round(pct * 100) + '% score</b> \u2014 still ' + obsLeft + ' obstacle' + (obsLeft > 1 ? 's' : '') + ' left!';
    } else if (pct < 0.3) {
        banner.innerHTML = '<span class="obj-icon">\u{1F3AF}</span> <b>Match 3+ instruments</b> to score ' + G.tg.toLocaleString() + ' points! Swipe or tap to swap tiles.';
    } else if (pct < 0.7) {
        var needed = G.tg - G.sc;
        banner.innerHTML = '<span class="obj-icon">\u{1F525}</span> <b>' + needed.toLocaleString() + ' more pts</b> needed \u2014 build combos for big multipliers!';
    } else {
        banner.innerHTML = '<span class="obj-icon">\u26A1</span> <b>Almost there!</b> Just ' + (G.tg - G.sc).toLocaleString() + ' more points!';
    }
}

// Hook into HUD updates
var _origUH2 = uH;
uH = function() {
    _origUH2();
    updateObjBanner();
};

// ===================== LEVEL PACING: Make mid-levels more generous =====================
// Boost moves for levels 5-15 by 2-3 to ease the difficulty curve
// (old pacing overrides removed - see consolidated pacing above)


// ===================== FIX: REDUCE TILE TYPES PER LEVEL =====================
// Use 6 random types per level instead of all 8 - makes matches much more common
var levelTypes = null;
function pickLevelTypes() {
    // Shuffle all 8 and pick 6
    var all = TY.slice();
    for (var i = all.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = all[i]; all[i] = all[j]; all[j] = tmp;
    }
    levelTypes = all.slice(0, 6);
}

// Override tile creation to use level-specific types + stronger bias
var _origMT2 = mT;
mT = function() {
    if (!levelTypes) pickLevelTypes();
    var r = Math.random();
    if (r < .04) return {ty: 'xray', sp: 'xray'};
    if (r < .12) return {ty: levelTypes[Math.floor(Math.random() * levelTypes.length)], sp: 'gem'};
    // 40% chance to bias toward board-common types (was 20%)
    if (r < .52) {
        var counts = {};
        G.bd.forEach(function(t) {
            if (t && t.ty && t.ty !== 'obstacle' && t.ty !== 'xray')
                counts[t.ty] = (counts[t.ty] || 0) + 1;
        });
        var types = Object.keys(counts).filter(function(t) { return levelTypes.indexOf(t) >= 0 });
        if (types.length > 0) {
            types.sort(function(a, b) { return counts[b] - counts[a] });
            return {ty: types[Math.floor(Math.random() * Math.min(3, types.length))], sp: null};
        }
    }
    return {ty: levelTypes[Math.floor(Math.random() * levelTypes.length)], sp: null};
};

// Pick new types when starting a level
var _origStrt2 = strt;
strt = function(n) {
    pickLevelTypes();
    _origStrt2(n);
};
var _origStartDaily2 = startDaily;
startDaily = function() {
    pickLevelTypes();
    _origStartDaily2();
};

// ===================== FIX: CLEAR ARROW HINTS =====================
// Replace the old hint display with arrow-based hints
function cH() {
    document.querySelectorAll('.t.hint-from,.t.hint-to,.t.hint').forEach(function(t) {
        t.classList.remove('hint-from', 'hint-to', 'hint');
    });
    document.querySelectorAll('.hint-arrow').forEach(function(a) { a.remove() });
    if (G.ht) { clearTimeout(G.ht); G.ht = null }
}

function shH() {
    var h = fPM();
    if (!h) return;
    var tiles = document.querySelectorAll('.t');
    var fromIdx = h[0], toIdx = h[1];
    
    // Highlight both tiles
    tiles[fromIdx].classList.add('hint-from');
    tiles[toIdx].classList.add('hint-to');
    
    // Draw arrow between them
    var fromRect = tiles[fromIdx].getBoundingClientRect();
    var toRect = tiles[toIdx].getBoundingClientRect();
    var fromCX = fromRect.left + fromRect.width / 2;
    var fromCY = fromRect.top + fromRect.height / 2;
    var toCX = toRect.left + toRect.width / 2;
    var toCY = toRect.top + toRect.height / 2;
    var midX = (fromCX + toCX) / 2;
    var midY = (fromCY + toCY) / 2;
    
    // Determine arrow direction
    var arrow = document.createElement('div');
    arrow.className = 'hint-arrow';
    var dx = toCX - fromCX, dy = toCY - fromCY;
    if (Math.abs(dx) > Math.abs(dy)) {
        arrow.textContent = dx > 0 ? '\u{27A1}' : '\u{2B05}';
    } else {
        arrow.textContent = dy > 0 ? '\u{2B07}' : '\u{2B06}';
    }
    arrow.style.left = midX + 'px';
    arrow.style.top = midY + 'px';
    document.body.appendChild(arrow);
}

// ===================== FIX: SMARTER HINT FINDING =====================
// Prefer bigger matches over smaller ones
function fPM() {
    var best = null, bestScore = 0;
    for (var i = 0; i < 36; i++) {
        if (!G.bd[i] || G.bd[i].ty === 'obstacle') continue;
        for (var j = i + 1; j < 36; j++) {
            if (!G.bd[j] || G.bd[j].ty === 'obstacle') continue;
            if (!isA(i, j)) continue;
            
            // Check specials
            var iSp = G.bd[i] && (G.bd[i].sp === 'amp' || G.bd[i].sp === 'rstar' || G.bd[i].ty === 'xray');
            var jSp = G.bd[j] && (G.bd[j].sp === 'amp' || G.bd[j].sp === 'rstar' || G.bd[j].ty === 'xray');
            if (iSp || jSp) {
                var spScore = 100; // Specials are high priority
                if (!best || spScore > bestScore) { best = [i, j]; bestScore = spScore; }
                continue;
            }
            
            // Try swap and score the match
            var tmp = G.bd[i]; G.bd[i] = G.bd[j]; G.bd[j] = tmp;
            var m = fM();
            tmp = G.bd[i]; G.bd[i] = G.bd[j]; G.bd[j] = tmp;
            
            if (m.length > 0) {
                var score = 0;
                m.forEach(function(mt) { score += mt.length * mt.length; }); // Prefer longer matches
                // Bonus for gem matches
                if (G.bd[i] && G.bd[i].sp === 'gem') score += 10;
                if (G.bd[j] && G.bd[j].sp === 'gem') score += 10;
                if (!best || score > bestScore) { best = [i, j]; bestScore = score; }
            }
        }
    }
    return best;
}

// ===================== FIX: MORE GENEROUS LEVEL PACING =====================
// Give more moves across all levels for better flow
// Level pacing: challenging but fair
LV.forEach(function(l) {
    if (l.n <= 3) l.m = Math.max(l.m, 22);       // Tutorial: enough to learn, not a cakewalk
    else if (l.n <= 8) l.m = Math.max(l.m, 23);   // Early: comfortable but engaged
    else if (l.n <= 15) l.m = Math.max(l.m, 22);  // Mid S1: real challenge starts
    else if (l.n <= 22) l.m = Math.max(l.m, 22);  // Early S2: tough but fair
    else l.m = Math.max(l.m, 21);                  // Late game: expert mode
});
// Also raise early targets slightly so boards don't clear instantly
if(LV[0])LV[0].t=1500;  // Level 1: was 1000
if(LV[1])LV[1].t=2000;  // Level 2: was 1500
if(LV[2])LV[2].t=2800;  // Level 3: was 2000

// ===================== FIX: AUTO-HELP WHEN STUCK =====================
// If player makes 3 moves without scoring, offer stronger hint
var movesWithoutScore = 0, lastScore = 0;
var _origSw2 = sw;
sw = function(a, b) {
    lastScore = G.sc;
    _origSw2(a, b);
    // After swap, check if score changed
    setTimeout(function() {
        if (G.sc === lastScore) {
            movesWithoutScore++;
            if (movesWithoutScore >= 3) {
                movesWithoutScore = 0;
                // Force show hint immediately
                cH();
                shH();
                dlgC('Rick', '\u{1F527}', 'Psst! Check the glowing tiles \u2014 swap the GOLD one toward the ORANGE one!');
            }
        } else {
            movesWithoutScore = 0;
        }
    }, 800);
};

// ===================== POLISH: First-level welcome hint =====================
var _origMkB2 = mkB;
mkB = function(lv) {
    _origMkB2(lv);
    // On first level, show hint immediately
    if (G.cl === 1 && !G.dn[1]) {
        setTimeout(function() {
            shH();
            dlgC('Jake', '\u{1F3B8}', 'See the gold and orange tiles? Swipe or tap them to swap! Match 3 of the same instrument!');
        }, 1500);
    }
};


// ===================== STAGE TRANSITION =====================
var _origStrtX = strt;
strt = function(n) {
    // Check if entering a new stage
    if (n === 16 && !G.dn[16]) {
        // Entering Stage 2 for first time!
        showStageTransition(2, function() { _origStrtX(n) });
    } else {
        _origStrtX(n);
    }
};

function showStageTransition(stageNum, callback) {
    var names = {2: 'Coffee Shop Circuit'};
    var descs = {2: 'Word has spread. Twelve people in a coffee shop are about to have their minds blown.'};
    var ov = document.createElement('div');
    ov.className = 'win-overlay';
    ov.innerHTML = '<div class="win-box">'
        + '<div style="font-size:3rem;margin-bottom:10px">\u2615</div>'
        + '<div style="font-family:Archivo Black,sans-serif;font-size:1.6rem;color:#ffd700;margin-bottom:8px">STAGE ' + stageNum + '</div>'
        + '<div style="font-family:Archivo Black,sans-serif;font-size:1.2rem;color:#fff;margin-bottom:10px">' + (names[stageNum] || '') + '</div>'
        + '<div style="font-size:.95rem;color:#ff8c00;margin-bottom:20px;font-style:italic">' + (descs[stageNum] || '') + '</div>'
        + '<div style="font-size:.85rem;color:#aaa;margin-bottom:15px">\u{1F3B5} New music \u2022 Harder obstacles \u2022 More unlocks</div>'
        + '<button class="btn" onclick="this.closest(\'.win-overlay\').remove();void(0)" id="stage-go-btn">\u{1F918} LET\'S GO!</button>'
        + '</div>';
    document.body.appendChild(ov);
    document.getElementById('stage-go-btn').onclick = function() {
        ov.remove();
        callback();
    };
    spawnConfetti();
}


// ===================== ROCK STAR LIFE: SHOP SYSTEM =====================
var SHOP_CATS=[
    {id:'guitars',name:'\u{1F3B8} Guitars',items:[
        {id:'g1',name:'Pawn Shop Special',desc:'It was $40. One string is missing.',icon:'\u{1F3B8}',price:0,tier:0},
        {id:'g2',name:'Fender Squire',desc:'Real brand! The guys at Guitar Center nodded.',icon:'\u{1F3B8}',price:3,tier:1},
        {id:'g3',name:'Epiphone Les Paul',desc:'Sunburst finish. Neighbors can feel it.',icon:'\u{1F3B8}',price:8,tier:2},
        {id:'g4',name:'Gibson SG',desc:'Now we\'re talking. Angus would approve.',icon:'\u{1F3B8}',price:15,tier:3},
        {id:'g5',name:'PRS Custom 24',desc:'Worth more than the van. By a lot.',icon:'\u{1F3B8}',price:25,tier:4},
        {id:'g6',name:'1959 Les Paul',desc:'Insured for more than our bassist.',icon:'\u{1F3B8}',price:40,tier:5},
        {id:'g7',name:'Custom Shop Masterpiece',desc:'Hand-built by monks who shred.',icon:'\u{1F3B8}',price:60,tier:6}
    ]},
    {id:'fashion',name:'\u{1F576} Fashion',items:[
        {id:'f1',name:'Band T-Shirt',desc:'Our own merch. We are our own biggest fans.',icon:'\u{1F455}',price:0,tier:0},
        {id:'f2',name:'Vintage Leather Jacket',desc:'Found at a thrift shop. Smells like someone else\'s dreams.',icon:'\u{1F9E5}',price:4,tier:1},
        {id:'f3',name:'Signature Shades',desc:'Rose-tinted. The world looks better and so do we.',icon:'\u{1F576}',price:8,tier:2},
        {id:'f4',name:'Custom Stage Boots',desc:'Platform heels that double as weapons. Stylish AND practical.',icon:'\u{1F462}',price:14,tier:3},
        {id:'f5',name:'Hand-Painted Denim',desc:'Every patch tells a story. Mostly stories about being broke.',icon:'\u{1F455}',price:22,tier:4},
        {id:'f6',name:'Designer Tour Wardrobe',desc:'Vivienne Westwood meets garage sale. Iconic.',icon:'\u{1F457}',price:35,tier:5},
        {id:'f7',name:'Rock Royalty Collection',desc:'Custom couture. The red carpet called and we answered.',icon:'\u{1F48E}',price:55,tier:6}
    ]},
    {id:'rides',name:'\u{1F697} Rides',items:[
        {id:'r1',name:'City Bus Pass',desc:'Glamorous. The driver knows our faces.',icon:'\u{1F68C}',price:0,tier:0},
        {id:'r2',name:'Used Bicycle',desc:'Two wheels. Zero respect. Total freedom.',icon:'\u{1F6B2}',price:5,tier:1},
        {id:'r3',name:'1987 Van',desc:'The classic band van. AC works sometimes.',icon:'\u{1F690}',price:12,tier:2},
        {id:'r4',name:'Touring Bus',desc:'It has BUNKS. We\'re basically famous.',icon:'\u{1F68C}',price:20,tier:3},
        {id:'r5',name:'Muscle Car',desc:'1969 Charger. Gas costs more than food.',icon:'\u{1F3CE}',price:30,tier:4},
        {id:'r6',name:'Luxury SUV',desc:'Heated seats. We made it, technically.',icon:'\u{1F699}',price:45,tier:5},
        {id:'r7',name:'Tour Helicopter',desc:'The neighbors can\'t complain from up here.',icon:'\u{1F681}',price:65,tier:6}
    ]},
    {id:'cribs',name:'\u{1F3E0} Cribs',items:[
        {id:'h1',name:'Mom\'s Basement',desc:'Free rent. Infinite pizza rolls. No shame.',icon:'\u{1F3DA}',price:0,tier:0},
        {id:'h2',name:'Studio Apartment',desc:'Bedroom, kitchen, and stage are the same room.',icon:'\u{1F3E2}',price:5,tier:1},
        {id:'h3',name:'Shared Loft',desc:'Three bedrooms, four band members. Math.',icon:'\u{1F3E0}',price:12,tier:2},
        {id:'h4',name:'Downtown Condo',desc:'Has a doorman. He\'s heard our demos. He\'s fine.',icon:'\u{1F3E2}',price:20,tier:3},
        {id:'h5',name:'House with Garage',desc:'A REAL practice space. Soundproofed. By blankets.',icon:'\u{1F3E1}',price:32,tier:4},
        {id:'h6',name:'Beach House',desc:'Write songs by the ocean. Pretend we surf.',icon:'\u{1F3D6}',price:50,tier:5},
        {id:'h7',name:'Rock Star Mansion',desc:'Pool shaped like a guitar. Gold toilet. We earned this.',icon:'\u{1F3F0}',price:70,tier:6}
    ]},
    {id:'gear',name:'\u{1F3A4} Gear',items:[
        {id:'e1',name:'Phone Speaker',desc:'Plays backing tracks. Poorly.',icon:'\u{1F4F1}',price:0,tier:0},
        {id:'e2',name:'Practice Amp',desc:'5 watts of fury. Fury is relative.',icon:'\u{1F50A}',price:3,tier:1},
        {id:'e3',name:'PA System',desc:'Now the vocals are louder than the drums. Dave is upset.',icon:'\u{1F399}',price:10,tier:2},
        {id:'e4',name:'Recording Rig',desc:'GarageBand, a microphone, and a dream.',icon:'\u{1F3A7}',price:18,tier:3},
        {id:'e5',name:'Pro Studio Time',desc:'24 tracks. Real engineer. He sighs a lot.',icon:'\u{1F3AC}',price:28,tier:4},
        {id:'e6',name:'Concert Light Rig',desc:'Lasers! Strobes! The fire marshal is watching.',icon:'\u{1F4A1}',price:42,tier:5},
        {id:'e7',name:'Festival Main Stage',desc:'100,000 watts. 50,000 fans. 1 dream realized.',icon:'\u{1F3A4}',price:75,tier:6}
    ]}
];

var FAME_LEVELS=[
    {name:'Basement Nobody',need:0},
    {name:'Garage Rocker',need:5},
    {name:'Open Mic Regular',need:10},
    {name:'Local Favorite',need:18},
    {name:'Regional Act',need:28},
    {name:'Touring Band',need:40},
    {name:'Gold Record Artist',need:55},
    {name:'Rock Legend',need:70},
    {name:'Hall of Famer',need:90}
];

function getStarCoins(){
    var total=0;for(var k in G.st)total+=G.st[k];
    return total-(G.spent||0);
}
function getTotalStars(){var total=0;for(var k in G.st)total+=G.st[k];return total}
function getOwnedCount(){if(!G.owned)G.owned={};return Object.keys(G.owned).length}
function getFameLevel(){
    var count=getOwnedCount();
    var lvl=FAME_LEVELS[0];
    for(var i=FAME_LEVELS.length-1;i>=0;i--){
        if(count>=FAME_LEVELS[i].need){lvl=FAME_LEVELS[i];break}
    }
    return lvl;
}

function showRSL(){
    if(!G.owned)G.owned={};
    if(!G.spent)G.spent=0;
    // Give starter items for free
    SHOP_CATS.forEach(function(cat){
        if(cat.items[0]&&cat.items[0].price===0&&!G.owned[cat.items[0].id]){
            G.owned[cat.items[0].id]=true;
        }
    });
    renderShop('guitars');
    showS('rsl');
}

function renderShop(catId){
    var coins=getStarCoins();
    var total=getTotalStars();
    var count=getOwnedCount();
    var fame=getFameLevel();
    
    // Update status
    document.getElementById('rsl-coins').innerHTML='\u2B50 '+coins+' Stars Available <span style="font-size:.7rem;color:#ff8c00">('+total+' earned)</span>';
    document.getElementById('rsl-fame-name').textContent=fame.name;
    
    // Fame bar
    var nextFame=null;
    for(var i=0;i<FAME_LEVELS.length;i++){if(count<FAME_LEVELS[i].need){nextFame=FAME_LEVELS[i];break}}
    var pct=nextFame?Math.min(100,(count/nextFame.need)*100):100;
    document.getElementById('rsl-fame-bar').style.width=pct+'%';
    document.getElementById('rsl-fame-next').textContent=nextFame?'Next: '+nextFame.name+' ('+nextFame.need+' items)':'MAX FAME REACHED! \u{1F451}';
    
    // Band preview
    var bp=document.getElementById('band-preview');
    var bestItems={};
    SHOP_CATS.forEach(function(cat){
        var best=null;
        cat.items.forEach(function(item){if(G.owned[item.id])best=item});
        if(best)bestItems[cat.id]=best;
    });
    bp.innerHTML='<div class="band-preview-title">\u{1F3A4} Your Band\'s Current Vibe</div>'
        +'<div class="band-scene">'
        +'<div class="band-scene-item"><span>'+(bestItems.guitars?bestItems.guitars.icon:'\u{1F3B8}')+'</span><span class="band-scene-label">'+(bestItems.guitars?bestItems.guitars.name:'???')+'</span></div>'
        +'<div class="band-scene-item"><span>'+(bestItems.fashion?bestItems.fashion.icon:'\u{1F455}')+'</span><span class="band-scene-label">'+(bestItems.fashion?bestItems.fashion.name:'???')+'</span></div>'
        +'<div class="band-scene-item"><span>'+(bestItems.rides?bestItems.rides.icon:'\u{1F6B6}')+'</span><span class="band-scene-label">'+(bestItems.rides?bestItems.rides.name:'???')+'</span></div>'
        +'<div class="band-scene-item"><span>'+(bestItems.cribs?bestItems.cribs.icon:'\u{1F3DA}')+'</span><span class="band-scene-label">'+(bestItems.cribs?bestItems.cribs.name:'???')+'</span></div>'
        +'<div class="band-scene-item"><span>'+(bestItems.gear?bestItems.gear.icon:'\u{1F4F1}')+'</span><span class="band-scene-label">'+(bestItems.gear?bestItems.gear.name:'???')+'</span></div>'
        +'</div>'
        +'<div class="fame-level">\u{1F451} '+fame.name+'</div>';
    
    // Category tabs
    var cats=document.getElementById('shop-cats');cats.innerHTML='';
    SHOP_CATS.forEach(function(cat){
        var b=document.createElement('button');b.className='shop-cat'+(cat.id===catId?' active':'');
        b.textContent=cat.name;b.onclick=function(){renderShop(cat.id)};
        cats.appendChild(b);
    });
    
    // Items grid
    var grid=document.getElementById('shop-grid');grid.innerHTML='';
    var activeCat=SHOP_CATS.find(function(c){return c.id===catId});
    if(!activeCat)return;
    
    activeCat.items.forEach(function(item){
        var owned=G.owned[item.id];
        var canAfford=coins>=item.price;
        var prevOwned=item.tier===0||activeCat.items.some(function(it){return it.tier===item.tier-1&&G.owned[it.id]});
        
        var d=document.createElement('div');
        d.className='shop-item'+(owned?' owned':'')+((!owned&&!canAfford)||(!owned&&!prevOwned)?' locked':'');
        
        var priceText=owned?'\u2705 Owned':'<span>\u2B50</span> '+item.price;
        if(!owned&&!prevOwned)priceText='\u{1F512} Buy previous first';
        
        d.innerHTML='<span class="shop-icon">'+item.icon+'</span>'
            +'<div class="shop-name">'+item.name+'</div>'
            +'<div class="shop-desc">'+item.desc+'</div>'
            +'<div class="shop-price'+(owned?' owned-price':'')+'">'+priceText+'</div>';
        
        if(!owned&&canAfford&&prevOwned){
            d.onclick=function(){buyItem(item,catId)};
        }
        grid.appendChild(d);
    });
}

function buyItem(item,catId){
    if(!G.owned)G.owned={};
    var coins=getStarCoins();
    if(coins<item.price)return;
    G.spent=(G.spent||0)+item.price;
    G.owned[item.id]=true;
    sv();
    showToast('\u{1F6D2} Bought: '+item.name+'!');
    P('g');flashScreen();
    // Check fame level up
    var oldFame=getFameLevel();
    var count=getOwnedCount();
    var newFame=getFameLevel();
    if(newFame.name!==oldFame.name){
        setTimeout(function(){
            showToast('\u{1F451} FAME UP: '+newFame.name+'!');
            spawnConfetti();
        },800);
    }
    renderShop(catId);
}

// ===================== SAVE/LOAD: Add shop data =====================
var _origSv3=sv;
sv=function(){try{localStorage.setItem('xrs5',JSON.stringify({a:G.cl,b:G.dn,c:G.st,d:G.stats,e:G.achEarned,f:G.owned,g:G.spent}))}catch(e){}};
var _origLd3=ld;
ld=function(){_origLd3();try{var d=JSON.parse(localStorage.getItem('xrs5'));if(d){G.owned=d.f||{};G.spent=d.g||0}}catch(e){}};

// ===================== SHOW STAR ECONOMY IN WIN SCREEN =====================
var _origShowWinOvX=showWinOv;
showWinOv=function(title,score,stars,extra,unlocks){
    _origShowWinOvX(title,score,stars,extra,unlocks);
    // Add star earning info to the win box
    var wb=document.querySelector('.win-overlay .win-box');
    if(wb&&stars>0&&title.indexOf('Daily')<0){
        var shopHint=document.createElement('div');
        shopHint.style.cssText='font-size:.8rem;color:#ff8c00;margin-top:6px';
        shopHint.innerHTML='\u2B50 +'+stars+' stars earned! ('+getStarCoins()+' available) <span style="cursor:pointer;text-decoration:underline" onclick="document.querySelector(\'.win-overlay\').remove();showRSL()">\u{1F6D2} Shop</span>';
        var btns=wb.querySelector('.win-btns');
        if(btns)wb.insertBefore(shopHint,btns);
    }
};


// ===================== GOAL TRACKING SYSTEM =====================

// Find the next unowned item the player is closest to affording
function getNextGoal() {
    if (!G.owned) G.owned = {};
    var coins = getStarCoins();
    var candidates = [];

    SHOP_CATS.forEach(function(cat) {
        cat.items.forEach(function(item, idx) {
            if (G.owned[item.id]) return;
            // Check if previous tier is owned (or it's tier 0)
            var prevOwned = item.tier === 0 || cat.items.some(function(it) { return it.tier === item.tier - 1 && G.owned[it.id] });
            if (!prevOwned) return;
            candidates.push({
                item: item,
                cat: cat,
                pct: Math.min(100, (coins / Math.max(1, item.price)) * 100),
                remaining: Math.max(0, item.price - coins)
            });
        });
    });

    if (candidates.length === 0) return null;

    // Sort: items you CAN afford first, then by closest to affording
    candidates.sort(function(a, b) {
        if (a.remaining === 0 && b.remaining > 0) return -1;
        if (b.remaining === 0 && a.remaining > 0) return 1;
        return a.remaining - b.remaining;
    });

    return candidates[0];
}

// Get all affordable items player hasn't bought yet
function getAffordableItems() {
    if (!G.owned) G.owned = {};
    var coins = getStarCoins();
    var affordable = [];
    SHOP_CATS.forEach(function(cat) {
        cat.items.forEach(function(item) {
            if (G.owned[item.id]) return;
            if (item.price > coins) return;
            var prevOwned = item.tier === 0 || cat.items.some(function(it) { return it.tier === item.tier - 1 && G.owned[it.id] });
            if (!prevOwned) return;
            affordable.push({item: item, cat: cat});
        });
    });
    return affordable;
}

// ===================== IN-GAME GOAL TRACKER =====================
function updateGoalTracker() {
    var el = document.getElementById('goal-tracker');
    if (!el) return;

    var goal = getNextGoal();
    if (!goal) { el.style.display = 'none'; return; }

    el.style.display = 'flex';
    var coins = getStarCoins();
    var isReady = coins >= goal.item.price;

    el.className = 'goal-tracker' + (isReady ? ' goal-ready' : '');
    el.innerHTML = '<span class="goal-icon">' + goal.item.icon + '</span>'
        + '<div class="goal-info">'
        + '<div class="goal-name">' + (isReady ? '\u2705 CAN BUY: ' : '\u{1F3AF} Saving for: ') + goal.item.name + '</div>'
        + '<div class="goal-progress">'
        + '<div class="goal-bar"><div class="goal-fill" style="width:' + goal.pct + '%"></div></div>'
        + '<span class="goal-pct">' + (isReady ? 'TAP TO BUY!' : '\u2B50 ' + coins + '/' + goal.item.price) + '</span>'
        + '</div></div>';
}

// ===================== AFFORD ALERTS (after winning a level) =====================
var prevAffordable = [];
function checkNewAffordable() {
    var nowAffordable = getAffordableItems();
    var newOnes = nowAffordable.filter(function(a) {
        return !prevAffordable.some(function(p) { return p.item.id === a.item.id });
    });
    prevAffordable = nowAffordable;

    newOnes.forEach(function(a, i) {
        setTimeout(function() {
            showAffordToast(a.item);
        }, 1500 + i * 2500);
    });
}

function showAffordToast(item) {
    var t = document.createElement('div');
    t.className = 'afford-toast';
    t.innerHTML = '\u{1F389} You can now afford: <b>' + item.icon + ' ' + item.name + '</b>! Tap to shop!';
    t.onclick = function() { t.remove(); document.querySelectorAll('.win-overlay').forEach(function(o){o.remove()}); showRSL() };
    document.body.appendChild(t);
    setTimeout(function() { if (t.parentNode) { t.style.transition = 'all .5s'; t.style.opacity = '0'; t.style.transform = 'translateX(-50%) translateY(30px)'; setTimeout(function(){t.remove()},500) } }, 5000);
}

// ===================== SHOP: ADD PROGRESS BARS TO ITEMS =====================
// (removed: old progress bar override - now in merged override)

// ===================== WIN SCREEN: REWARD BREAKDOWN + NEXT PURCHASE =====================
var _origShowWinOvY = showWinOv;
showWinOv = function(title, score, stars, extra, unlocks) {
    _origShowWinOvY(title, score, stars, extra, unlocks);

    var wb = document.querySelector('.win-overlay .win-box');
    if (!wb || title.indexOf('Daily') >= 0) return;

    // Build reward breakdown
    var coins = getStarCoins();
    var totalStars = getTotalStars();
    var goal = getNextGoal();

    var breakdown = document.createElement('div');
    breakdown.className = 'reward-breakdown';
    breakdown.innerHTML = '<div class="reward-row"><span class="label">Stars this level</span><span class="value">+' + stars + ' \u2B50</span></div>'
        + '<div class="reward-row"><span class="label">Total earned</span><span class="value">' + totalStars + ' \u2B50</span></div>'
        + '<div class="reward-row"><span class="label">Spent in shop</span><span class="value">' + (G.spent || 0) + ' \u2B50</span></div>'
        + '<div class="reward-row total"><span class="label">Available to spend</span><span class="value">' + coins + ' \u2B50</span></div>';

    // Next purchase teaser
    if (goal) {
        var nextDiv = document.createElement('div');
        nextDiv.className = 'next-buy';
        if (coins >= goal.item.price) {
            nextDiv.innerHTML = '\u{1F389} You can buy <b>' + goal.item.icon + ' ' + goal.item.name + '</b> now! Tap to shop!';
        } else {
            var starsNeeded = goal.item.price - coins;
            var levelsNeeded = Math.ceil(starsNeeded / 2); // ~2 stars average per level
            nextDiv.innerHTML = goal.item.icon + ' <b>' + goal.item.name + '</b>: ' + coins + '/' + goal.item.price + ' \u2B50 \u2014 ~' + levelsNeeded + ' more level' + (levelsNeeded > 1 ? 's' : '') + '!';
        }
        nextDiv.onclick = function() { document.querySelector('.win-overlay').remove(); showRSL() };
        breakdown.appendChild(nextDiv);
    }

    // Insert before buttons
    var btns = wb.querySelector('.win-btns');
    if (btns) wb.insertBefore(breakdown, btns);

    // Check for new affordable items
    checkNewAffordable();
};

// ===================== LOSE SCREEN: SHOW WHAT YOU'RE WORKING TOWARD =====================
var _origLsY = ls;
ls = function() {
    _origLsY();
    setTimeout(function() {
        var wb = document.querySelector('.win-overlay .win-box');
        if (!wb) return;
        var goal = getNextGoal();
        if (goal && getStarCoins() < goal.item.price) {
            var teaser = document.createElement('div');
            teaser.className = 'next-buy';
            teaser.style.marginTop = '10px';
            var needed = goal.item.price - getStarCoins();
            teaser.innerHTML = '\u{1F3AF} Win to earn stars toward <b>' + goal.item.icon + ' ' + goal.item.name + '</b> (' + needed + ' more \u2B50 needed)';
            var btns = wb.querySelector('.win-btns');
            if (btns) wb.insertBefore(teaser, btns);
        }
    }, 900);
};

// ===================== HOOK GOAL TRACKER INTO GAME =====================
var _origUH3 = uH;
uH = function() {
    _origUH3();
    updateGoalTracker();
};

// Initialize previous affordable list on load
prevAffordable = getAffordableItems();

// ===================== MENU: Show current fame + next goal =====================
var _origShowM2 = showM;
showM = function() {
    _origShowM2();
    // Could add fame display to menu in future
};


// ===================== UPGRADE BONUS SYSTEM =====================
// Each category gives bonuses based on highest tier owned

var BONUS_DEFS = {
    guitars: [
        {tier:0,desc:'No bonus'},
        {tier:1,desc:'+5% Gem spawn rate',gemBonus:0.02},
        {tier:2,desc:'+10% Gem spawn rate',gemBonus:0.04},
        {tier:3,desc:'+15% Gem spawn + Gems give 4x pts',gemBonus:0.06,gemMulti:4},
        {tier:4,desc:'+20% Gem spawn + Gems give 5x pts',gemBonus:0.08,gemMulti:5},
        {tier:5,desc:'+25% Gem spawn + Gems give 5x pts',gemBonus:0.10,gemMulti:5},
        {tier:6,desc:'+30% Gem spawn + Gems give 6x pts',gemBonus:0.12,gemMulti:6}
    ],
    fashion: [
        {tier:0,desc:'No bonus'},
        {tier:1,desc:'Combo multiplier +0.5x',comboBonus:0.5},
        {tier:2,desc:'Combo multiplier +1x',comboBonus:1},
        {tier:3,desc:'Combo multiplier +1.5x',comboBonus:1.5},
        {tier:4,desc:'Combo multiplier +2x',comboBonus:2},
        {tier:5,desc:'Combo multiplier +2.5x',comboBonus:2.5},
        {tier:6,desc:'Combo multiplier +3x',comboBonus:3}
    ],
    rides: [
        {tier:0,desc:'No bonus'},
        {tier:1,desc:'+1 starting move',moveBonus:1},
        {tier:2,desc:'+2 starting moves',moveBonus:2},
        {tier:3,desc:'+3 starting moves',moveBonus:3},
        {tier:4,desc:'+4 starting moves',moveBonus:4},
        {tier:5,desc:'+5 starting moves',moveBonus:5},
        {tier:6,desc:'+6 starting moves',moveBonus:6}
    ],
    cribs: [
        {tier:0,desc:'No bonus'},
        {tier:1,desc:'+5% score bonus',scoreMulti:1.05},
        {tier:2,desc:'+10% score bonus',scoreMulti:1.10},
        {tier:3,desc:'+15% score bonus',scoreMulti:1.15},
        {tier:4,desc:'+20% score bonus',scoreMulti:1.20},
        {tier:5,desc:'+25% score bonus',scoreMulti:1.25},
        {tier:6,desc:'+30% score bonus',scoreMulti:1.30}
    ],
    gear: [
        {tier:0,desc:'No special tiles'},
        {tier:1,desc:'Basic gear'},
        {tier:2,desc:'Unlocks Power Chord tile',unlockTile:'pchord'},
        {tier:3,desc:'Power Chord + higher spawn'},
        {tier:4,desc:'Unlocks Crowd Surf tile',unlockTile:'csurf'},
        {tier:5,desc:'All specials + higher spawn'},
        {tier:6,desc:'Unlocks Encore tile',unlockTile:'encore'}
    ]
};

function getUpgradeBonus(catId) {
    if (!G.owned) G.owned = {};
    var cat = SHOP_CATS.find(function(c) { return c.id === catId });
    if (!cat) return BONUS_DEFS[catId] ? BONUS_DEFS[catId][0] : {tier:0};
    var maxTier = 0;
    cat.items.forEach(function(item) {
        if (G.owned[item.id] && item.tier > maxTier) maxTier = item.tier;
    });
    var defs = BONUS_DEFS[catId];
    return defs ? (defs[maxTier] || defs[0]) : {tier:0};
}

function getAllBonuses() {
    return {
        guitars: getUpgradeBonus('guitars'),
        fashion: getUpgradeBonus('fashion'),
        rides: getUpgradeBonus('rides'),
        cribs: getUpgradeBonus('cribs'),
        gear: getUpgradeBonus('gear')
    };
}

// ===================== APPLY BONUSES TO GAMEPLAY =====================

// Override tile creation to apply gem bonus + new special tiles
var _origMT3 = mT;
mT = function() {
    if (!levelTypes) pickLevelTypes();
    var bonuses = getAllBonuses();
    var r = Math.random();

    // X-Ray star
    if (r < .04) return {ty: 'xray', sp: 'xray'};

    // Gear unlocked specials
    var gearTier = bonuses.gear.tier || 0;
    var specialChance = 0.04 + gearTier * 0.005;
    if (r < .04 + specialChance) {
        var available = [];
        if (gearTier >= 2) available.push('pchord');
        if (gearTier >= 4) available.push('csurf');
        if (gearTier >= 6) available.push('encore');
        if (available.length > 0) {
            var pick = available[Math.floor(Math.random() * available.length)];
            return {ty: levelTypes[Math.floor(Math.random() * levelTypes.length)], sp: pick};
        }
    }

    // Gems (boosted by guitar upgrades)
    var gemRate = 0.10 + (bonuses.guitars.gemBonus || 0);
    if (r < .04 + specialChance + gemRate) {
        return {ty: levelTypes[Math.floor(Math.random() * levelTypes.length)], sp: 'gem'};
    }

    // Bias toward board types
    if (r < .52 + specialChance + gemRate) {
        var counts = {};
        G.bd.forEach(function(t) {
            if (t && t.ty && t.ty !== 'obstacle' && t.ty !== 'xray')
                counts[t.ty] = (counts[t.ty] || 0) + 1;
        });
        var types = Object.keys(counts).filter(function(t) { return levelTypes.indexOf(t) >= 0 });
        if (types.length > 0) {
            types.sort(function(a, b) { return counts[b] - counts[a] });
            return {ty: types[Math.floor(Math.random() * Math.min(3, types.length))], sp: null};
        }
    }

    return {ty: levelTypes[Math.floor(Math.random() * levelTypes.length)], sp: null};
};

// Override renderTile to handle new specials
var _origRT3 = rT;
rT = function(el, d) {
    _origRT3(el, d);
    if (!d) return;
    if (d.sp === 'pchord') el.classList.add('pchord');
    if (d.sp === 'csurf') el.classList.add('csurf');
    if (d.sp === 'encore') el.classList.add('encore');
};

// Override swap to handle new special activations
var _origSw3 = sw;
sw = function(a, b) {
    var tA = G.bd[a], tB = G.bd[b];
    var newSpecials = ['pchord', 'csurf', 'encore'];
    var aNew = tA && newSpecials.indexOf(tA.sp) >= 0;
    var bNew = tB && newSpecials.indexOf(tB.sp) >= 0;

    if (aNew || bNew) {
        var tmp = G.bd[a]; G.bd[a] = G.bd[b]; G.bd[b] = tmp; uT(a); uT(b);
        G.mv--; G.pr = true; P('w'); uH();
        var spIdx = aNew ? a : b;
        var spType = G.bd[spIdx] ? G.bd[spIdx].sp : (aNew ? tA.sp : tB.sp);
        // Get the sp before it gets cleared
        if (aNew) spType = tA.sp;
        if (bNew && !aNew) spType = tB.sp;
        setTimeout(function() { activateNewSpecial(spIdx, spType) }, 150);
        return;
    }
    _origSw3(a, b);
};

function activateNewSpecial(idx, type) {
    P('x');
    var tiles = document.querySelectorAll('.t');
    var rc = tiles[idx].getBoundingClientRect();

    if (type === 'pchord') {
        // Power Chord: clear 3x3 area
        dlgC('Jake', '\u{1F3B8}', 'POWER CHORD! The walls are shaking!');
        var row = Math.floor(idx / 6), col = idx % 6;
        var toDestroy = [];
        for (var r = row - 1; r <= row + 1; r++) {
            for (var c = col - 1; c <= col + 1; c++) {
                if (r >= 0 && r < 6 && c >= 0 && c < 6) toDestroy.push(r * 6 + c);
            }
        }
        var sc = toDestroy.length * 200;
        G.sc += Math.round(sc * (getAllBonuses().cribs.scoreMulti || 1));
        scp(rc.left + rc.width / 2, rc.top + rc.height / 2, sc);
        ptc(rc.left + rc.width / 2, rc.top + rc.height / 2, '\u{1F3B5}', 8);
        document.getElementById('gb').classList.add('shake'); setTimeout(function() { document.getElementById('gb').classList.remove('shake') }, 400);
        toDestroy.forEach(function(j) {
            if (G.bd[j] && G.bd[j].ty === 'obstacle') { G.bd[j].hp--; if (G.bd[j].hp <= 0) { G.bd[j] = null; G.sc += 500 } else uT(j) }
            else if (G.bd[j]) { tiles[j].classList.add('mtch'); G.bd[j] = null }
        });
        uH(); uOC();
        setTimeout(function() { grav(); setTimeout(function() { refill(); setTimeout(chk, 180) }, 180) }, 220);

    } else if (type === 'csurf') {
        // Crowd Surf: shuffle board + turn 5 random tiles into gems
        dlgC('Maya', '\u{1F3B5}', 'CROWD SURF! The audience is carrying us!');
        // First clear the csurf tile itself
        G.bd[idx] = null;
        scp(rc.left + rc.width / 2, rc.top + rc.height / 2, 1000);
        G.sc += Math.round(1000 * (getAllBonuses().cribs.scoreMulti || 1));
        ptc(rc.left + rc.width / 2, rc.top + rc.height / 2, '\u{1F3C4}', 10);
        // Refill the empty spot
        G.bd[idx] = mT(); uT(idx);
        // Shuffle non-obstacle tiles
        var normals = [], obsIdx = [];
        for (var i = 0; i < 36; i++) {
            if (G.bd[i] && G.bd[i].ty === 'obstacle') obsIdx.push(i);
            else if (G.bd[i]) normals.push(G.bd[i]);
        }
        for (var i = normals.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var tmp = normals[i]; normals[i] = normals[j]; normals[j] = tmp;
        }
        var ni = 0;
        for (var i = 0; i < 36; i++) {
            if (obsIdx.indexOf(i) === -1) { G.bd[i] = normals[ni++] || mT(); uT(i) }
        }
        // Turn 5 random tiles into gems
        var gemCandidates = [];
        for (var i = 0; i < 36; i++) {
            if (G.bd[i] && !G.bd[i].sp && G.bd[i].ty !== 'obstacle' && G.bd[i].ty !== 'xray') gemCandidates.push(i);
        }
        for (var g = 0; g < Math.min(5, gemCandidates.length); g++) {
            var ri = Math.floor(Math.random() * gemCandidates.length);
            var gi = gemCandidates.splice(ri, 1)[0];
            G.bd[gi].sp = 'gem'; uT(gi);
        }
        flashScreen();
        uH(); uOC();
        G.pr = false;
        if (hintsOn) sH();

    } else if (type === 'encore') {
        // Encore: +5 moves + score bonus
        dlgC('Dave', '\u{1F941}', 'ENCORE! ENCORE! The crowd wants MORE!');
        G.bd[idx] = null; tiles[idx].classList.add('mtch');
        G.mv += 5;
        var bonus = 1500;
        G.sc += Math.round(bonus * (getAllBonuses().cribs.scoreMulti || 1));
        scp(rc.left + rc.width / 2, rc.top + rc.height / 2, bonus);
        ptc(rc.left + rc.width / 2, rc.top + rc.height / 2, '\u{1F504}', 8);
        showToast('\u{1F3B5} ENCORE! +5 moves!');
        document.getElementById('gb').classList.add('shake-big'); setTimeout(function() { document.getElementById('gb').classList.remove('shake-big') }, 600);
        uH(); uOC();
        setTimeout(function() { grav(); setTimeout(function() { refill(); setTimeout(chk, 180) }, 180) }, 220);
    }
}

// ===================== APPLY SCORE MULTIPLIER (CRIBS BONUS) =====================
var _origProc6 = proc;
proc = function(matches) {
    var bonuses = getAllBonuses();
    // Temporarily boost combo scoring via fashion bonus
    var origCo = G.co;
    var fashionBonus = bonuses.fashion.comboBonus || 0;
    // We add the fashion bonus to the combo count for scoring
    G.co = origCo + fashionBonus;
    _origProc6(matches);
    G.co = G.co - fashionBonus; // Remove the float bonus after scoring
};

// ===================== APPLY MOVE BONUS (RIDES) =====================
var _origStrt5 = strt;
strt = function(n) {
    _origStrt5(n);
    // Add bonus moves from rides (after level loads)
    setTimeout(function() {
        var bonuses = getAllBonuses();
        var moveBonus = bonuses.rides.moveBonus || 0;
        if (moveBonus > 0 && !G.isDaily) {
            G.mv += moveBonus;
            uH();
        }
    }, 2000);
};

// ===================== BONUS HUD DISPLAY =====================
function updateBonusBar() {
    var bar = document.getElementById('bonus-bar');
    if (!bar) return;
    var b = getAllBonuses();
    var pills = '';
    if (b.guitars.tier > 0) pills += '<div class="bonus-pill active"><span class="bp-icon">\u{1F3B8}</span>Gems+' + Math.round((b.guitars.gemBonus || 0) * 100) + '%</div>';
    if (b.fashion.tier > 0) pills += '<div class="bonus-pill active"><span class="bp-icon">\u{1F576}</span>Combo+' + (b.fashion.comboBonus || 0) + 'x</div>';
    if (b.rides.tier > 0) pills += '<div class="bonus-pill active"><span class="bp-icon">\u{1F697}</span>+' + (b.rides.moveBonus || 0) + ' moves</div>';
    if (b.cribs.tier > 0) pills += '<div class="bonus-pill active"><span class="bp-icon">\u{1F3E0}</span>Score+' + Math.round(((b.cribs.scoreMulti || 1) - 1) * 100) + '%</div>';
    if (b.gear.tier >= 2) pills += '<div class="bonus-pill active"><span class="bp-icon">\u{1F3A4}</span>Special tiles</div>';
    if (pills === '') pills = '<div class="bonus-pill"><span class="bp-icon">\u{1F6D2}</span>Shop upgrades for bonuses!</div>';
    bar.innerHTML = pills;
}

// Hook into HUD
var _origUH4 = uH;
uH = function() { _origUH4(); updateBonusBar() };

// ===================== BONUS SPLASH AT LEVEL START =====================
var _origStrt6 = strt;
strt = function(n) {
    _origStrt6(n);
    // Show bonus splash if player has any bonuses
    setTimeout(function() {
        var b = getAllBonuses();
        var hasBonuses = b.guitars.tier > 0 || b.fashion.tier > 0 || b.rides.tier > 0 || b.cribs.tier > 0 || b.gear.tier >= 2;
        if (!hasBonuses) return;

        var items = '';
        if (b.guitars.tier > 0) items += '<div class="bonus-item"><span class="bonus-item-icon">\u{1F3B8}</span><div class="bonus-item-text"><div class="bonus-item-name">' + getOwnedName('guitars') + '</div><div class="bonus-item-effect">' + b.guitars.desc + '</div></div></div>';
        if (b.fashion.tier > 0) items += '<div class="bonus-item"><span class="bonus-item-icon">\u{1F576}</span><div class="bonus-item-text"><div class="bonus-item-name">' + getOwnedName('fashion') + '</div><div class="bonus-item-effect">' + b.fashion.desc + '</div></div></div>';
        if (b.rides.tier > 0) items += '<div class="bonus-item"><span class="bonus-item-icon">\u{1F697}</span><div class="bonus-item-text"><div class="bonus-item-name">' + getOwnedName('rides') + '</div><div class="bonus-item-effect">' + b.rides.desc + '</div></div></div>';
        if (b.cribs.tier > 0) items += '<div class="bonus-item"><span class="bonus-item-icon">\u{1F3E0}</span><div class="bonus-item-text"><div class="bonus-item-name">' + getOwnedName('cribs') + '</div><div class="bonus-item-effect">' + b.cribs.desc + '</div></div></div>';
        if (b.gear.tier >= 2) items += '<div class="bonus-item"><span class="bonus-item-icon">\u{1F3A4}</span><div class="bonus-item-text"><div class="bonus-item-name">' + getOwnedName('gear') + '</div><div class="bonus-item-effect">' + b.gear.desc + '</div></div></div>';

        var splash = document.createElement('div');
        splash.className = 'bonus-splash';
        splash.innerHTML = '<div class="bonus-splash-box"><div class="bonus-splash-title">\u{1F3B8} Your Gear Bonuses</div>' + items + '<button class="btn bs" onclick="this.closest(\'.bonus-splash\').remove()">ROCK ON! \u{1F918}</button></div>';
        document.body.appendChild(splash);
        // Auto-dismiss after 4s
        setTimeout(function() { if (splash.parentNode) splash.remove() }, 4000);
    }, 2200);
};

function getOwnedName(catId) {
    var cat = SHOP_CATS.find(function(c) { return c.id === catId });
    if (!cat) return '???';
    var best = null;
    cat.items.forEach(function(item) { if (G.owned && G.owned[item.id]) best = item });
    return best ? best.name : '???';
}

// (removed: old broken split override and old dynamic music - clean versions at end of file)

// ===================== UPDATE TILE LEGEND WITH NEW SPECIALS =====================
function updateTileLegend() {
    var legend = document.querySelector('.tile-legend');
    if (!legend) return;
    var b = getAllBonuses();
    // Remove old dynamic entries
    legend.querySelectorAll('.tl-dynamic').forEach(function(e) { e.remove() });
    if (b.gear.tier >= 2) {
        var d = document.createElement('div'); d.className = 'tile-legend-item tl-dynamic';
        d.innerHTML = '<div class="tile-legend-dot tl-pchord">\u{1F3B5}</div>Chord=3x3';
        legend.appendChild(d);
    }
    if (b.gear.tier >= 4) {
        var d = document.createElement('div'); d.className = 'tile-legend-item tl-dynamic';
        d.innerHTML = '<div class="tile-legend-dot tl-csurf">\u{1F3C4}</div>Surf=shuffle+gems';
        legend.appendChild(d);
    }
    if (b.gear.tier >= 6) {
        var d = document.createElement('div'); d.className = 'tile-legend-item tl-dynamic';
        d.innerHTML = '<div class="tile-legend-dot tl-encore">\u{1F504}</div>Encore=+5 moves';
        legend.appendChild(d);
    }
}

// Hook legend update into level start
var _origStrt7 = strt;
strt = function(n) { _origStrt7(n); setTimeout(updateTileLegend, 2300) };

// Also update fPM to recognize new specials as valid moves
var _origFPM = fPM;
fPM = function() {
    // First check if any new special tiles can be swapped
    var newSp = ['pchord', 'csurf', 'encore'];
    for (var i = 0; i < 36; i++) {
        if (!G.bd[i] || G.bd[i].ty === 'obstacle') continue;
        if (newSp.indexOf(G.bd[i].sp) >= 0) {
            // Find an adjacent non-obstacle tile
            var neighbors = gN(i);
            for (var n = 0; n < neighbors.length; n++) {
                if (G.bd[neighbors[n]] && G.bd[neighbors[n]].ty !== 'obstacle') return [i, neighbors[n]];
            }
        }
    }
    return _origFPM();
};


// ===================== MOOD-DRIVEN MUSIC =====================
function getMusicMood(){try{if(!G.tg||G.tg===0)return 1;var s=G.sc/G.tg;var mood=1+s*4;if(G.co>=2)mood+=1;if(G.co>=4)mood+=1;if(G.mv<=5)mood+=.5;if(G.mv<=3)mood+=.5;if(s>=.85)mood+=1;mood+=Math.min(1,(G.cl||1)/30);return Math.min(7,Math.floor(mood))}catch(e){return 1}}

var _origUH_MOOD=uH;
uH=function(){try{_origUH_MOOD()}catch(e){}try{var mood=getMusicMood();if(mood>bgmIntensity)bgmIntensity=Math.min(7,bgmIntensity+.5);else if(mood<bgmIntensity)bgmIntensity=Math.max(mood,bgmIntensity-.15);var cf=document.getElementById('combo-fill');if(cf){cf.style.width=Math.min(100,bgmIntensity*14)+'%';cf.style.background=bgmIntensity>=5?'linear-gradient(90deg,#ff4500,#ffd700,#ff4500)':bgmIntensity>=3?'linear-gradient(90deg,#dc143c,#ff8c00)':'linear-gradient(90deg,#dc143c,#ffd700)'}}catch(e){}};

// ===================== DYNAMIC VISUALS =====================
function updateBgMood(){try{var mood=getMusicMood();var bg=document.getElementById('bg-stage');if(!bg)return;var colors=['linear-gradient(135deg,#1a0a0a,#2a1a3a,#1a0a2a)','linear-gradient(135deg,#1a0a0a,#2a1a3a,#2a0a2a)','linear-gradient(135deg,#2a0a0a,#3a1a3a,#2a0a3a)','linear-gradient(135deg,#2a0a0a,#3a1a2a,#3a0a3a)','linear-gradient(135deg,#3a0a0a,#4a1a2a,#3a0a4a)','linear-gradient(135deg,#3a0505,#4a1520,#4a0a4a)','linear-gradient(135deg,#4a0505,#5a1520,#4a0a5a)','linear-gradient(135deg,#5a0505,#6a1520,#5a0a6a)'];bg.style.background=colors[Math.min(mood,7)];bg.style.transition='background 2s ease'}catch(e){}}
function updateLightIntensity(){try{var mood=getMusicMood();var lights=document.querySelectorAll('.light-beam');if(lights)lights.forEach(function(l){l.style.opacity=Math.min(.7,.3+mood*.06);l.style.transform='scale('+(1+mood*.08)+')';l.style.transition='opacity 2s,transform 2s'})}catch(e){}}
setInterval(updateBgMood,2000);setInterval(updateLightIntensity,2000);

// ===================== SWIPE THRESHOLD FIX =====================
// (swipe already at 20px from v9, reduce to 15 for small phones)

// ===================== QA SAFETY =====================
var _origStrt_QA=strt;strt=function(n){stopBGM();bgmIntensity=0;_origStrt_QA(n)};
setInterval(function(){if(G.pr&&!document.querySelector('.t.mtch')&&!document.querySelector('.t.fall')){G.pr=false;if(hintsOn)sH()}},5000);
var _origWn_QA=wn;wn=function(){if(document.querySelector('.win-overlay'))return;_origWn_QA()};
var _origLs_QA=ls;ls=function(){if(document.querySelector('.win-overlay'))return;_origLs_QA()};
pickLevelTypes();

// ===================== MERGED SHOP RENDER OVERRIDE =====================
var _origRenderShop_FINAL=renderShop;
renderShop=function(catId){try{_origRenderShop_FINAL(catId)}catch(e){}try{var coins=getStarCoins();var grid=document.getElementById('shop-grid');if(!grid)return;var cat=SHOP_CATS.find(function(c){return c.id===catId});if(!cat)return;var els=grid.querySelectorAll('.shop-item');var defs=BONUS_DEFS?BONUS_DEFS[catId]:null;cat.items.forEach(function(item,idx){if(idx>=els.length)return;var el=els[idx];var owned=G.owned&&G.owned[item.id];var prev=item.tier===0||cat.items.some(function(it){return it.tier===item.tier-1&&G.owned[it.id]});if(!owned&&prev&&item.price>0){var pct=Math.min(100,(coins/item.price)*100);var bar=document.createElement('div');bar.className='shop-item-progress';bar.innerHTML='<div class="shop-item-fill" style="width:'+pct+'%"></div>';el.appendChild(bar);if(coins>=item.price)el.classList.add('affordable')}if(defs&&defs[item.tier]){var def=defs[item.tier];if(def.desc&&def.desc!=='No bonus'&&def.desc!=='No special tiles'&&def.desc!=='Basic gear'){var b=document.createElement('div');b.className='shop-bonus';b.textContent='\u26A1 '+def.desc;el.appendChild(b)}}})}catch(e){console.log('shopRender:',e)}};


// ===================== SMART SHOP NAVIGATION =====================
function returnFromShop() {
    // If we were mid-game, go back to the game board
    var gs = document.getElementById('gs');
    if (gs && G.bd && G.bd.length === 36 && G.mv > 0 && !document.querySelector('.win-overlay')) {
        showS('gs');
    } else {
        // Otherwise go to level select
        showLS();
    }
}


// ===================== FIRST-TIME INTERACTIVE TUTORIAL =====================
var TUT_STEPS=[
{title:"Welcome to X-Ray Star!",img:"\u{1F3B8}\u{1F525}\u{1F3B5}",text:"You're the band <b>X-Ray Star</b> \u2014 match instruments to climb from <em>basement nobodies</em> to <em>rock legends!</em>",btn:"LET'S GO!"},
{title:"Match 3 to Score",img:"\u{1F3B8}\u{1F3B8}\u{1F3B8}",text:"<b>Tap</b> one instrument, then <b>tap an adjacent one</b> to swap them.<br>On mobile you can also <b>swipe</b>!<br><br>Line up <b>3 or more</b> of the same instrument to score.",btn:"GOT IT"},
{title:"Special Tiles",img:"\u{1F50A} \u2B50 \u26A1",text:"Match <b>4 in a row</b> \u2192 creates an <em>AMP</em> (clears a cross!)<br>Match <b>5+</b> \u2192 creates a <em>ROCKSTAR</em> (clears all of one type!)<br><br><b>Swap</b> a special tile with any neighbor to activate it!",btn:"AWESOME"},
{title:"Obstacles",img:"\u{1F4E6} \u{1F50C}",text:"<b>Crates</b> (\u2764\uFE0F2 HP) and <b>Cables</b> (\u2764\uFE0F3 HP) block your board.<br><br>You can't move them \u2014 make matches <b>right next to them</b> to destroy them!",btn:"SMASH 'EM"},
{title:"Rock Star Life",img:"\u{1F3B8} \u{1F576}\uFE0F \u{1F3E0}",text:"Earn <b>stars</b> by completing levels. Spend them in the <em>Rock Star Life</em> shop!<br><br>Each purchase gives <b>gameplay bonuses</b> and moves you up the <em>Fame Ladder!</em>",btn:"ROCK ON"},
{title:"Pro Tips",img:"\u{1F4A1}",text:"\u2022 Match at the <b>bottom</b> for bigger cascades<br>\u2022 <b>Glowing tiles</b> show you good moves<br>\u2022 <b>Combos</b> multiply your score<br>\u2022 The <b>music builds</b> as you play!",btn:"I'M READY TO ROCK!"}
];
var tutStep=0;
function showTutorial(fromMenu){tutStep=0;renderTutStep(fromMenu)}
function renderTutStep(fromMenu){
    var old=document.querySelector('.tut-full');if(old)old.remove();
    if(tutStep>=TUT_STEPS.length){
        if(!fromMenu){localStorage.setItem('xrs_tut_done','1');strt(1)}
        return;
    }
    var s=TUT_STEPS[tutStep];
    var ov=document.createElement('div');ov.className='tut-full';
    var dots='';for(var i=0;i<TUT_STEPS.length;i++)dots+='<div class="tut-dot'+(i===tutStep?' active':'')+'"></div>';
    ov.innerHTML='<div class="tut-card">'
        +'<button class="tut-skip" onclick="skipTutorial('+(fromMenu?'true':'false')+')">Skip \u00BB</button>'
        +'<div class="tut-step">Step '+(tutStep+1)+' of '+TUT_STEPS.length+'</div>'
        +'<div class="tut-title">'+s.title+'</div>'
        +'<div class="tut-img">'+s.img+'</div>'
        +'<div class="tut-text">'+s.text+'</div>'
        +'<button class="tut-btn" onclick="nextTutStep('+(fromMenu?'true':'false')+')">'+s.btn+'</button>'
        +'<div class="tut-dots">'+dots+'</div></div>';
    document.body.appendChild(ov);
}
function nextTutStep(fromMenu){tutStep++;renderTutStep(fromMenu)}
function skipTutorial(fromMenu){
    var old=document.querySelector('.tut-full');if(old)old.remove();
    if(!fromMenu){localStorage.setItem('xrs_tut_done','1');strt(1)}
}
function startGame(){
    iA();
    if(!localStorage.getItem('xrs_tut_done')){showTutorial(false)}
    else{showLS()}
}

</script>
</body></html>
